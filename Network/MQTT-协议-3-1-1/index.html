<!DOCTYPE html>
<html lang="zh-CN">





<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/./apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/brain.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="description" content>
  <meta name="author" content="Li Junhao">
  <meta name="keywords" content="Windows,Kernel,Qt,Security">
  <title>MQTT 协议 3.1.1 / God mercy me</title>
  <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="/lib/mdbootstrap/css/mdb.min.css">
  <link rel="stylesheet" href="/lib/github-markdown/github-markdown.min.css">
  <link rel="stylesheet" href="https://at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">
  
    <link rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css">
  
  <link rel="stylesheet" href="/css/main.css">

  
</head>


<body>
  <header style="height: 100vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>God mercy me</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
        
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">Archives</a>
          </li>
        
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">Categories</a>
          </li>
        
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">Tags</a>
          </li>
        
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">About</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>


</nav>

    <div class="view intro-2"
         style="background: url('/img/homepage.jpg')no-repeat center center;
           background-size: cover;
           background-attachment: fixed;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              <br>
              <p>星期二, 十一月 5日 2019, 6:04 晚上</p>
            
          </div>

          
            <div class="scroll-down-bar">
              <i class="fa fa-angle-down scroll-down-arrow"></i>
            </div>
          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="py-5 z-depth-3" id="board">
        <div class="post-content mx-auto">
          <div class="markdown-body">
            <h1 id="MQTT协议3-1-1中文版"><a href="#MQTT协议3-1-1中文版" class="headerlink" title="MQTT协议3.1.1中文版"></a>MQTT协议3.1.1中文版</h1><hr>
<ul>
<li><a href="https://www.oasis-open.org/committees/mqtt/" target="_blank" rel="noopener">OASIS标准</a> 2014年10月29日</li>
</ul>
<h2 id="规范链接-Specification-URIs"><a href="#规范链接-Specification-URIs" class="headerlink" title="规范链接 (Specification URIs)"></a>规范链接 (Specification URIs)</h2><h3 id="当前版本-This-version-："><a href="#当前版本-This-version-：" class="headerlink" title="当前版本(This version)："></a>当前版本(This version)：</h3><p><a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.doc" target="_blank" rel="noopener">http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.doc</a> (Authoritative)</p>
<p><a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html" target="_blank" rel="noopener">http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html</a></p>
<p><a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.pdf" target="_blank" rel="noopener">http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.pdf</a></p>
<h3 id="以前的版本-Previous-version-："><a href="#以前的版本-Previous-version-：" class="headerlink" title="以前的版本(Previous version)："></a>以前的版本(Previous version)：</h3><p><a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/cos01/mqtt-v3.1.1-cos01.doc" target="_blank" rel="noopener">http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/cos01/mqtt-v3.1.1-cos01.doc</a> (Authoritative)</p>
<p><a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/cos01/mqtt-v3.1.1-cos01.html" target="_blank" rel="noopener">http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/cos01/mqtt-v3.1.1-cos01.html</a></p>
<p><a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/cos01/mqtt-v3.1.1-cos01.pdf" target="_blank" rel="noopener">http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/cos01/mqtt-v3.1.1-cos01.pdf</a></p>
<h3 id="最新版本-Latest-version-："><a href="#最新版本-Latest-version-：" class="headerlink" title="最新版本(Latest version)："></a>最新版本(Latest version)：</h3><p><a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.doc" target="_blank" rel="noopener">http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.doc</a> (Authoritative)</p>
<p><a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.html" target="_blank" rel="noopener">http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.html</a></p>
<p><a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.pdf" target="_blank" rel="noopener">http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.pdf</a></p>
<h3 id="技术委员会-Technical-Committee-："><a href="#技术委员会-Technical-Committee-：" class="headerlink" title="技术委员会(Technical Committee)："></a>技术委员会(Technical Committee)：</h3><p><a href="https://www.oasis-open.org/committees/mqtt/" target="_blank" rel="noopener">结构化信息标准促进组织MQTT技术委员会</a></p>
<h4 id="主席-Chairs-："><a href="#主席-Chairs-：" class="headerlink" title="主席(Chairs)："></a>主席(Chairs)：</h4><p>拉斐尔·J·科恩 (), 个人</p>
<p>理查德·J·科彭 (), <a href="http://www.ibm.com/" target="_blank" rel="noopener">IBM</a></p>
<h4 id="编辑-Editors-："><a href="#编辑-Editors-：" class="headerlink" title="编辑(Editors)："></a>编辑(Editors)：</h4><p>安德鲁·班克斯 (), <a href="http://www.ibm.com/" target="_blank" rel="noopener">IBM</a></p>
<p>拉胡尔·吉普塔 (), <a href="http://www.ibm.com/" target="_blank" rel="noopener">IBM</a></p>
<h3 id="相关文档-Related-work-："><a href="#相关文档-Related-work-：" class="headerlink" title="相关文档(Related work)："></a>相关文档(Related work)：</h3><h4 id="本规范与此有关："><a href="#本规范与此有关：" class="headerlink" title="本规范与此有关："></a>本规范与此有关：</h4><ul>
<li>MQTT和NIST网络安全框架1.0版. 编辑是杰夫·布朗和路易·菲利普·拉穆勒. 最新版本： <a href="http://docs.oasis-open.org/mqtt/mqtt-nist-cybersecurity/v1.0/mqtt-nist-cybersecurity-v1.0.html" target="_blank" rel="noopener">http://docs.oasis-open.org/mqtt/mqtt-nist-cybersecurity/v1.0/mqtt-nist-cybersecurity-v1.0.html</a>.</li>
</ul>
<h3 id="摘要-Abstract"><a href="#摘要-Abstract" class="headerlink" title="摘要 (Abstract)"></a>摘要 (Abstract)</h3><p>MQTT是一个客户端服务端架构的发布/订阅模式的消息传输协议. 它的设计思想是轻巧、开放、简单、规范, 因此易于实现. 这些特点使得它对很多场景来说都是很好的选择, 包括受限的环境如机器与机器的通信(M2M)以及物联网环境(IoT), 这些场景要求很小的代码封装或者网络带宽非常昂贵.</p>
<p>本协议运行在TCP/IP, 或其它提供了有序、可靠、双向连接的网络连接上. 它有以下特点：</p>
<ul>
<li>使用发布/订阅消息模式, 提供了一对多的消息分发和应用之间的解耦.</li>
<li>消息传输不需要知道负载内容.</li>
<li>提供三种等级的服务质量：.<ul>
<li>“<code>最多一次</code>”, 尽操作环境所能提供的最大努力分发消息. 消息可能会丢失. 例如, 这个等级可用于环境传感器数据, 单次的数据丢失没关系, 因为不久之后会再次发送.</li>
<li>“<code>至少一次</code>”, 保证消息可以到达, 但是可能会重复.</li>
<li>“<code>仅一次</code>”, 保证消息只到达一次. 例如, 这个等级可用在一个计费系统中, 这里如果消息重复或丢失会导致不正确的收费.</li>
</ul>
</li>
<li>很小的传输消耗和协议数据交换, 最大限度减少网络流量</li>
<li>异常连接断开发生时, 能通知到相关各方.</li>
</ul>
<h3 id="状态-Status"><a href="#状态-Status" class="headerlink" title="状态 (Status)"></a>状态 (Status)</h3><p>本文档最后由OASIS成员在上面标示的日期最终修订或批准. 批准的级别也在上面列出了. 如果要查看本文档最新的修订版请检查上面的 <em>最新版本</em> 位置. 技术委员会产生的其它修订版和其它技术文档都列在这里：<a href="https://www.oasis-open.org/committees/tc_home.php?wg_abbrev=mqtt#technical" target="_blank" rel="noopener">https://www.oasis-open.org/committees/tc_home.php?wg_abbrev=mqtt#technical</a> .</p>
<p>技术委员会成员对本规范的评论应该发送到技术委员会的邮件列表. 其他人应该发送评论到技术委员会的公共评论列表, 方法是点击技术委员会网站的 <a href="https://www.oasis-open.org/committees/comments/index.php?wg_abbrev=mqtt" target="_blank" rel="noopener">发送评论</a> 按钮, 网页地址是 <a href="https://www.oasis-open.org/committees/mqtt/" target="_blank" rel="noopener">https://www.oasis-open.org/committees/mqtt/</a> .</p>
<p>关于实现本规范必不可少的任何专利是否已公开, 以及其它的专利许可条款相关的信息, 请参考技术委员会网站的知识产权部分((<a href="https://www.oasis-open.org/committees/mqtt/ipr.php" target="_blank" rel="noopener">https://www.oasis-open.org/committees/mqtt/ipr.php</a>).</p>
<h3 id="引用格式-Citation-format-："><a href="#引用格式-Citation-format-：" class="headerlink" title="引用格式(Citation format)："></a>引用格式(Citation format)：</h3><p>引用此规范时应该使用下面的引文格式：</p>
<p><strong>[mqtt-v3.1.1]</strong></p>
<p><em>MQTT Version 3.1.1</em>. Edited by Andrew Banks and Rahul Gupta<em>.</em> 29 October 2014. OASIS Standard. <a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html" target="_blank" rel="noopener">http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html</a>. Latest version: <a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.html" target="_blank" rel="noopener">http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.html</a>.</p>
<h3 id="文档链接"><a href="#文档链接" class="headerlink" title="文档链接"></a>文档链接</h3><ul>
<li><a href="https://github.com/mcxiaoke/mqtt" target="_blank" rel="noopener">MQTT协议3.1.1中文翻译项目</a></li>
<li><a href="https://github.com/mcxiaoke/mqtt/blob/master/protocol/MQTT-3.1.1-CN.pdf" target="_blank" rel="noopener">MQTT协议3.1.1中文版PDF</a></li>
</ul>
<h2 id="修订记录"><a href="#修订记录" class="headerlink" title="修订记录"></a>修订记录</h2><table>
<thead>
<tr>
<th align="left"><strong>版 本</strong></th>
<th align="left"><strong>日 期</strong></th>
<th align="left"><strong>发布说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">1.0.0</td>
<td align="left">2015-07-30</td>
<td align="left">翻译全部文本, 完成初步审校, 公开发布第一版</td>
</tr>
<tr>
<td align="left">1.0.1</td>
<td align="left">2015-10-22</td>
<td align="left">修订几处笔误, 增补几处未翻译的文本</td>
</tr>
<tr>
<td align="left">1.0.2</td>
<td align="left">2016-02-04</td>
<td align="left">转换为Markdown格式, 发布更有好的在线阅读版本</td>
</tr>
<tr>
<td align="left">1.0.3</td>
<td align="left">2016-02-06</td>
<td align="left">补充中英文对照, 修正部分链接和格式</td>
</tr>
</tbody></table>
<h2 id="译者"><a href="#译者" class="headerlink" title="译者"></a>译者</h2><ul>
<li><a href="https://github.com/mcxiaoke" target="_blank" rel="noopener">GitHub</a></li>
<li><a href="http://blog.mcxiaoke.com/" target="_blank" rel="noopener">Blog</a></li>
<li>Email</li>
</ul>
<h2 id="第一章-概述-Introduction"><a href="#第一章-概述-Introduction" class="headerlink" title="第一章 概述 Introduction"></a>第一章 概述 Introduction</h2><h3 id="1-1-MQTT协议的组织结构-Organization-of-MQTT"><a href="#1-1-MQTT协议的组织结构-Organization-of-MQTT" class="headerlink" title="1.1 MQTT协议的组织结构 Organization of MQTT"></a>1.1 MQTT协议的组织结构 Organization of MQTT</h3><p>本规范分为七个章节：</p>
<ul>
<li><a href="https://www.zybuluo.com/khan-lau/note/1326839#第一章-概述-introduction" target="_blank" rel="noopener">第一章 – 介绍</a></li>
<li>第二章 – MQTT控制报文格式</li>
<li>第三章 – MQTT控制报文</li>
<li>第四章 – 操作行为</li>
<li>第五章 – 安全</li>
<li>第六章 – 使用WebSocket</li>
<li>第七章 – 一致性目标</li>
<li>附录B – 强制性规范声明</li>
</ul>
<h3 id="1-2-术语-Terminology"><a href="#1-2-术语-Terminology" class="headerlink" title="1.2 术语 Terminology"></a>1.2 术语 Terminology</h3><p>本规范中用到的关键字 <strong>必须</strong> MUST, <strong>不能</strong> MUST NOT, <strong>要求</strong> REQUIRED, <strong>将会</strong> SHALL, <strong>不会</strong> SHALL NOT, <strong>应该</strong> SHOULD, <strong>不应该</strong> SHOULD NOT, <strong>推荐</strong> RECOMMENDED, <strong>可以</strong> MAY, <strong>可选</strong> OPTIONAL 都是按照 IETF RFC 2119 <a href="https://www.zybuluo.com/khan-lau/note/1326839#anchor-RFC2119" target="_blank" rel="noopener">RFC2119</a> 中的描述解释.</p>
<p><strong>网络连接 Network Connection</strong></p>
<p>MQTT使用的底层传输协议基础设施.</p>
<ul>
<li>客户端使用它连接服务端.</li>
<li>它提供有序的、可靠的、双向字节流传输.</li>
</ul>
<p>例子见<a href="https://www.zybuluo.com/khan-lau/note/1326839#42-网络连接-network-connections" target="_blank" rel="noopener">4.2节</a>.</p>
<p><strong>应用消息 Application Message</strong><br>MQTT协议通过网络传输应用数据. 应用消息通过MQTT传输时, 它们有关联的服务质量(QoS)和主题(Topic).</p>
<p><strong>客户端 Client</strong><br>使用MQTT的程序或设备. 客户端总是通过网络连接到服务端. 它可以</p>
<ul>
<li>发布应用消息给其它相关的客户端.</li>
<li>订阅以请求接受相关的应用消息.</li>
<li>取消订阅以移除接受应用消息的请求.</li>
<li>从服务端断开连接.</li>
</ul>
<p><strong>服务端 Server</strong><br>一个程序或设备, 作为发送消息的客户端和请求订阅的客户端之间的中介. 服务端</p>
<ul>
<li>接受来自客户端的网络连接.</li>
<li>接受客户端发布的应用消息.</li>
<li>处理客户端的订阅和取消订阅请求.</li>
<li>转发应用消息给符合条件的已订阅客户端.</li>
</ul>
<p><strong>订阅 Subscription</strong><br>订阅包含一个<code>主题过滤器(Topic Filter)</code>和一个<code>最大的服务质量(QoS)等级</code>. 订阅与单个会话(Session)关联. 会话可以包含多于一个的订阅. 会话的每个订阅都有一个不同的主题过滤器.</p>
<p><strong>主题名 Topic Name</strong><br>附加在应用消息上的一个标签, 服务端已知且与订阅匹配. 服务端发送应用消息的一个副本给每一个匹配的客户端订阅.</p>
<p><strong>主题过滤器 Topic Filter</strong><br>订阅中包含的一个表达式, 用于表示相关的一个或多个主题. 主题过滤器可以使用通配符.</p>
<p><strong>会话 Session</strong><br>客户端和服务端之间的状态交互. 一些会话持续时长与网络连接一样, 另一些可以在客户端和服务端的多个连续网络连接间扩展.</p>
<p><strong>控制报文 MQTT Control Packet</strong><br>通过网络连接发送的信息数据包. MQTT规范定义了十四种不同类型的控制报文, 其中一个(PUBLISH报文)用于传输应用消息.</p>
<h3 id="1-3-规范引用-Normative-references"><a href="#1-3-规范引用-Normative-references" class="headerlink" title="1.3 规范引用 Normative references"></a>1.3 规范引用 Normative references</h3><p>[RFC2119]<br>Bradner, S., “Key words for use in RFCs to Indicate Requirement Levels”, BCP 14, RFC 2119, DOI 10.17487/RFC2119, March 1997,<br><a href="http://www.rfc-editor.org/info/rfc2119" target="_blank" rel="noopener">http://www.rfc-editor.org/info/rfc2119</a></p>
<p>[RFC3629]<br>Yergeau, F., “UTF-8, a transformation format of ISO 10646”, STD 63, RFC 3629, DOI 10.17487/RFC3629, November 2003,<br><a href="http://www.rfc-editor.org/info/rfc3629" target="_blank" rel="noopener">http://www.rfc-editor.org/info/rfc3629</a></p>
<p>[RFC6455]<br>Fette, I. and A. Melnikov, “The WebSocket Protocol”, RFC 6455, DOI 10.17487/RFC6455, December 2011,<br><a href="http://www.rfc-editor.org/info/rfc6455" target="_blank" rel="noopener">http://www.rfc-editor.org/info/rfc6455</a></p>
<p>[Unicode]<br>The Unicode Consortium. The Unicode Standard,<br><a href="http://www.rfc-editor.org/info/rfc2119" target="_blank" rel="noopener">http://www.rfc-editor.org/info/rfc2119</a></p>
<h3 id="1-4-非规范引用-Non-normative-references"><a href="#1-4-非规范引用-Non-normative-references" class="headerlink" title="1.4 非规范引用 Non-normative references"></a>1.4 非规范引用 Non-normative references</h3><p>[RFC0793]<br>Postel, J., “Transmission Control Protocol”, STD 7, RFC 793, DOI 10.17487/RFC0793, September 1981,<br><a href="http://www.rfc-editor.org/info/rfc793" target="_blank" rel="noopener">http://www.rfc-editor.org/info/rfc793</a></p>
<p>[RFC5246]<br>Dierks, T. and E. Rescorla, “The Transport Layer Security (TLS) Protocol Version 1.2”, RFC 5246, DOI 10.17487/RFC5246, August 2008,<br><a href="http://www.rfc-editor.org/info/rfc2119" target="_blank" rel="noopener">http://www.rfc-editor.org/info/rfc2119</a></p>
<p>[AES]<br>Advanced Encryption Standard (AES) (FIPS PUB 197).<br><a href="https://csrc.nist.gov/csrc/media/publications/fips/197/final/documents/fips-197.pdf" target="_blank" rel="noopener">https://csrc.nist.gov/csrc/media/publications/fips/197/final/documents/fips-197.pdf</a></p>
<p>[CHACHA20]<br>ChaCha20 and Poly1305 for IETF Protocols<br><a href="https://tools.ietf.org/html/rfc7539" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc7539</a></p>
<p>[FIPS1402]<br>Security Requirements for Cryptographic Modules (FIPS PUB 140-2)<br><a href="https://csrc.nist.gov/csrc/media/publications/fips/140/2/final/documents/fips1402.pdf" target="_blank" rel="noopener">https://csrc.nist.gov/csrc/media/publications/fips/140/2/final/documents/fips1402.pdf</a></p>
<p>[IEEE 802.1AR]<br>IEEE Standard for Local and metropolitan area networks - Secure Device Identity<br><a href="http://standards.ieee.org/findstds/standard/802.1AR-2009.html" target="_blank" rel="noopener">http://standards.ieee.org/findstds/standard/802.1AR-2009.html</a></p>
<p>[ISO29192]<br>ISO/IEC 29192-1:2012 Information technology – Security techniques – Lightweight cryptography – Part 1: General<br><a href="https://www.iso.org/standard/56425.html" target="_blank" rel="noopener">https://www.iso.org/standard/56425.html</a></p>
<p>[MQTT NIST]<br>MQTT supplemental publication, MQTT and the NIST Framework for Improving Critical Infrastructure Cybersecurity<br><a href="http://docs.oasis-open.org/mqtt/mqtt-nist-cybersecurity/v1.0/mqtt-nist-cybersecurity-v1.0.html" target="_blank" rel="noopener">http://docs.oasis-open.org/mqtt/mqtt-nist-cybersecurity/v1.0/mqtt-nist-cybersecurity-v1.0.html</a></p>
<p>[MQTTV311]<br>MQTT V3.1.1 Protocol Specification<br><a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html" target="_blank" rel="noopener">http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html</a></p>
<p>[ISO20922]<br>MQTT V3.1.1 ISO Standard (ISO/IEC 20922:2016)<br><a href="https://www.iso.org/standard/69466.html" target="_blank" rel="noopener">https://www.iso.org/standard/69466.html</a></p>
<p>[NISTCSF]<br>Improving Critical Infrastructure Cybersecurity Executive Order 13636<br><a href="https://www.nist.gov/sites/default/files/documents/itl/preliminary-cybersecurity-framework.pdf" target="_blank" rel="noopener">https://www.nist.gov/sites/default/files/documents/itl/preliminary-cybersecurity-framework.pdf</a></p>
<p>[NIST7628]<br>NISTIR 7628 Guidelines for Smart Grid Cyber Security Catalogue<br><a href="https://www.nist.gov/sites/default/files/documents/smartgrid/nistir-7628_total.pdf" target="_blank" rel="noopener">https://www.nist.gov/sites/default/files/documents/smartgrid/nistir-7628_total.pdf</a></p>
<p>[NSAB]<br>NSA Suite B Cryptography<br><a href="http://www.nsa.gov/ia/programs/suiteb_cryptography/" target="_blank" rel="noopener">http://www.nsa.gov/ia/programs/suiteb_cryptography/</a></p>
<p>[PCIDSS]<br>PCI-DSS Payment Card Industry Data Security Standard<br><a href="https://www.pcisecuritystandards.org/pci_security/" target="_blank" rel="noopener">https://www.pcisecuritystandards.org/pci_security/</a></p>
<p>[RFC1928]<br>Leech, M., Ganis, M., Lee, Y., Kuris, R., Koblas, D., and L. Jones, “SOCKS Protocol Version 5”, RFC 1928, DOI 10.17487/RFC1928, March 1996,<br><a href="http://www.rfc-editor.org/info/rfc1928" target="_blank" rel="noopener">http://www.rfc-editor.org/info/rfc1928</a></p>
<p>[RFC4511]<br>Sermersheim, J., Ed., “Lightweight Directory Access Protocol (LDAP): The Protocol”, RFC 4511, DOI 10.17487/RFC4511, June 2006,<br><a href="http://www.rfc-editor.org/info/rfc4511" target="_blank" rel="noopener">http://www.rfc-editor.org/info/rfc4511</a></p>
<p>[RFC5280]<br>Cooper, D., Santesson, S., Farrell, S., Boeyen, S., Housley, R., and W. Polk, “Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL) Profile”, RFC 5280, DOI 10.17487/RFC5280, May 2008,<br><a href="http://www.rfc-editor.org/info/rfc5280" target="_blank" rel="noopener">http://www.rfc-editor.org/info/rfc5280</a></p>
<p>[RFC6066]<br>Eastlake 3rd, D., “Transport Layer Security (TLS) Extensions: Extension Definitions”, RFC 6066, DOI 10.17487/RFC6066, January 2011,<br><a href="http://www.rfc-editor.org/info/rfc6066" target="_blank" rel="noopener">http://www.rfc-editor.org/info/rfc6066</a></p>
<p>[RFC6749]<br>Hardt, D., Ed., “The OAuth 2.0 Authorization Framework”, RFC 6749, DOI 10.17487/RFC6749, October 2012,<br><a href="http://www.rfc-editor.org/info/rfc6749" target="_blank" rel="noopener">http://www.rfc-editor.org/info/rfc6749</a></p>
<p>[RFC6960]<br>Santesson, S., Myers, M., Ankney, R., Malpani, A., Galperin, S., and C. Adams, “X.509 Internet Public Key Infrastructure Online Certificate Status Protocol - OCSP”, RFC 6960, DOI 10.17487/RFC6960, June 2013,<br><a href="http://www.rfc-editor.org/info/rfc6960" target="_blank" rel="noopener">http://www.rfc-editor.org/info/rfc6960</a></p>
<p>[SARBANES]<br>Sarbanes-Oxley Act of 2002.<br><a href="http://www.gpo.gov/fdsys/pkg/PLAW-107publ204/html/PLAW-107publ204.htm" target="_blank" rel="noopener">http://www.gpo.gov/fdsys/pkg/PLAW-107publ204/html/PLAW-107publ204.htm</a></p>
<p>[USEUPRIVSH]<br>U.S.-EU Privacy Shield Framework<br><a href="https://www.privacyshield.gov/" target="_blank" rel="noopener">https://www.privacyshield.gov</a></p>
<p>[RFC3986]<br>Berners-Lee, T., Fielding, R., and L. Masinter, “Uniform Resource Identifier (URI): Generic Syntax”, STD 66, RFC 3986, DOI 10.17487/RFC3986, January 2005,<br><a href="http://www.rfc-editor.org/info/rfc3986" target="_blank" rel="noopener">http://www.rfc-editor.org/info/rfc3986</a></p>
<p>[RFC1035]<br>Mockapetris, P., “Domain names - implementation and specification”, STD 13, RFC 1035, DOI 10.17487/RFC1035, November 1987,<br><a href="http://www.rfc-editor.org/info/rfc1035" target="_blank" rel="noopener">http://www.rfc-editor.org/info/rfc1035</a></p>
<p>[RFC2782]<br>Gulbrandsen, A., Vixie, P., and L. Esibov, “A DNS RR for specifying the location of services (DNS SRV)”, RFC 2782, DOI 10.17487/RFC2782, February 2000,<br><a href="http://www.rfc-editor.org/info/rfc2782" target="_blank" rel="noopener">http://www.rfc-editor.org/info/rfc2782</a></p>
<h3 id="1-5-数据表示-Data-representations"><a href="#1-5-数据表示-Data-representations" class="headerlink" title="1.5 数据表示 Data representations"></a>1.5 数据表示 Data representations</h3><h4 id="1-5-1-二进制位-Bits"><a href="#1-5-1-二进制位-Bits" class="headerlink" title="1.5.1 二进制位 Bits"></a>1.5.1 二进制位 Bits</h4><p>字节中的位从0到7. 第7位是最高有效位, 第0位是最低有效位.</p>
<h4 id="1-5-2-整数数值-Integer-data-values"><a href="#1-5-2-整数数值-Integer-data-values" class="headerlink" title="1.5.2 整数数值 Integer data values"></a>1.5.2 整数数值 Integer data values</h4><p>整数数值是16位, 使用大端序(big-endian, 高位字节在低位字节前面). 这意味着一个16位的字在网络上表示为最高有效字节(MSB), 后面跟着最低有效字节(LSB).</p>
<h4 id="1-5-3-UTF-8编码字符串-UTF-8-encoded-strings"><a href="#1-5-3-UTF-8编码字符串-UTF-8-encoded-strings" class="headerlink" title="1.5.3 UTF-8编码字符串 UTF-8 encoded strings"></a>1.5.3 UTF-8编码字符串 UTF-8 encoded strings</h4><p>后面会描述的控制报文中的文本字段编码为UTF-8格式的字符串. UTF-8 <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC3629" target="_blank" rel="noopener">RFC3629</a> 是一个高效的Unicode字符编码格式, 为了支持基于文本的通信, 它对ASCII字符的编码做了优化.</p>
<p>每一个字符串都有一个两字节的长度字段作为前缀, 它给出这个字符串UTF-8编码的字节数, 它们在<a href="https://www.zybuluo.com/khan-lau/note/1326839#图例-11-utf-8编码字符串的结构-structure-of-utf-8-encoded-strings" target="_blank" rel="noopener">图例 1.1 UTF-8编码字符串的结构</a> 中描述. 因此可以传送的UTF-8编码的字符串大小有一个限制, 不能超过 65535字节.</p>
<p>除非另有说明, 所有的UTF-8编码字符串的长度都<strong>必须</strong>在0到65535字节这个范围内.</p>
<h5 id="图例-1-1-UTF-8编码字符串的结构-Structure-of-UTF-8-encoded-strings"><a href="#图例-1-1-UTF-8编码字符串的结构-Structure-of-UTF-8-encoded-strings" class="headerlink" title="图例 1.1 UTF-8编码字符串的结构 Structure of UTF-8 encoded strings"></a>图例 1.1 UTF-8编码字符串的结构 Structure of UTF-8 encoded strings</h5><table>
<thead>
<tr>
<th align="left"><strong>二进制位</strong></th>
<th align="left">7-0</th>
</tr>
</thead>
<tbody><tr>
<td align="left">byte 1</td>
<td align="left">字符串长度的最高有效字节(MSB)</td>
</tr>
<tr>
<td align="left">byte 2</td>
<td align="left">字符串长度的最低有效字节(LSB)</td>
</tr>
<tr>
<td align="left">byte 3 ….</td>
<td align="left">如果长度大于0, 这里是UTF-8编码的字符数据.</td>
</tr>
</tbody></table>
<p>UTF-8编码字符串中的字符数据<strong>必须</strong>是按照Unicode规范 <a href="https://www.zybuluo.com/khan-lau/note/1326839#Unicode" target="_blank" rel="noopener">Unicode</a>] 定义的和在RFC3629 <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC3629" target="_blank" rel="noopener">RFC3629</a>] 中重申的有效的UTF-8格式. 特别需要指出的是, 这些数据<strong>不能</strong>包含字符码在U+D800和U+DFFF之间的数据. 如果服务端或客户端收到了一个包含无效UTF-8字符的控制报文, 它<strong>必须</strong>关闭网络连接 [MQTT-1.5.3-1].</p>
<p>UTF-8编码的字符串<strong>不能</strong>包含空字符U+0000. 如果客户端或服务端收到了一个包含U+0000的控制报文, 它<strong>必须</strong>关闭网络连接 [MQTT-1.5.3-2].</p>
<p>数据中<strong>不应该</strong>包含下面这些Unicode代码点的编码. 如果一个接收者(服务端或客户端)收到了包含下列任意字符的控制报文, 它<strong>可以</strong>关闭网络连接：</p>
<ul>
<li>U+0001和U+001F之间的控制字符</li>
<li>U+007F和U+009F之间的控制字符</li>
<li>Unicode规范定义的非字符代码点(例如U+0FFFF)</li>
<li>Unicode规范定义的保留字符(例如U+0FFFF)</li>
</ul>
<p>UTF-8编码序列0XEF 0xBB 0xBF总是被解释为U+FEFF(零宽度非换行空白字符), 无论它出现在字符串的什么位置, 报文接收者都不能跳过或者剥离它 [MQTT-1.5.3-3].</p>
<h4 id="非规范示例-Non-normative-example"><a href="#非规范示例-Non-normative-example" class="headerlink" title="非规范示例 Non normative example"></a>非规范示例 Non normative example</h4><blockquote>
<p>例如, 字符串 A𪛔 是一个拉丁字母A后面跟着一个代码点U+2A6D4(它表示一个中日韩统一表意文字扩展B中的字符), 这个字符串编码如下：</p>
</blockquote>
<h5 id="图例-1-2-UTF-8编码字符串非规范示例-UTF-8-encoded-string-non-normative-example"><a href="#图例-1-2-UTF-8编码字符串非规范示例-UTF-8-encoded-string-non-normative-example" class="headerlink" title="图例 1.2 UTF-8编码字符串非规范示例 UTF-8 encoded string non normative example"></a>图例 1.2 UTF-8编码字符串非规范示例 UTF-8 encoded string non normative example</h5><table>
<thead>
<tr>
<th align="left"><strong>Bit</strong></th>
<th align="left"><strong>7</strong></th>
<th align="left"><strong>6</strong></th>
<th align="left"><strong>5</strong></th>
<th align="left"><strong>4</strong></th>
<th align="left"><strong>3</strong></th>
<th align="left"><strong>2</strong></th>
<th align="left"><strong>1</strong></th>
<th align="left"><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">byte 1</td>
<td align="left">字符串长度 MSB (0x00)</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 2</td>
<td align="left">字符串长度 LSB (0x05)</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">byte 3</td>
<td align="left">‘A’ (0x41)</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">byte 4</td>
<td align="left">(0xF0)</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 5</td>
<td align="left">(0xAA)</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 6</td>
<td align="left">(0x9B)</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">byte 7</td>
<td align="left">(0x94)</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
</tbody></table>
<h3 id="1-6-编辑约定-Editing-conventions"><a href="#1-6-编辑约定-Editing-conventions" class="headerlink" title="1.6 编辑约定 Editing conventions"></a>1.6 编辑约定 Editing conventions</h3><p>本规范用黄色高亮的文本标识一致性声明, 每个一致性声明都分配了一个这种格式的引用：[MQTT-x.x.x-y].</p>
<h2 id="第二章-MQTT控制报文格式-MQTT-Control-Packet-format"><a href="#第二章-MQTT控制报文格式-MQTT-Control-Packet-format" class="headerlink" title="第二章 MQTT控制报文格式 MQTT Control Packet format"></a>第二章 MQTT控制报文格式 MQTT Control Packet format</h2><h3 id="2-1-MQTT控制报文的结构-Structure-of-an-MQTT-Control-Packet"><a href="#2-1-MQTT控制报文的结构-Structure-of-an-MQTT-Control-Packet" class="headerlink" title="2.1 MQTT控制报文的结构 Structure of an MQTT Control Packet"></a>2.1 MQTT控制报文的结构 Structure of an MQTT Control Packet</h3><p>MQTT协议通过交换预定义的MQTT控制报文来通信. 这一节描述这些报文的格式.</p>
<p>MQTT控制报文由三部分组成, 按照 <a href="https://www.zybuluo.com/khan-lau/note/1326839#图例-21-mqtt控制报文的结构" target="_blank" rel="noopener">图例 2.1 –MQTT控制报文的结构</a> 描述的顺序：</p>
<h5 id="图例-2-1-–MQTT控制报文的结构"><a href="#图例-2-1-–MQTT控制报文的结构" class="headerlink" title="图例 2.1 –MQTT控制报文的结构"></a>图例 2.1 –MQTT控制报文的结构</h5><table>
<thead>
<tr>
<th align="left">Fixed header</th>
<th align="left">固定报头, 所有控制报文都包含</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Variable header</td>
<td align="left">可变报头, 部分控制报文包含</td>
</tr>
<tr>
<td align="left">Payload</td>
<td align="left">有效载荷, 部分控制报文包含</td>
</tr>
</tbody></table>
<h3 id="2-2-固定报头-Fixed-header"><a href="#2-2-固定报头-Fixed-header" class="headerlink" title="2.2 固定报头 Fixed header"></a>2.2 固定报头 Fixed header</h3><p>每个MQTT控制报文都包含一个固定报头. <a href="https://www.zybuluo.com/khan-lau/note/1326839#图例-22--固定报头的格式" target="_blank" rel="noopener">图例 2.2 -固定报头的格式</a> 描述了固定报头的格式.</p>
<h5 id="图例-2-2-固定报头的格式"><a href="#图例-2-2-固定报头的格式" class="headerlink" title="图例 2.2 -固定报头的格式"></a>图例 2.2 -固定报头的格式</h5><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>MQTT控制报文的类型</td>
<td>用于指定控制报文类型的标志位</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte 2…</td>
<td>剩余长度</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="2-2-1-MQTT控制报文的类型-MQTT-Control-Packet-type"><a href="#2-2-1-MQTT控制报文的类型-MQTT-Control-Packet-type" class="headerlink" title="2.2.1 MQTT控制报文的类型 MQTT Control Packet type"></a>2.2.1 MQTT控制报文的类型 MQTT Control Packet type</h4><p><strong>位置：</strong>第1个字节, 二进制位7-4.</p>
<p>表示为4位无符号值, 这些值的定义见 <a href="https://www.zybuluo.com/khan-lau/note/1326839#表格-21--控制报文的类型" target="_blank" rel="noopener">表格 2.1 -控制报文的类型</a></p>
<h5 id="表格-2-1-控制报文的类型"><a href="#表格-2-1-控制报文的类型" class="headerlink" title="表格 2.1 -控制报文的类型"></a>表格 2.1 -控制报文的类型</h5><table>
<thead>
<tr>
<th align="left"><strong>名字</strong></th>
<th align="left"><strong>值</strong></th>
<th align="left"><strong>报文流动方向</strong></th>
<th align="left"><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">Reserved</td>
<td align="left">0</td>
<td align="left">禁止</td>
<td align="left">保留</td>
</tr>
<tr>
<td align="left">CONNECT</td>
<td align="left">1</td>
<td align="left">客户端到服务端</td>
<td align="left">客户端请求连接服务端</td>
</tr>
<tr>
<td align="left">CONNACK</td>
<td align="left">2</td>
<td align="left">服务端到客户端</td>
<td align="left">连接报文确认</td>
</tr>
<tr>
<td align="left">PUBLISH</td>
<td align="left">3</td>
<td align="left">两个方向都允许</td>
<td align="left">发布消息</td>
</tr>
<tr>
<td align="left">PUBACK</td>
<td align="left">4</td>
<td align="left">两个方向都允许</td>
<td align="left">QoS 1消息发布收到确认</td>
</tr>
<tr>
<td align="left">PUBREC</td>
<td align="left">5</td>
<td align="left">两个方向都允许</td>
<td align="left">发布收到(保证交付第一步)</td>
</tr>
<tr>
<td align="left">PUBREL</td>
<td align="left">6</td>
<td align="left">两个方向都允许</td>
<td align="left">发布释放(保证交付第二步)</td>
</tr>
<tr>
<td align="left">PUBCOMP</td>
<td align="left">7</td>
<td align="left">两个方向都允许</td>
<td align="left">QoS 2消息发布完成(保证交互第三步)</td>
</tr>
<tr>
<td align="left">SUBSCRIBE</td>
<td align="left">8</td>
<td align="left">客户端到服务端</td>
<td align="left">客户端订阅请求</td>
</tr>
<tr>
<td align="left">SUBACK</td>
<td align="left">9</td>
<td align="left">服务端到客户端</td>
<td align="left">订阅请求报文确认</td>
</tr>
<tr>
<td align="left">UNSUBSCRIBE</td>
<td align="left">10</td>
<td align="left">客户端到服务端</td>
<td align="left">客户端取消订阅请求</td>
</tr>
<tr>
<td align="left">UNSUBACK</td>
<td align="left">11</td>
<td align="left">服务端到客户端</td>
<td align="left">取消订阅报文确认</td>
</tr>
<tr>
<td align="left">PINGREQ</td>
<td align="left">12</td>
<td align="left">客户端到服务端</td>
<td align="left">心跳请求</td>
</tr>
<tr>
<td align="left">PINGRESP</td>
<td align="left">13</td>
<td align="left">服务端到客户端</td>
<td align="left">心跳响应</td>
</tr>
<tr>
<td align="left">DISCONNECT</td>
<td align="left">14</td>
<td align="left">客户端到服务端</td>
<td align="left">客户端断开连接</td>
</tr>
<tr>
<td align="left">Reserved</td>
<td align="left">15</td>
<td align="left">禁止</td>
<td align="left">保留</td>
</tr>
</tbody></table>
<h4 id="2-2-2-标志-Flags"><a href="#2-2-2-标志-Flags" class="headerlink" title="2.2.2 标志 Flags"></a>2.2.2 标志 Flags</h4><p>固定报头第1个字节的剩余的4位 [3-0]包含每个MQTT控制报文类型特定的标志, 见 <a href="https://www.zybuluo.com/khan-lau/note/1326839#表格-22---标志位-flag-bits" target="_blank" rel="noopener">表格 2.2 -标志位</a>. 表格 2.2中任何标记为“保留”的标志位, 都是保留给以后使用的, <strong>必须</strong>设置为表格中列出的值 [MQTT-2.2.2-1]. 如果收到非法的标志, 接收者<strong>必须</strong>关闭网络连接. 有关错误处理的详细信息见 <a href="https://www.zybuluo.com/khan-lau/note/1326839#48-错误处理-handling-errors" target="_blank" rel="noopener">4.8节</a> [MQTT-2.2.2-2].</p>
<h5 id="表格-2-2-标志位-Flag-Bits"><a href="#表格-2-2-标志位-Flag-Bits" class="headerlink" title="表格 2.2 - 标志位 Flag Bits"></a>表格 2.2 - 标志位 Flag Bits</h5><table>
<thead>
<tr>
<th align="left"><strong>控制报文</strong></th>
<th align="left"><strong>固定报头标志</strong></th>
<th align="left"><strong>Bit 3</strong></th>
<th align="left"><strong>Bit 2</strong></th>
<th align="left"><strong>Bit 1</strong></th>
<th align="left"><strong>Bit 0</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">CONNECT</td>
<td align="left">Reserved</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">CONNACK</td>
<td align="left">Reserved</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">PUBLISH</td>
<td align="left">Used in MQTT 3.1.1</td>
<td align="left">DUP1</td>
<td align="left">QoS2</td>
<td align="left">QoS2</td>
<td align="left">RETAIN3</td>
</tr>
<tr>
<td align="left">PUBACK</td>
<td align="left">Reserved</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">PUBREC</td>
<td align="left">Reserved</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">PUBREL</td>
<td align="left">Reserved</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">PUBCOMP</td>
<td align="left">Reserved</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">SUBSCRIBE</td>
<td align="left">Reserved</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">SUBACK</td>
<td align="left">Reserved</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">UNSUBSCRIBE</td>
<td align="left">Reserved</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">UNSUBACK</td>
<td align="left">Reserved</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">PINGREQ</td>
<td align="left">Reserved</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">PINGRESP</td>
<td align="left">Reserved</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">DISCONNECT</td>
<td align="left">Reserved</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
</tbody></table>
<p>- DUP1 =控制报文的重复分发标志<br>- QoS2 = PUBLISH报文的服务质量等级<br>- RETAIN3 = PUBLISH报文的保留标志</p>
<p>PUBLISH控制报文中的DUP, QoS和RETAIN标志的描述见 <a href="https://www.zybuluo.com/khan-lau/note/1326839#331-固定报头" target="_blank" rel="noopener">3.3.1节</a>.</p>
<h4 id="2-2-3-剩余长度-Remaining-Length"><a href="#2-2-3-剩余长度-Remaining-Length" class="headerlink" title="2.2.3 剩余长度 Remaining Length"></a>2.2.3 剩余长度 Remaining Length</h4><p><strong>位置：</strong>从第2个字节开始.</p>
<p>剩余长度(Remaining Length)表示当前报文剩余部分的字节数, 包括可变报头和负载的数据. 剩余长度不包括用于编码剩余长度字段本身的字节数.</p>
<p>剩余长度字段使用一个变长度编码方案, 对小于128的值它使用单字节编码. 更大的值按下面的方式处理. 低7位有效位用于编码数据, 最高有效位用于指示是否有更多的字节. 因此每个字节可以编码128个数值和一个<em>延续位(continuation bit)</em>. 剩余长度字段最大4个字节.</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>例如, 十进制数64会被编码为一个字节, 数值是64, 十六进制表示为0x40,. 十进制数字321(=65+2*128)被编码为两个字节, 最低有效位在前. 第一个字节是 65+128=193. 注意最高位为1表示后面至少还有一个字节. 第二个字节是2.</p>
<p><strong>非规范评注</strong></p>
<p>这允许应用发送最大256MB(268,435,455)大小的控制报文. 这个数值在报文中的表示是：0xFF,0xFF,0xFF,0x7F.</p>
<p><a href="https://www.zybuluo.com/khan-lau/note/1326839#表格-24剩余长度字段的大小-size-of-remaining-length-field" target="_blank" rel="noopener">表格 2.4剩余长度字段的大小</a>展示了<code>剩余长度</code>字段所表示的值随字节增长.</p>
</blockquote>
<h5 id="表格-2-4剩余长度字段的大小-Size-of-Remaining-Length-field"><a href="#表格-2-4剩余长度字段的大小-Size-of-Remaining-Length-field" class="headerlink" title="表格 2.4剩余长度字段的大小 Size of Remaining Length field"></a>表格 2.4剩余长度字段的大小 Size of Remaining Length field</h5><table>
<thead>
<tr>
<th align="left"><strong>字节数</strong></th>
<th align="left"><strong>最小值</strong></th>
<th align="left"><strong>最大值</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">0 (0x00)</td>
<td align="left">127 (0x7F)</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">128 (0x80, 0x01)</td>
<td align="left">16 383 (0xFF, 0x7F)</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">16 384 (0x80, 0x80, 0x01)</td>
<td align="left">2 097 151 (0xFF, 0xFF, 0x7F)</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">2 097 152 (0x80, 0x80, 0x80, 0x01)</td>
<td align="left">268 435 455 (0xFF, 0xFF, 0xFF, 0x7F)</td>
</tr>
</tbody></table>
<p>分别表示(每个字节的低7位用于编码数据, 最高位是标志位)：</p>
<ul>
<li>1个字节时, 从0(0x00)到127(0x7f)</li>
<li>2个字节时, 从128(0x80,0x01)到16383(0Xff,0x7f)</li>
<li>3个字节时, 从16384(0x80,0x80,0x01)到2097151(0xFF,0xFF,0x7F)</li>
<li>4个字节时, 从2097152(0x80,0x80,0x80,0x01)到268435455(0xFF,0xFF,0xFF,0x7F)</li>
</ul>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>非负整数X使用变长编码方案的算法如下：</p>
</blockquote>
<pre><code>   do  encodedByte = X MOD 128  X = X DIV 128 // if there are more data to encode, set the top bit of this byte if ( X &gt; 0 )     encodedByte = encodedByte OR 128 endif     &#39;output&#39; encodedBytewhile ( X &gt; 0 )</code></pre><blockquote>
<p>MOD是模运算, DIV是整数除法, OR是位操作或(C语言中分别是%, /, |)</p>
<p><strong>非规范评注</strong></p>
<p>剩余长度字段的解码算法如下：</p>
</blockquote>
<pre><code>multiplier = 1value = 0do    encodedByte = &#39;next byte from stream&#39;    value += (encodedByte AND 127) * multiplier    multiplier *= 128    if (multiplier &gt; 128*128*128)       throw Error(Malformed Remaining Length)while ((encodedByte AND 128) != 0)</code></pre><blockquote>
<p>AND是位操作与(C语言中的&amp;)</p>
<p>这个算法终止时, value包含的就是剩余长度的值.</p>
</blockquote>
<h3 id="2-3-可变报头-Variable-header"><a href="#2-3-可变报头-Variable-header" class="headerlink" title="2.3 可变报头 Variable header"></a>2.3 可变报头 Variable header</h3><p>某些MQTT控制报文包含一个可变报头部分. 它在固定报头和负载之间. 可变报头的内容根据报文类型的不同而不同. 可变报头的报文标识符(Packet Identifier)字段存在于在多个类型的报文里.</p>
<h4 id="2-3-1-报文标识符-Packet-Identifier"><a href="#2-3-1-报文标识符-Packet-Identifier" class="headerlink" title="2.3.1 报文标识符 Packet Identifier"></a>2.3.1 报文标识符 Packet Identifier</h4><h5 id="图例-2-3-报文标识符字节-Packet-Identifier-bytes"><a href="#图例-2-3-报文标识符字节-Packet-Identifier-bytes" class="headerlink" title="图例 2.3 -报文标识符字节 Packet Identifier bytes"></a>图例 2.3 -报文标识符字节 Packet Identifier bytes</h5><table>
<thead>
<tr>
<th align="left"><strong>Bit</strong></th>
<th align="left"><strong>7</strong> - <strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">byte 1</td>
<td align="left">报文标识符 MSB</td>
</tr>
<tr>
<td align="left">byte 2</td>
<td align="left">报文标识符 LSB</td>
</tr>
</tbody></table>
<p>很多控制报文的可变报头部分包含一个两字节的报文标识符字段. 这些报文是<code>PUBLISH</code>(QoS &gt; 0时), <code>PUBACK</code>, <code>PUBREC</code>, <code>PUBREL</code>, <code>PUBCOMP</code>, <code>SUBSCRIBE</code>, <code>SUBACK</code>, <code>UNSUBSCIBE</code>, <code>UNSUBACK</code>.</p>
<p>SUBSCRIBE, UNSUBSCRIBE和PUBLISH(QoS大于0)控制报文<strong>必须</strong>包含一个非零的16位报文标识符(Packet Identifier)[MQTT-2.3.1-1]. 客户端每次发送一个新的这些类型的报文时都<strong>必须</strong>分配一个当前未使用的报文标识符 [MQTT-2.3.1-2]. 如果一个客户端要重发这个特殊的控制报文, 在随后重发那个报文时, 它<strong>必须</strong>使用相同的标识符. 当客户端处理完这个报文对应的确认后, 这个报文标识符就释放可重用. QoS 1的PUBLISH对应的是PUBACK, QoS 2的PUBLISH对应的是PUBCOMP, 与SUBSCRIBE或UNSUBSCRIBE对应的分别是SUBACK或UNSUBACK [MQTT-2.3.1-3]. 发送一个QoS 0的PUBLISH报文时, 相同的条件也适用于服务端 [MQTT-2.3.1-4].</p>
<p>QoS等于0的PUBLISH报文<strong>不能</strong>包含报文标识符 [MQTT-2.3.1-5].</p>
<p>PUBACK, PUBREC, PUBREL报文<strong>必须</strong>包含与最初发送的PUBLISH报文相同的报文标识符 [MQTT-2.3.1-6]. 类似地, SUBACK和UNSUBACK<strong>必须</strong>包含在对应的SUBSCRIBE和UNSUBSCRIBE报文中使用的报文标识符 [MQTT-2.3.1-7].</p>
<p>需要报文标识符的控制报文在 <a href="https://www.zybuluo.com/khan-lau/note/1326839#_Table_2.5_-" target="_blank" rel="noopener">表格 2.5 -包含报文标识符的控制报文</a> 中列出.</p>
<h5 id="表格-2-5-包含报文标识符的控制报文-Control-Packets-that-contain-a-Packet-Identifier"><a href="#表格-2-5-包含报文标识符的控制报文-Control-Packets-that-contain-a-Packet-Identifier" class="headerlink" title="表格 2.5 -包含报文标识符的控制报文 Control Packets that contain a Packet Identifier"></a>表格 2.5 -包含报文标识符的控制报文 Control Packets that contain a Packet Identifier</h5><table>
<thead>
<tr>
<th align="left"><strong>控制报文</strong></th>
<th align="left"><strong>报文标识符字段</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">CONNECT</td>
<td align="left">不需要</td>
</tr>
<tr>
<td align="left">CONNACK</td>
<td align="left">不需要</td>
</tr>
<tr>
<td align="left">PUBLISH</td>
<td align="left">需要(如果QoS &gt; 0)</td>
</tr>
<tr>
<td align="left">PUBACK</td>
<td align="left">需要</td>
</tr>
<tr>
<td align="left">PUBREC</td>
<td align="left">需要</td>
</tr>
<tr>
<td align="left">PUBREL</td>
<td align="left">需要</td>
</tr>
<tr>
<td align="left">PUBCOMP</td>
<td align="left">需要</td>
</tr>
<tr>
<td align="left">SUBSCRIBE</td>
<td align="left">需要</td>
</tr>
<tr>
<td align="left">SUBACK</td>
<td align="left">需要</td>
</tr>
<tr>
<td align="left">UNSUBSCRIBE</td>
<td align="left">需要</td>
</tr>
<tr>
<td align="left">UNSUBACK</td>
<td align="left">需要</td>
</tr>
<tr>
<td align="left">PINGREQ</td>
<td align="left">不需要</td>
</tr>
<tr>
<td align="left">PINGRESP</td>
<td align="left">不需要</td>
</tr>
<tr>
<td align="left">DISCONNECT</td>
<td align="left">不需要</td>
</tr>
</tbody></table>
<p>客户端和服务端彼此独立地分配报文标识符. 因此, 客户端服务端组合使用相同的报文标识符可以实现并发的消息交换.</p>
<p><strong>非规范评注</strong></p>
<p>客户端发送标识符为0x1234的PUBLISH报文, 它有可能会在收到那个报文的PUBACK之前, 先收到服务端发送的另一个不同的但是报文标识符也为0x1234的PUBLISH报文.</p>
<table>
<thead>
<tr>
<th align="left">Client</th>
<th align="left">Server</th>
</tr>
</thead>
<tbody><tr>
<td align="left">PUBLISH</td>
<td align="left">Packet Identifier=0x1234—</td>
</tr>
<tr>
<td align="left">–PUBLISH</td>
<td align="left">Packet Identifier=0x1234</td>
</tr>
<tr>
<td align="left">PUBACK</td>
<td align="left">Packet Identifier=0x1234—</td>
</tr>
<tr>
<td align="left">–PUBACK</td>
<td align="left">Packet Identifier=0x1234</td>
</tr>
</tbody></table>
<h3 id="2-4-有效载荷-Payload"><a href="#2-4-有效载荷-Payload" class="headerlink" title="2.4 有效载荷 Payload"></a>2.4 有效载荷 Payload</h3><p>某些MQTT控制报文在报文的最后部分包含一个有效载荷, 这将在第三章论述. 对于PUBLISH来说有效载荷就是应用消息. <a href="https://www.zybuluo.com/khan-lau/note/1326839#_Table_2.6_-" target="_blank" rel="noopener">表格 2.6 – 包含有效载荷的控制报文</a> 列出了需要有效载荷的控制报文.</p>
<h5 id="表格-2-6-–-包含有效载荷的控制报文-Control-Packets-that-contain-a-Payload"><a href="#表格-2-6-–-包含有效载荷的控制报文-Control-Packets-that-contain-a-Payload" class="headerlink" title="表格 2.6 – 包含有效载荷的控制报文 Control Packets that contain a Payload"></a>表格 2.6 – 包含有效载荷的控制报文 Control Packets that contain a Payload</h5><table>
<thead>
<tr>
<th align="left"><strong>控制报文</strong></th>
<th align="left"><strong>有效载荷</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">CONNECT</td>
<td align="left">需要</td>
</tr>
<tr>
<td align="left">CONNACK</td>
<td align="left">不需要</td>
</tr>
<tr>
<td align="left">PUBLISH</td>
<td align="left">可选</td>
</tr>
<tr>
<td align="left">PUBACK</td>
<td align="left">不需要</td>
</tr>
<tr>
<td align="left">PUBREC</td>
<td align="left">不需要</td>
</tr>
<tr>
<td align="left">PUBREL</td>
<td align="left">不需要</td>
</tr>
<tr>
<td align="left">PUBCOMP</td>
<td align="left">不需要</td>
</tr>
<tr>
<td align="left">SUBSCRIBE</td>
<td align="left">需要</td>
</tr>
<tr>
<td align="left">SUBACK</td>
<td align="left">需要</td>
</tr>
<tr>
<td align="left">UNSUBSCRIBE</td>
<td align="left">需要</td>
</tr>
<tr>
<td align="left">UNSUBACK</td>
<td align="left">不需要</td>
</tr>
<tr>
<td align="left">PINGREQ</td>
<td align="left">不需要</td>
</tr>
<tr>
<td align="left">PINGRESP</td>
<td align="left">不需要</td>
</tr>
<tr>
<td align="left">DISCONNECT</td>
<td align="left">不需要</td>
</tr>
</tbody></table>
<h2 id="第三章-MQTT控制报文-MQTT-Control-Packets"><a href="#第三章-MQTT控制报文-MQTT-Control-Packets" class="headerlink" title="第三章 MQTT控制报文 MQTT Control Packets"></a>第三章 MQTT控制报文 MQTT Control Packets</h2><h3 id="3-1-CONNECT-–-连接服务端"><a href="#3-1-CONNECT-–-连接服务端" class="headerlink" title="3.1 CONNECT – 连接服务端"></a>3.1 CONNECT – 连接服务端</h3><p>客户端到服务端的网络连接建立后, 客户端发送给服务端的第一个报文<strong>必须</strong>是CONNECT报文 [MQTT-3.1.0-1].</p>
<p>在一个网络连接上, 客户端只能发送一次CONNECT报文. 服务端<strong>必须</strong>将客户端发送的第二个CONNECT报文当作协议违规处理并断开客户端的连接 [MQTT-3.1.0-2]. 有关错误处理的信息请查看<a href="https://www.zybuluo.com/khan-lau/note/1326839#48-错误处理-handling-errors" target="_blank" rel="noopener">4.8节</a>.</p>
<p>有效载荷包含一个或多个编码的字段. 包括客户端的唯一标识符, Will主题, Will消息, 用户名和密码. 除了客户端标识之外, 其它的字段都是可选的, 基于标志位来决定可变报头中是否需要包含这些字段.</p>
<h4 id="3-1-1-固定报头-Fixed-header"><a href="#3-1-1-固定报头-Fixed-header" class="headerlink" title="3.1.1 固定报头 Fixed header"></a>3.1.1 固定报头 Fixed header</h4><h5 id="图例-3-1-–CONNECT报文的固定报头"><a href="#图例-3-1-–CONNECT报文的固定报头" class="headerlink" title="图例 3.1 –CONNECT报文的固定报头"></a>图例 3.1 –CONNECT报文的固定报头</h5><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>MQTT报文类型 (1)</td>
<td>Reserved 保留位</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>byte 2…</td>
<td>剩余长度</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>剩余长度字段</strong></p>
<p>剩余长度等于可变报头的长度(10字节)加上有效载荷的长度. 编码方式见 <a href="https://www.zybuluo.com/khan-lau/note/1326839#223-剩余长度-remaining-length" target="_blank" rel="noopener">2.2.3节</a>的说明.</p>
<h4 id="3-1-2-可变报头-Variable-header"><a href="#3-1-2-可变报头-Variable-header" class="headerlink" title="3.1.2 可变报头 Variable header"></a>3.1.2 可变报头 Variable header</h4><p>CONNECT报文的可变报头按下列次序包含四个字段：协议名(Protocol Name), 协议级别(Protocol Level), 连接标志(Connect Flags)和保持连接(Keep Alive).</p>
<h5 id="协议名-Protocol-Name"><a href="#协议名-Protocol-Name" class="headerlink" title="协议名 Protocol Name"></a>协议名 Protocol Name</h5><h6 id="图例-3-2-协议名字节构成"><a href="#图例-3-2-协议名字节构成" class="headerlink" title="图例 3.2 -协议名字节构成"></a>图例 3.2 -协议名字节构成</h6><table>
<thead>
<tr>
<th align="left"><strong>说明</strong></th>
<th align="left"><strong>7</strong></th>
<th align="left"><strong>6</strong></th>
<th align="left"><strong>5</strong></th>
<th align="left"><strong>4</strong></th>
<th align="left"><strong>3</strong></th>
<th align="left"><strong>2</strong></th>
<th align="left"><strong>1</strong></th>
<th align="left"><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">协议名</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">byte 1</td>
<td align="left">长度 MSB (0)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 2</td>
<td align="left">长度 LSB (4)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 3</td>
<td align="left">‘M’</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 4</td>
<td align="left">‘Q’</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 5</td>
<td align="left">‘T’</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 6</td>
<td align="left">‘T’</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
</tbody></table>
<p>协议名是表示协议名 <em>MQTT</em> 的UTF-8编码的字符串. MQTT规范的后续版本不会改变这个字符串的偏移和长度.</p>
<p>如果协议名不正确服务端<strong>可以</strong>断开客户端的连接, 也<strong>可以</strong>按照某些其它规范继续处理CONNECT报文. 对于后一种情况, 按照本规范, 服务端<strong>不能</strong>继续处理CONNECT报文 [MQTT-3.1.2-1].</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>数据包检测工具, 例如防火墙, 可以使用协议名来识别MQTT流量.</p>
</blockquote>
<h5 id="协议级别-Protocol-Level"><a href="#协议级别-Protocol-Level" class="headerlink" title="协议级别 Protocol Level"></a>协议级别 Protocol Level</h5><h6 id="图例-3-3-Protocol-Level-byte协议级别字节构成"><a href="#图例-3-3-Protocol-Level-byte协议级别字节构成" class="headerlink" title="图例 3.3 - Protocol Level byte协议级别字节构成"></a>图例 3.3 - Protocol Level byte协议级别字节构成</h6><table>
<thead>
<tr>
<th align="left"><strong>说明</strong></th>
<th align="left"><strong>7</strong></th>
<th align="left"><strong>6</strong></th>
<th align="left"><strong>5</strong></th>
<th align="left"><strong>4</strong></th>
<th align="left"><strong>3</strong></th>
<th align="left"><strong>2</strong></th>
<th align="left"><strong>1</strong></th>
<th align="left"><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">协议级别</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">byte 7</td>
<td align="left">Level(4)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
</tbody></table>
<p>客户端用8位的无符号值表示协议的修订版本. 对于3.1.1版协议, 协议级别字段的值是4(0x04). 如果发现不支持的协议级别, 服务端<strong>必须</strong>给发送一个返回码为0x01(不支持的协议级别)的CONNACK报文响应CONNECT报文, 然后断开客户端的连接 [MQTT-3.1.2-2].</p>
<h5 id="连接标志-Connect-Flags"><a href="#连接标志-Connect-Flags" class="headerlink" title="连接标志 Connect Flags"></a>连接标志 Connect Flags</h5><p>连接标志字节包含一些用于指定MQTT连接行为的参数. 它还指出有效载荷中的字段是否存在.</p>
<h6 id="图例-3-4-连接标志位"><a href="#图例-3-4-连接标志位" class="headerlink" title="图例 3.4 -连接标志位"></a>图例 3.4 -连接标志位</h6><p>服务端<strong>必须</strong>验证CONNECT控制报文的保留标志位(第0位)是否为0, 如果不为0必须断开客户端连接 [MQTT-3.1.2-3].</p>
<h5 id="清理会话-Clean-Session"><a href="#清理会话-Clean-Session" class="headerlink" title="清理会话 Clean Session"></a>清理会话 Clean Session</h5><p><strong>位置：</strong>连接标志字节的第1位</p>
<p>这个二进制位指定了会话状态的处理方式.</p>
<p>客户端和服务端可以保存会话状态, 以支持跨网络连接的可靠消息传输. 这个标志位用于控制会话状态的生存时间.</p>
<p>如果清理会话(CleanSession)标志被设置为0, 服务端<strong>必须</strong>基于当前会话(使用客户端标识符识别)的状态恢复与客户端的通信. 如果没有与这个客户端标识符关联的会话, 服务端<strong>必须</strong>创建一个新的会话. 在连接断开之后, 当连接断开后, 客户端和服务端<strong>必须</strong>保存会话信息 [MQTT-3.1.2-4]. 当清理会话标志为0的会话连接断开之后, 服务端<strong>必须</strong>将之后的QoS 1和QoS 2级别的消息保存为会话状态的一部分, 如果这些消息匹配断开连接时客户端的任何订阅 <a href="https://tools.oasis-open.org/issues/browse/MQTT-3" target="_blank" rel="noopener">MQTT-3</a>.1.2-5]. 服务端也<strong>可以</strong>保存满足相同条件的QoS 0级别的消息.</p>
<p>如果清理会话(CleanSession)标志被设置为1, 客户端和服务端<strong>必须</strong>丢弃之前的任何会话并开始一个新的会话. 会话仅持续和网络连接同样长的时间. 与这个会话关联的状态数据<strong>不能</strong>被任何之后的会话重用 [MQTT-3.1.2-6].</p>
<p>客户端的会话状态包括：</p>
<ul>
<li>已经发送给服务端, 但是还没有完成确认的QoS 1和QoS 2级别的消息</li>
<li>已从服务端接收, 但是还没有完成确认的QoS 2级别的消息.</li>
</ul>
<p>服务端的会话状态包括：</p>
<ul>
<li>会话是否存在, 即使会话状态的其它部分都是空.</li>
<li>客户端的订阅信息.</li>
<li>已经发送给客户端, 但是还没有完成确认的QoS 1和QoS 2级别的消息.</li>
<li>即将传输给客户端的QoS 1和QoS 2级别的消息.</li>
<li>已从客户端接收, 但是还没有完成确认的QoS 2级别的消息.</li>
<li>可选, 准备发送给客户端的QoS 0级别的消息.</li>
</ul>
<p>保留消息不是服务端会话状态的一部分, 会话终止时<strong>不能</strong>删除保留消息 [MQTT-3.1.2.7].</p>
<p>有关状态存储的限制和细节见第 <a href="https://www.zybuluo.com/khan-lau/note/1326839#41-状态存储-storing-state" target="_blank" rel="noopener">4.1节</a>.</p>
<p>当清理会话标志被设置为1时, 客户端和服务端的状态删除不需要是原子操作.</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>为了确保在发生故障时状态的一致性, 客户端应该使用会话状态标志1重复请求连接, 直到连接成功.</p>
<p><strong>非规范评注</strong></p>
<p>一般来说, 客户端连接时总是将清理会话标志设置为0或1, 并且不交替使用两种值. 这个选择取决于具体的应用. 清理会话标志设置为1的客户端不会收到旧的应用消息, 而且在每次连接成功后都需要重新订阅任何相关的主题. 清理会话标志设置为0的客户端会收到所有在它连接断开期间发布的QoS 1和QoS 2级别的消息. 因此, 要确保不丢失连接断开期间的消息, 需要使用QoS 1或 QoS 2级别, 同时将清理会话标志设置为0.</p>
<p><strong>非规范评注</strong></p>
<p>清理会话标志0的客户端连接时, 它请求服务端在连接断开后保留它的MQTT会话状态. 如果打算在之后的某个时间点重连到这个服务端, 客户端连接应该只使用清理会话标志0. 当客户端决定之后不再使用这个会话时, 应该将清理会话标志设置为1最后再连接一次, 然后断开连接.</p>
</blockquote>
<h5 id="遗嘱标志-Will-Flag"><a href="#遗嘱标志-Will-Flag" class="headerlink" title="遗嘱标志 Will Flag"></a>遗嘱标志 Will Flag</h5><p><strong>位置：</strong>连接标志的第2位.</p>
<p>遗嘱标志(Will Flag)被设置为1, 表示如果连接请求被接受了, 遗嘱(Will Message)消息<strong>必须</strong>被存储在服务端并且与这个网络连接关联. 之后网络连接关闭时, 服务端<strong>必须</strong>发布这个遗嘱消息, 除非服务端收到DISCONNECT报文时删除了这个遗嘱消息 [MQTT-3.1.2-8] .</p>
<p>遗嘱消息发布的条件, 包括但不限于：</p>
<ul>
<li>服务端检测到了一个I/O错误或者网络故障.</li>
<li>客户端在保持连接(Keep Alive)的时间内未能通讯.</li>
<li>客户端没有先发送DISCONNECT报文直接关闭了网络连接.</li>
<li>由于协议错误服务端关闭了网络连接.</li>
</ul>
<p>如果遗嘱标志被设置为1, 连接标志中的Will QoS和Will Retain字段会被服务端用到, 同时有效载荷中<strong>必须</strong>包含Will Topic和Will Message字段 [MQTT-3.1.2-9].</p>
<p>一旦被发布或者服务端收到了客户端发送的DISCONNECT报文, 遗嘱消息就<strong>必须</strong>从存储的会话状态中移除 [MQTT-3.1.2-10].</p>
<p>如果遗嘱标志被设置为0, 连接标志中的Will QoS和Will Retain字段<strong>必须</strong>设置为0, 并且有效载荷中<strong>不能</strong>包含Will Topic和Will Message字段 [MQTT-3.1.2-11].</p>
<p>如果遗嘱标志被设置为0, 网络连接断开时, <strong>不能</strong>发送遗嘱消息 [MQTT-3.1.2-12].</p>
<p>服务端应该迅速发布遗嘱消息. 在关机或故障的情况下, 服务端可以推迟遗嘱消息的发布直到之后的重启. 如果发生了这种情况, 在服务器故障和遗嘱消息被发布之间可能会有一个延迟.</p>
<h5 id="遗嘱QoS-Will-QoS"><a href="#遗嘱QoS-Will-QoS" class="headerlink" title="遗嘱QoS Will QoS"></a>遗嘱QoS Will QoS</h5><p><strong>位置：</strong>连接标志的第4和第3位.</p>
<p>这两位用于指定发布遗嘱消息时使用的服务质量等级.</p>
<p>如果遗嘱标志被设置为0, 遗嘱QoS也<strong>必须</strong>设置为0(0x00) [MQTT-3.1.2-13].</p>
<p>如果遗嘱标志被设置为1, 遗嘱QoS的值可以等于0(0x00), 1(0x01), 2(0x02). 它的值<strong>不能</strong>等于3 [MQTT-3.1.2-14].</p>
<h5 id="遗嘱保留-Will-Retain"><a href="#遗嘱保留-Will-Retain" class="headerlink" title="遗嘱保留 Will Retain"></a>遗嘱保留 Will Retain</h5><p><strong>位置：</strong>连接标志的第5位.</p>
<p>如果遗嘱消息被发布时需要保留, 需要指定这一位的值.</p>
<p>如果遗嘱标志被设置为0, 遗嘱保留(Will Retain)标志也<strong>必须</strong>设置为0 [MQTT-3.1.2-15].</p>
<p>如果遗嘱标志被设置为1：</p>
<ul>
<li>如果遗嘱保留被设置为0, 服务端<strong>必须</strong>将遗嘱消息当作非保留消息发布 [MQTT-3.1.2-16].</li>
<li>如果遗嘱保留被设置为1, 服务端<strong>必须</strong>将遗嘱消息当作保留消息发布 [MQTT-3.1.2-17].</li>
</ul>
<h5 id="用户名标志-User-Name-Flag"><a href="#用户名标志-User-Name-Flag" class="headerlink" title="用户名标志 User Name Flag"></a>用户名标志 User Name Flag</h5><p><strong>位置：</strong>连接标志的第7位.</p>
<p>如果用户名(User Name)标志被设置为0, 有效载荷中<strong>不能</strong>包含用户名字段 [MQTT-3.1.2-18].</p>
<p>如果用户名(User Name)标志被设置为1, 有效载荷中<strong>必须</strong>包含用户名字段 [MQTT-3.1.2-19].</p>
<h5 id="密码标志-Password-Flag"><a href="#密码标志-Password-Flag" class="headerlink" title="密码标志 Password Flag"></a>密码标志 Password Flag</h5><p><strong>位置：</strong>连接标志的第6位.</p>
<p>如果密码(Password)标志被设置为0, 有效载荷中<strong>不能</strong>包含密码字段 [MQTT-3.1.2-20].</p>
<p>如果密码(Password)标志被设置为1, 有效载荷中<strong>必须</strong>包含密码字段 [MQTT-3.1.2-21].</p>
<p>如果用户名标志被设置为0, 密码标志也<strong>必须</strong>设置为0 [MQTT-3.1.2-22].</p>
<h5 id="保持连接-Keep-Alive"><a href="#保持连接-Keep-Alive" class="headerlink" title="保持连接 Keep Alive"></a>保持连接 Keep Alive</h5><h5 id="图例-3-5保持连接字节"><a href="#图例-3-5保持连接字节" class="headerlink" title="图例 3.5保持连接字节"></a>图例 3.5保持连接字节</h5><table>
<thead>
<tr>
<th align="left"><strong>Bit</strong></th>
<th align="left"><strong>7</strong></th>
<th align="left"><strong>6</strong></th>
<th align="left"><strong>5</strong></th>
<th align="left"><strong>4</strong></th>
<th align="left"><strong>3</strong></th>
<th align="left"><strong>2</strong></th>
<th align="left"><strong>1</strong></th>
<th align="left"><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">byte 9</td>
<td align="left">保持连接 Keep Alive MSB</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">byte 10</td>
<td align="left">保持连接 Keep Alive LSB</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<p>保持连接(Keep Alive)是一个以秒为单位的时间间隔, 表示为一个16位的字, 它是指在客户端传输完成一个控制报文的时刻到发送下一个报文的时刻, 两者之间允许空闲的最大时间间隔. 客户端负责保证控制报文发送的时间间隔不超过保持连接的值. 如果没有任何其它的控制报文可以发送, 客户端<strong>必须</strong>发送一个PINGREQ报文 [MQTT-3.1.2-23].</p>
<p>不管保持连接的值是多少, 客户端任何时候都可以发送PINGREQ报文, 并且使用PINGRESP报文判断网络和服务端的活动状态.</p>
<p>如果保持连接的值非零, 并且服务端在一点五倍的保持连接时间内没有收到客户端的控制报文, 它<strong>必须</strong>断开客户端的网络连接, 认为网络连接已断开 [MQTT-3.1.2-24].</p>
<p>客户端发送了PINGREQ报文之后, 如果在合理的时间内仍没有收到PINGRESP报文, 它<strong>应该</strong>关闭到服务端的网络连接.</p>
<p>保持连接的值为零表示关闭保持连接功能. 这意味着, 服务端不需要因为客户端不活跃而断开连接. 注意：不管保持连接的值是多少, 任何时候, 只要服务端认为客户端是不活跃或无响应的, 可以断开客户端的连接.</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>保持连接的实际值是由应用指定的, 一般是几分钟. 允许的最大值是18小时12分15秒.</p>
</blockquote>
<h5 id="可变报头非规范示例"><a href="#可变报头非规范示例" class="headerlink" title="可变报头非规范示例"></a>可变报头非规范示例</h5><h6 id="图例-3-6-可变报头非规范示例"><a href="#图例-3-6-可变报头非规范示例" class="headerlink" title="图例 3.6 -可变报头非规范示例"></a>图例 3.6 -可变报头非规范示例</h6><h4 id="3-1-3-有效载荷-Payload"><a href="#3-1-3-有效载荷-Payload" class="headerlink" title="3.1.3 有效载荷 Payload"></a>3.1.3 有效载荷 Payload</h4><p>CONNECT报文的有效载荷(payload)包含一个或多个以长度为前缀的字段, 可变报头中的标志决定是否包含这些字段. 如果包含的话, <strong>必须</strong>按这个顺序出现：客户端标识符, 遗嘱主题, 遗嘱消息, 用户名, 密码 [MQTT-3.1.3-1].</p>
<h5 id="客户端标识符-Client-Identifier"><a href="#客户端标识符-Client-Identifier" class="headerlink" title="客户端标识符 Client Identifier"></a>客户端标识符 Client Identifier</h5><p>服务端使用客户端标识符 (ClientId) 识别客户端. 连接服务端的每个客户端都有唯一的客户端标识符(ClientId). 客户端和服务端都必须使用ClientId识别两者之间的MQTT会话相关的状态 [MQTT-3.1.3-2].</p>
<p>客户端标识符 (ClientId) <strong>必须</strong>存在而且<strong>必须</strong>是CONNECT报文有效载荷的第一个字段 [MQTT-3.1.3-3].</p>
<p>客户端标识符<strong>必须</strong>是<a href="https://www.zybuluo.com/khan-lau/note/1326839#153-utf-8编码字符串-utf-8-encoded-strings" target="_blank" rel="noopener">1.5.3节</a>定义的UTF-8编码字符串 [MQTT-3.1.3-4].</p>
<p>服务端<strong>必须</strong>允许1到23个字节长的UTF-8编码的客户端标识符, 客户端标识符只能包含这些字符：“0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ”(大写字母, 小写字母和数字)[MQTT-3.1.3-5].</p>
<p>服务端<strong>可以</strong>允许编码后超过23个字节的客户端标识符 (ClientId). 服务端<strong>可以</strong>允许包含不是上面列表字符的客户端标识符 (ClientId).</p>
<p>服务端<strong>可以</strong>允许客户端提供一个零字节的客户端标识符 (ClientId) , 如果这样做了, 服务端<strong>必须</strong>将这看作特殊情况并分配唯一的客户端标识符给那个客户端. 然后它<strong>必须</strong>假设客户端提供了那个唯一的客户端标识符, 正常处理这个CONNECT报文 [MQTT-3.1.3-6].</p>
<p>如果客户端提供了一个零字节的客户端标识符, 它<strong>必须</strong>同时将清理会话标志设置为1 [MQTT-3.1.3-7].</p>
<p>如果客户端提供的ClientId为零字节且清理会话标志为0, 服务端<strong>必须</strong>发送返回码为0x02(表示标识符不合格)的CONNACK报文响应客户端的CONNECT报文, 然后关闭网络连接 [MQTT-3.1.3-8].</p>
<p>如果服务端拒绝了这个ClientId, 它<strong>必须</strong>发送返回码为0x02(表示标识符不合格)的CONNACK报文响应客户端的CONNECT报文, 然后关闭网络连接 [MQTT-3.1.3-9].</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>客户端实现可以提供一个方便的方法用于生成随机的ClientId. 当清理会话标志被设置为0时应该主动放弃使用这种方法.</p>
</blockquote>
<h5 id="遗嘱主题-Will-Topic"><a href="#遗嘱主题-Will-Topic" class="headerlink" title="遗嘱主题 Will Topic"></a>遗嘱主题 Will Topic</h5><p>如果遗嘱标志被设置为1, 有效载荷的下一个字段是遗嘱主题(Will Topic). 遗嘱主题<strong>必须</strong>是 <a href="https://www.zybuluo.com/khan-lau/note/1326839#153-utf-8编码字符串-utf-8-encoded-strings" target="_blank" rel="noopener">1.5.3节</a>定义的UTF-8编码字符串 [MQTT-3.1.3-10].</p>
<h5 id="遗嘱消息-Will-Message"><a href="#遗嘱消息-Will-Message" class="headerlink" title="遗嘱消息 Will Message"></a>遗嘱消息 Will Message</h5><p>如果遗嘱标志被设置为1, 有效载荷的下一个字段是遗嘱消息. 遗嘱消息定义了将被发布到遗嘱主题的应用消息, 见3.1.2.5节的描述. 这个字段由一个两字节的长度和遗嘱消息的有效载荷组成, 表示为零字节或多个字节序列. 长度给出了跟在后面的数据的字节数, 不包含长度字段本身占用的两个字节.</p>
<p>遗嘱消息被发布到遗嘱主题时, 它的有效载荷只包含这个字段的数据部分, 不包含开头的两个长度字节.</p>
<h5 id="用户名-User-Name"><a href="#用户名-User-Name" class="headerlink" title="用户名 User Name"></a>用户名 User Name</h5><p>如果用户名(User Name)标志被设置为1, 有效载荷的下一个字段就是它. 用户名<strong>必须</strong>是 <a href="https://www.zybuluo.com/khan-lau/note/1326839#153-utf-8编码字符串-utf-8-encoded-strings" target="_blank" rel="noopener">1.5.3节</a>定义的UTF-8编码字符串 [MQTT-3.1.3-11]. 服务端可以将它用于身份验证和授权.</p>
<h5 id="密码-Password"><a href="#密码-Password" class="headerlink" title="密码 Password"></a>密码 Password</h5><p>如果密码(Password)标志被设置为1, 有效载荷的下一个字段就是它. 密码字段包含一个两字节的长度字段, 长度表示二进制数据的字节数(不包含长度字段本身占用的两个字节), 后面跟着0到65535字节的二进制数据.</p>
<h5 id="图例-3-7-密码字节"><a href="#图例-3-7-密码字节" class="headerlink" title="图例 3.7 - 密码字节"></a>图例 3.7 - 密码字节</h5><table>
<thead>
<tr>
<th align="left"><strong>Bit</strong></th>
<th align="left"><strong>7</strong> - <strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">byte 1</td>
<td align="left">数据长度 MSB</td>
</tr>
<tr>
<td align="left">byte 2</td>
<td align="left">数据长度 LSB</td>
</tr>
<tr>
<td align="left">byte 3 ….</td>
<td align="left">如果长度大于0, 这里就是数据部分</td>
</tr>
</tbody></table>
<h4 id="3-1-4-响应-Response"><a href="#3-1-4-响应-Response" class="headerlink" title="3.1.4 响应 Response"></a>3.1.4 响应 Response</h4><p>注意：服务器可以在同一个TCP端口或其他网络端点上支持多种协议(包括本协议的早期版本). 如果服务器确定协议是MQTT 3.1.1, 那么它按照下面的方法验证连接请求.</p>
<ol>
<li>网络连接建立后, 如果服务端在合理的时间内没有收到CONNECT报文, 服务端<strong>应该</strong>关闭这个连接.</li>
<li>服务端<strong>必须</strong>按照3.1节的要求验证CONNECT报文, 如果报文不符合规范, 服务端不发送CONNACK报文直接关闭网络连接 [MQTT-3.1.4-1].</li>
<li>服务端<strong>可以</strong>检查CONNECT报文的内容是不是满足任何进一步的限制, <strong>可以</strong>执行身份验证和授权检查. 如果任何一项检查没通过, 按照3.2节的描述, 它<strong>应该</strong>发送一个适当的、返回码非零的CONNACK响应, 并且<strong>必须</strong>关闭这个网络连接.</li>
</ol>
<p>如果验证成功, 服务端会执行下列步骤.</p>
<ol>
<li>如果ClientId表明客户端已经连接到这个服务端, 那么服务端<strong>必须</strong>断开原有的客户端连接 [MQTT-3.1.4-2].</li>
<li>服务端<strong>必须</strong>按照 3.1.2.4节的描述执行清理会话的过程 [MQTT-3.1.4-3].</li>
<li>服务端<strong>必须</strong>发送返回码为零的CONNACK报文作为CONNECT报文的确认响应 [MQTT-3.1.4-4].</li>
<li>开始消息分发和保持连接状态监视.</li>
</ol>
<p>允许客户端在发送CONNECT报文之后立即发送其它的控制报文；客户端不需要等待服务端的CONNACK报文. 如果服务端拒绝了CONNECT, 它<strong>不能</strong>处理客户端在CONNECT报文之后发送的任何数据 [MQTT-3.1.4-5].</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>客户端通常会等待一个CONNACK报文. 然而客户端有权在收到CONNACK之前发送控制报文, 由于不需要维持连接状态, 这可以简化客户端的实现.</p>
</blockquote>
<h3 id="3-2-CONNACK-–-确认连接请求"><a href="#3-2-CONNACK-–-确认连接请求" class="headerlink" title="3.2 CONNACK – 确认连接请求"></a>3.2 CONNACK – 确认连接请求</h3><p>服务端发送CONNACK报文响应从客户端收到的CONNECT报文. 服务端发送给客户端的第一个报文<strong>必须</strong>是CONNACK [MQTT-3.2.0-1].</p>
<p>如果客户端在合理的时间内没有收到服务端的CONNACK报文, 客户端<strong>应该</strong>关闭网络连接. <em>合理</em> 的时间取决于应用的类型和通信基础设施.</p>
<h4 id="3-2-1-固定报头"><a href="#3-2-1-固定报头" class="headerlink" title="3.2.1 固定报头"></a>3.2.1 固定报头</h4><p>固定报头的格式见 <a href="https://www.zybuluo.com/khan-lau/note/1326839#_Figure_3.8_–" target="_blank" rel="noopener">图例 3.8 – CONNACK 报文固定报头</a> 的描述.</p>
<h5 id="图例-3-8-–-CONNACK-报文固定报头"><a href="#图例-3-8-–-CONNACK-报文固定报头" class="headerlink" title="图例 3.8 – CONNACK 报文固定报头"></a>图例 3.8 – CONNACK 报文固定报头</h5><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>MQTT报文类型 (2)</td>
<td>Reserved 保留位</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>byte 2…</td>
<td>剩余长度 (2)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
</tbody></table>
<p><strong>剩余长度字段</strong></p>
<p>表示可变报头的长度. 对于CONNACK报文这个值等于2.</p>
<h4 id="3-2-2-可变报头"><a href="#3-2-2-可变报头" class="headerlink" title="3.2.2 可变报头"></a>3.2.2 可变报头</h4><p>可变报头的格式见 <a href="https://www.zybuluo.com/khan-lau/note/1326839#_图例_3.9_–CONNACK报文可变报头" target="_blank" rel="noopener">图例 3.9 –CONNACK报文可变报头</a> 的描述.</p>
<h5 id="图例-3-9-–CONNACK报文可变报头"><a href="#图例-3-9-–CONNACK报文可变报头" class="headerlink" title="图例 3.9 –CONNACK报文可变报头"></a>图例 3.9 –CONNACK报文可变报头</h5><table>
<thead>
<tr>
<th align="left"><strong>描述</strong></th>
<th align="left"><strong>7</strong></th>
<th align="left"><strong>6</strong></th>
<th align="left"><strong>5</strong></th>
<th align="left"><strong>4</strong></th>
<th align="left"><strong>3</strong></th>
<th align="left"><strong>2</strong></th>
<th align="left"><strong>1</strong></th>
<th align="left"><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">连接确认标志</td>
<td align="left">Reserved 保留位</td>
<td align="left">SP1</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">byte 1</td>
<td align="left"></td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">连接返回码</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">byte 2</td>
<td align="left"></td>
<td align="left">X</td>
<td align="left">X</td>
<td align="left">X</td>
<td align="left">X</td>
<td align="left">X</td>
<td align="left">X</td>
<td align="left">X</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th></th>
<th><strong>描述</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>连接确认标志</td>
<td>Reserved 保留位</td>
<td>SP1</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte 1</td>
<td></td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>X</td>
</tr>
<tr>
<td>连接返回码</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte 2</td>
<td></td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
</tbody></table>
<h5 id="连接确认标志-Connect-Acknowledge-Flags"><a href="#连接确认标志-Connect-Acknowledge-Flags" class="headerlink" title="连接确认标志 Connect Acknowledge Flags"></a>连接确认标志 Connect Acknowledge Flags</h5><p>第1个字节是 <em>连接确认标志</em>, 位7-1是保留位且<strong>必须</strong>设置为0.<br>第0 (SP)位 是当前会话(Session Present)标志.</p>
<h5 id="当前会话-Session-Present"><a href="#当前会话-Session-Present" class="headerlink" title="当前会话 Session Present"></a>当前会话 Session Present</h5><p><strong>位置：</strong>连接确认标志的第0位.</p>
<p>如果服务端收到清理会话(CleanSession)标志为1的连接, 除了将CONNACK报文中的返回码设置为0之外, 还<strong>必须</strong>将CONNACK报文中的当前会话设置(Session Present)标志为0 [MQTT-3.2.2-1].</p>
<p>如果服务端收到一个CleanSession为0的连接, 当前会话标志的值取决于服务端是否已经保存了ClientId对应客户端的会话状态. 如果服务端已经保存了会话状态, 它<strong>必须</strong>将CONNACK报文中的当前会话标志设置为1 [MQTT-3.2.2-2]. 如果服务端没有已保存的会话状态, 它<strong>必须</strong>将CONNACK报文中的当前会话设置为0. 还需要将CONNACK报文中的返回码设置为0 [MQTT-3.2.2-3].</p>
<p>当前会话标志使服务端和客户端在是否有已存储的会话状态上保持一致.</p>
<p>一旦完成了会话的初始化设置, 已经保存会话状态的客户端将期望服务端维持它存储的会话状态. 如果客户端从服务端收到的当前的值与预期的不同, 客户端可以选择继续这个会话或者断开连接. 客户端可以丢弃客户端和服务端之间的会话状态, 方法是, 断开连接, 将清理会话标志设置为1, 再次连接, 然后再次断开连接.</p>
<p>如果服务端发送了一个包含非零返回码的CONNACK报文, 它<strong>必须</strong>将当前会话标志设置为0 [MQTT-3.2.2-4].</p>
<h5 id="连接返回码-Connect-Return-code"><a href="#连接返回码-Connect-Return-code" class="headerlink" title="连接返回码 Connect Return code"></a>连接返回码 Connect Return code</h5><p><strong>位置：</strong>可变报头的第2个字节.</p>
<p>连接返回码字段使用一个字节的无符号值, 在 <a href="https://www.zybuluo.com/khan-lau/note/1326839#_表格_3.1_–连接返回码的值" target="_blank" rel="noopener">表格 3.1 –连接返回码的值</a> 中列出. 如果服务端收到一个合法的CONNECT报文, 但出于某些原因无法处理它, 服务端应该尝试发送一个包含非零返回码(表格中的某一个)的CONNACK报文. 如果服务端发送了一个包含非零返回码的CONNACK报文, 那么它<strong>必须</strong>关闭网络连接 [MQTT-3.2.2-5]..</p>
<h6 id="表格-3-1-–连接返回码的值"><a href="#表格-3-1-–连接返回码的值" class="headerlink" title="表格 3.1 –连接返回码的值"></a>表格 3.1 –连接返回码的值</h6><table>
<thead>
<tr>
<th align="left"><strong>值</strong></th>
<th align="left"><strong>返回码响应</strong></th>
<th align="left"><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">0</td>
<td align="left">0x00连接已接受</td>
<td align="left">连接已被服务端接受</td>
</tr>
<tr>
<td align="left">1</td>
<td align="left">0x01连接已拒绝, 不支持的协议版本</td>
<td align="left">服务端不支持客户端请求的MQTT协议级别</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">0x02连接已拒绝, 不合格的客户端标识符</td>
<td align="left">客户端标识符是正确的UTF-8编码, 但服务端不允许使用</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">0x03连接已拒绝, 服务端不可用</td>
<td align="left">网络连接已建立, 但MQTT服务不可用</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">0x04连接已拒绝, 无效的用户名或密码</td>
<td align="left">用户名或密码的数据格式无效</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left">0x05连接已拒绝, 未授权</td>
<td align="left">客户端未被授权连接到此服务器</td>
</tr>
<tr>
<td align="left">6-255</td>
<td align="left"></td>
<td align="left">保留</td>
</tr>
</tbody></table>
<p>如果认为上表中的所有连接返回码都不太合适, 那么服务端<strong>必须</strong>关闭网络连接, 不需要发送CONNACK报文 [MQTT-3.2.2-6].</p>
<h4 id="3-2-3-有效载荷"><a href="#3-2-3-有效载荷" class="headerlink" title="3.2.3 有效载荷"></a>3.2.3 有效载荷</h4><p>CONNACK报文没有有效载荷.</p>
<h3 id="3-3-PUBLISH-–-发布消息"><a href="#3-3-PUBLISH-–-发布消息" class="headerlink" title="3.3 PUBLISH – 发布消息"></a>3.3 PUBLISH – 发布消息</h3><p>PUBLISH控制报文是指从客户端向服务端或者服务端向客户端传输一个应用消息.</p>
<h4 id="3-3-1-固定报头"><a href="#3-3-1-固定报头" class="headerlink" title="3.3.1 固定报头"></a>3.3.1 固定报头</h4><p><a href="https://www.zybuluo.com/khan-lau/note/1326839#_图例_3.10_–" target="_blank" rel="noopener">图例 3.10 – PUBLISH报文固定报头</a>描述了固定报头的格式</p>
<h6 id="图例-3-10-–-PUBLISH报文固定报头"><a href="#图例-3-10-–-PUBLISH报文固定报头" class="headerlink" title="图例 3.10 – PUBLISH报文固定报头"></a>图例 3.10 – PUBLISH报文固定报头</h6><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>MQTT控制报文类型 (3)</td>
<td>DUP</td>
<td>QoS-H</td>
<td>QoS-</td>
<td>RETAIN</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td>byte 2…</td>
<td>剩余长度</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h5 id="重发标志-DUP"><a href="#重发标志-DUP" class="headerlink" title="重发标志 DUP"></a>重发标志 DUP</h5><p><strong>位置：</strong>第1个字节, 第3位</p>
<p>如果DUP标志被设置为0, 表示这是客户端或服务端第一次请求发送这个PUBLISH报文. 如果DUP标志被设置为1, 表示这可能是一个早前报文请求的重发.</p>
<p>客户端或服务端请求重发一个PUBLISH报文时, <strong>必须</strong>将DUP标志设置为1 [MQTT-3.3.1.-1].. 对于QoS 0的消息, DUP标志<strong>必须</strong>设置为0 [MQTT-3.3.1-2].</p>
<p>服务端发送PUBLISH报文给订阅者时, 收到(入站)的PUBLISH报文的DUP标志的值不会被传播. 发送(出站)的PUBLISH报文与收到(入站)的PUBLISH报文中的DUP标志是独立设置的, 它的值<strong>必须</strong>单独的根据发送(出站)的PUBLISH报文是否是一个重发来确定 [MQTT-3.3.1-3].</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>接收者收到一个DUP标志为1的控制报文时, 不能假设它看到了一个这个报文之前的一个副本.</p>
<p><strong>非规范评注</strong></p>
<p>需要特别指出的是, DUP标志关注的是控制报文本身, 与它包含的应用消息无关. 当使用QoS 1时, 客户端可能会收到一个DUP标志为0的PUBLISH报文, 这个报文包含一个它之前收到过的应用消息的副本, 但是用的是不同的报文标识符. 2.3.1节提供了有关报文标识符的更多信息.</p>
</blockquote>
<h5 id="服务质量等级-QoS"><a href="#服务质量等级-QoS" class="headerlink" title="服务质量等级 QoS"></a>服务质量等级 QoS</h5><p><strong>位置：</strong>第1个字节, 第2-1位.</p>
<p>这个字段表示应用消息分发的服务质量等级保证. 服务质量等级在 <a href="https://www.zybuluo.com/khan-lau/note/1326839#_表格_3.2_-服务质量定义" target="_blank" rel="noopener">表格 3.2 -服务质量定义</a> 中列出.</p>
<h6 id="表格-3-2-服务质量定义"><a href="#表格-3-2-服务质量定义" class="headerlink" title="表格 3.2 -服务质量定义"></a>表格 3.2 -服务质量定义</h6><table>
<thead>
<tr>
<th align="left"><strong>QoS值</strong></th>
<th align="left"><strong>Bit 2</strong></th>
<th align="left"><strong>Bit 1</strong></th>
<th align="left"><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">最多分发一次</td>
</tr>
<tr>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">至少分发一次</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">只分发一次</td>
</tr>
<tr>
<td align="left">-</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">保留位</td>
</tr>
</tbody></table>
<p>PUBLISH报文<strong>不能</strong>将QoS所有的位设置为1. 如果服务端或客户端收到QoS所有位都为1的PUBLISH报文, 它<strong>必须</strong>关闭网络连接 [MQTT-3.3.1-4].</p>
<h5 id="保留标志-RETAIN"><a href="#保留标志-RETAIN" class="headerlink" title="保留标志 RETAIN"></a>保留标志 RETAIN</h5><p><strong>位置：</strong>第1个字节, 第0位.</p>
<p>如果客户端发给服务端的PUBLISH报文的保留(RETAIN)标志被设置为1, 服务端<strong>必须</strong>存储这个应用消息和它的服务质量等级(QoS), 以便它可以被分发给未来的主题名匹配的订阅者 [MQTT-3.3.1-5]. 一个新的订阅建立时, 对每个匹配的主题名, 如果存在最近保留的消息, 它<strong>必须</strong>被发送给这个订阅者 [MQTT-3.3.1-6]. 如果服务端收到一条保留(RETAIN)标志为1的QoS 0消息, 它<strong>必须</strong>丢弃之前为那个主题保留的任何消息. 它<strong>应该</strong>将这个新的QoS 0消息当作那个主题的新保留消息, 但是任何时候都<strong>可以</strong>选择丢弃它 — 如果这种情况发生了, 那个主题将没有保留消息 [MQTT-3.3.1-7]. 有关存储状态的更多信息见 <a href="https://www.zybuluo.com/khan-lau/note/1326839#41-状态存储-storing-state" target="_blank" rel="noopener">4.1节</a>.</p>
<p>服务端发送PUBLISH报文给客户端时, 如果消息是作为客户端一个新订阅的结果发送, 它<strong>必须</strong>将报文的保留标志设为1 [MQTT-3.3.1-8]. 当一个PUBLISH报文发送给客户端是因为匹配一个已建立的订阅时, 服务端<strong>必须</strong>将保留标志设为0, 不管它收到的这个消息中保留标志的值是多少 [MQTT-3.3.1-9].</p>
<p>保留标志为1且有效载荷为零字节的PUBLISH报文会被服务端当作正常消息处理, 它会被发送给订阅主题匹配的客户端. 此外, 同一个主题下任何现存的保留消息必须被移除, 因此这个主题之后的任何订阅者都不会收到一个保留消息 [MQTT-3.3.1-10]. <em>当作正常</em> 意思是现存的客户端收到的消息中保留标志未被设置. 服务端<strong>不能</strong>存储零字节的保留消息 [MQTT-3.3.1-11].</p>
<p>如果客户端发给服务端的PUBLISH报文的保留标志位0, 服务端<strong>不能</strong>存储这个消息也<strong>不能</strong>移除或替换任何现存的保留消息 [MQTT-3.3.1-12].</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>对于发布者不定期发送状态消息这个场景, 保留消息很有用. 新的订阅者将会收到最近的状态.</p>
</blockquote>
<p><strong>剩余长度字段</strong></p>
<p>等于可变报头的长度加上有效载荷的长度.</p>
<h4 id="3-3-2-可变报头"><a href="#3-3-2-可变报头" class="headerlink" title="3.3.2 可变报头"></a>3.3.2 可变报头</h4><p>可变报头按顺序包含主题名和报文标识符.</p>
<h5 id="主题名-Topic-Name"><a href="#主题名-Topic-Name" class="headerlink" title="主题名 Topic Name"></a>主题名 Topic Name</h5><p>主题名(Topic Name)用于识别有效载荷数据应该被发布到哪一个信息通道.</p>
<p>主题名<strong>必须</strong>是PUBLISH报文可变报头的第一个字段. 它<strong>必须</strong>是 <a href="https://www.zybuluo.com/khan-lau/note/1326839#153-utf-8编码字符串-utf-8-encoded-strings" target="_blank" rel="noopener">1.5.3节</a>定义的UTF-8编码的字符串 [MQTT-3.3.2-1].</p>
<p>PUBLISH报文中的主题名<strong>不能</strong>包含通配符 [MQTT-3.3.2-2].</p>
<p>服务端发送给订阅客户端的PUBLISH报文的主题名<strong>必须</strong>匹配该订阅的主题过滤器(根据 4.7节定义的匹配过程)[MQTT-3.3.2-3].</p>
<h5 id="报文标识符-Packet-Identifier"><a href="#报文标识符-Packet-Identifier" class="headerlink" title="报文标识符 Packet Identifier"></a>报文标识符 Packet Identifier</h5><p>只有当QoS等级是1或2时, 报文标识符(Packet Identifier)字段才能出现在PUBLISH报文中. 2.3.1节提供了有关报文标识符的更多信息.</p>
<h5 id="可变报头非规范示例-1"><a href="#可变报头非规范示例-1" class="headerlink" title="可变报头非规范示例"></a>可变报头非规范示例</h5><p><a href="https://www.zybuluo.com/khan-lau/note/1326839#_Figure_3.11_-" target="_blank" rel="noopener">图例 3.11 – PUBLISH报文可变报头非规范示例</a> 举例说明了 <a href="https://www.zybuluo.com/khan-lau/note/1326839#_表格_3.3_-" target="_blank" rel="noopener">表格 3.3 - PUBLISH报文非规范示例</a> 中简要描述的PUBLISH报文的可变报头.</p>
<h6 id="表格-3-3-PUBLISH报文非规范示例"><a href="#表格-3-3-PUBLISH报文非规范示例" class="headerlink" title="表格 3.3 - PUBLISH报文非规范示例"></a>表格 3.3 - PUBLISH报文非规范示例</h6><table>
<thead>
<tr>
<th align="left"><strong>Field</strong></th>
<th align="left"><strong>Value</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">主题名</td>
<td align="left">a/b</td>
</tr>
<tr>
<td align="left">报文标识符</td>
<td align="left">10</td>
</tr>
</tbody></table>
<h6 id="图例-3-11-–-PUBLISH报文可变报头非规范示例"><a href="#图例-3-11-–-PUBLISH报文可变报头非规范示例" class="headerlink" title="图例 3.11 – PUBLISH报文可变报头非规范示例"></a>图例 3.11 – PUBLISH报文可变报头非规范示例</h6><table>
<thead>
<tr>
<th align="left"><strong>描述</strong></th>
<th align="left"><strong>7</strong></th>
<th align="left"><strong>6</strong></th>
<th align="left"><strong>5</strong></th>
<th align="left"><strong>4</strong></th>
<th align="left"><strong>3</strong></th>
<th align="left"><strong>2</strong></th>
<th align="left"><strong>1</strong></th>
<th align="left"><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">Topic Name 主题名</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">byte 1</td>
<td align="left">Length MSB (0)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 2</td>
<td align="left">Length LSB (3)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">byte 3</td>
<td align="left">‘a’ (0x61)</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 4</td>
<td align="left">‘/’ (0x2F)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">byte 5</td>
<td align="left">‘b’ (0x62)</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">报文标识符</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">byte 6</td>
<td align="left">报文标识符 MSB (0)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 7</td>
<td align="left">报文标识符 LSB (10)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
</tbody></table>
<p>示例中的主题名为 “a/b”, 长度等于3, 报文标识符为 “10”</p>
<h4 id="3-3-3-有效载荷"><a href="#3-3-3-有效载荷" class="headerlink" title="3.3.3 有效载荷"></a>3.3.3 有效载荷</h4><p>有效载荷包含将被发布的应用消息. 数据的内容和格式是应用特定的. 有效载荷的长度这样计算：用固定报头中的剩余长度字段的值减去可变报头的长度. 包含零长度有效载荷的PUBLISH报文是合法的.</p>
<h4 id="3-3-4-响应"><a href="#3-3-4-响应" class="headerlink" title="3.3.4 响应"></a>3.3.4 响应</h4><p>PUBLISH报文的接收者<strong>必须</strong>按照根据PUBLISH报文中的QoS等级发送响应, 见下面表格的描述 [MQTT-3.3.4-1].</p>
<h6 id="表格-3-4-–-PUBLISH报文的预期响应"><a href="#表格-3-4-–-PUBLISH报文的预期响应" class="headerlink" title="表格 3.4 – PUBLISH报文的预期响应"></a>表格 3.4 – PUBLISH报文的预期响应</h6><table>
<thead>
<tr>
<th align="left"><strong>服务质量等级</strong></th>
<th align="left"><strong>预期响应</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">QoS 0</td>
<td align="left">无响应</td>
</tr>
<tr>
<td align="left">QoS 1</td>
<td align="left">PUBACK报文</td>
</tr>
<tr>
<td align="left">QoS 2</td>
<td align="left">PUBREC报文</td>
</tr>
</tbody></table>
<h4 id="3-3-5-动作-Actions"><a href="#3-3-5-动作-Actions" class="headerlink" title="3.3.5 动作 Actions"></a>3.3.5 动作 Actions</h4><p>客户端使用PUBLISH报文发送应用消息给服务端, 目的是分发到其它订阅匹配的客户端.</p>
<p>服务端使用PUBLISH报文发送应用消息给每一个订阅匹配的客户端.</p>
<p>客户端使用带通配符的主题过滤器请求订阅时, 客户端的订阅可能会重复, 因此发布的消息可能会匹配多个过滤器. 对于这种情况, 服务端<strong>必须</strong>将消息分发给所有订阅匹配的QoS等级最高的客户端 [MQTT-3.3.5-1]. 服务端之后可以按照订阅的QoS等级, 分发消息的副本给每一个匹配的订阅者.</p>
<p>收到一个PUBLISH报文时, 接收者的动作取决于4.3节描述的QoS等级.</p>
<p>如果服务端实现不授权某个客户端发布PUBLISH报文, 它没有办法通知那个客户端. 它<strong>必须</strong>按照正常的QoS规则发送一个正面的确认, 或者关闭网络连接 [MQTT-3.3.5-2].</p>
<h3 id="3-4-PUBACK-–发布确认"><a href="#3-4-PUBACK-–发布确认" class="headerlink" title="3.4 PUBACK –发布确认"></a>3.4 PUBACK –发布确认</h3><p>PUBACK报文是对QoS 1等级的PUBLISH报文的响应.</p>
<h4 id="3-4-1-固定报头"><a href="#3-4-1-固定报头" class="headerlink" title="3.4.1 固定报头"></a>3.4.1 固定报头</h4><h6 id="图例-3-12-PUBACK报文固定报头"><a href="#图例-3-12-PUBACK报文固定报头" class="headerlink" title="图例 3.12 - PUBACK报文固定报头"></a>图例 3.12 - PUBACK报文固定报头</h6><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>MQTT报文类型 (4)</td>
<td>保留位</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>byte 2…</td>
<td>剩余长度</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
</tbody></table>
<p><strong>剩余长度字段</strong></p>
<p>表示可变报头的长度. 对PUBACK报文这个值等于2.</p>
<h4 id="3-4-2-可变报头"><a href="#3-4-2-可变报头" class="headerlink" title="3.4.2 可变报头"></a>3.4.2 可变报头</h4><p>包含等待确认的PUBLISH报文的报文标识符.</p>
<h6 id="图例-3-13-–-PUBACK报文可变报头"><a href="#图例-3-13-–-PUBACK报文可变报头" class="headerlink" title="图例 3.13 – PUBACK报文可变报头"></a>图例 3.13 – PUBACK报文可变报头</h6><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>报文标识符 MSB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte 2</td>
<td>报文标识符 LSB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="3-4-3-有效载荷"><a href="#3-4-3-有效载荷" class="headerlink" title="3.4.3 有效载荷"></a>3.4.3 有效载荷</h4><p>PUBACK报文没有有效载荷.</p>
<h4 id="3-4-4-动作"><a href="#3-4-4-动作" class="headerlink" title="3.4.4 动作"></a>3.4.4 动作</h4><p>完整的描述见 4.3.2节.</p>
<h3 id="3-5-PUBREC-–-发布收到-QoS-2-第一步"><a href="#3-5-PUBREC-–-发布收到-QoS-2-第一步" class="headerlink" title="3.5 PUBREC – 发布收到(QoS 2, 第一步)"></a>3.5 PUBREC – 发布收到(QoS 2, 第一步)</h3><p>PUBREC报文是对QoS等级2的PUBLISH报文的响应. 它是QoS 2等级协议交换的第二个报文.</p>
<h4 id="3-5-1-固定报头"><a href="#3-5-1-固定报头" class="headerlink" title="3.5.1 固定报头"></a>3.5.1 固定报头</h4><h6 id="图例-3-14-–-PUBREC报文固定报头"><a href="#图例-3-14-–-PUBREC报文固定报头" class="headerlink" title="图例 3.14 – PUBREC报文固定报头"></a>图例 3.14 – PUBREC报文固定报头</h6><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>MQTT控制报文类型 (5)</td>
<td>保留位</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>byte 2</td>
<td>剩余长度 (2)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
</tbody></table>
<p><strong>剩余长度字段</strong></p>
<p>表示可变报头的长度. 对PUBREC报文它的值等于2.</p>
<h4 id="3-5-2-可变报头"><a href="#3-5-2-可变报头" class="headerlink" title="3.5.2 可变报头"></a>3.5.2 可变报头</h4><p>可变报头包含等待确认的PUBLISH报文的报文标识符.</p>
<h6 id="图例-3-15-–-PUBREC报文可变报头"><a href="#图例-3-15-–-PUBREC报文可变报头" class="headerlink" title="图例 3.15 – PUBREC报文可变报头"></a>图例 3.15 – PUBREC报文可变报头</h6><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>报文标识符 MSB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte 2</td>
<td>报文标识符 LSB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="3-5-3-有效载荷"><a href="#3-5-3-有效载荷" class="headerlink" title="3.5.3 有效载荷"></a>3.5.3 有效载荷</h4><p>PUBREC报文没有有效载荷.</p>
<h4 id="3-5-4-动作"><a href="#3-5-4-动作" class="headerlink" title="3.5.4 动作"></a>3.5.4 动作</h4><p>完整的描述见 4.3.3节.</p>
<h3 id="3-6-PUBREL-–-发布释放-QoS-2-第二步"><a href="#3-6-PUBREL-–-发布释放-QoS-2-第二步" class="headerlink" title="3.6 PUBREL – 发布释放(QoS 2, 第二步)"></a>3.6 PUBREL – 发布释放(QoS 2, 第二步)</h3><p>PUBREL报文是对PUBREC报文的响应. 它是QoS 2等级协议交换的第三个报文.</p>
<h4 id="3-6-1-固定报头"><a href="#3-6-1-固定报头" class="headerlink" title="3.6.1 固定报头"></a>3.6.1 固定报头</h4><h6 id="图例-3-16-–-PUBREL报文固定报头"><a href="#图例-3-16-–-PUBREL报文固定报头" class="headerlink" title="图例 3.16 – PUBREL报文固定报头"></a>图例 3.16 – PUBREL报文固定报头</h6><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>MQTT控制报文类型 (6)</td>
<td>保留位</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>byte 2</td>
<td>剩余长度 (2)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
</tbody></table>
<p>PUBREL控制报文固定报头的第3,2,1,0位是保留位, <strong>必须</strong>被设置为0,0,1,0. 服务端<strong>必须</strong>将其它的任何值都当做是不合法的并关闭网络连接 [MQTT-3.6.1-1].</p>
<p><strong>剩余长度字段</strong></p>
<p>表示可变报头的长度. 对PUBREL报文这个值等于2.</p>
<h4 id="3-6-2-可变报头"><a href="#3-6-2-可变报头" class="headerlink" title="3.6.2 可变报头"></a>3.6.2 可变报头</h4><p>可变报头包含与等待确认的PUBREC报文相同的报文标识符.</p>
<h6 id="图例-3-17-–-PUBREL报文可变报头"><a href="#图例-3-17-–-PUBREL报文可变报头" class="headerlink" title="图例 3.17 – PUBREL报文可变报头"></a>图例 3.17 – PUBREL报文可变报头</h6><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>报文标识符 MSB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte 2</td>
<td>报文标识符 LSB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="3-6-3-有效载荷"><a href="#3-6-3-有效载荷" class="headerlink" title="3.6.3 有效载荷"></a>3.6.3 有效载荷</h4><p>PUBREL报文没有有效载荷.</p>
<h4 id="3-6-4-动作"><a href="#3-6-4-动作" class="headerlink" title="3.6.4 动作"></a>3.6.4 动作</h4><p>完整的描述见 4.3.3节.</p>
<h3 id="3-7-PUBCOMP-–-发布完成-QoS-2-第三步"><a href="#3-7-PUBCOMP-–-发布完成-QoS-2-第三步" class="headerlink" title="3.7 PUBCOMP – 发布完成(QoS 2, 第三步)"></a>3.7 PUBCOMP – 发布完成(QoS 2, 第三步)</h3><p>PUBCOMP报文是对PUBREL报文的响应. 它是QoS 2等级协议交换的第四个也是最后一个报文.</p>
<h4 id="3-7-1-固定报头"><a href="#3-7-1-固定报头" class="headerlink" title="3.7.1 固定报头"></a>3.7.1 固定报头</h4><h6 id="图例-3-18-–-PUBCOMP报文固定报头"><a href="#图例-3-18-–-PUBCOMP报文固定报头" class="headerlink" title="图例 3.18 – PUBCOMP报文固定报头"></a>图例 3.18 – PUBCOMP报文固定报头</h6><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>MQTT控制报文类型 (7)</td>
<td>保留位</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>byte 2</td>
<td>剩余长度 (2)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
</tbody></table>
<p><strong>剩余长度字段</strong></p>
<p>表示可变报头的长度. 对PUBCOMP报文这个值等于2.</p>
<h4 id="3-7-2-可变报头"><a href="#3-7-2-可变报头" class="headerlink" title="3.7.2 可变报头"></a>3.7.2 可变报头</h4><p>可变报头包含与等待确认的PUBREL报文相同的报文标识符.</p>
<h6 id="图例-3-19-–-PUBCOMP报文可变报头"><a href="#图例-3-19-–-PUBCOMP报文可变报头" class="headerlink" title="图例 3.19 – PUBCOMP报文可变报头"></a>图例 3.19 – PUBCOMP报文可变报头</h6><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>报文标识符 MSB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte 2</td>
<td>报文标识符 LSB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="3-7-3-有效载荷"><a href="#3-7-3-有效载荷" class="headerlink" title="3.7.3 有效载荷"></a>3.7.3 有效载荷</h4><p>PUBCOMP报文没有有效载荷.</p>
<h4 id="3-7-4-动作"><a href="#3-7-4-动作" class="headerlink" title="3.7.4 动作"></a>3.7.4 动作</h4><p>完整的描述见4.3.3节.</p>
<h3 id="3-8-SUBSCRIBE-订阅主题"><a href="#3-8-SUBSCRIBE-订阅主题" class="headerlink" title="3.8 SUBSCRIBE - 订阅主题"></a>3.8 SUBSCRIBE - 订阅主题</h3><p>客户端向服务端发送SUBSCRIBE报文用于创建一个或多个订阅. 每个订阅注册客户端关心的一个或多个主题. 为了将应用消息转发给与那些订阅匹配的主题, 服务端发送PUBLISH报文给客户端. SUBSCRIBE报文也(为每个订阅)指定了最大的QoS等级, 服务端根据这个发送应用消息给客户端.</p>
<h4 id="3-8-1-固定报头"><a href="#3-8-1-固定报头" class="headerlink" title="3.8.1 固定报头"></a>3.8.1 固定报头</h4><h6 id="图例-3-20-–-SUBSCRIBE报文固定报头"><a href="#图例-3-20-–-SUBSCRIBE报文固定报头" class="headerlink" title="图例 3.20 – SUBSCRIBE报文固定报头"></a>图例 3.20 – SUBSCRIBE报文固定报头</h6><table>
<thead>
<tr>
<th align="left"><strong>Bit</strong></th>
<th align="left"><strong>7</strong></th>
<th align="left"><strong>6</strong></th>
<th align="left"><strong>5</strong></th>
<th align="left"><strong>4</strong></th>
<th align="left"><strong>3</strong></th>
<th align="left"><strong>2</strong></th>
<th align="left"><strong>1</strong></th>
<th align="left"><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">byte 1</td>
<td align="left">MQTT控制报文类型 (8)</td>
<td align="left">保留位</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 2</td>
<td align="left">剩余长度</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>MQTT控制报文类型 (8)</td>
<td>保留位</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>byte 2</td>
<td>剩余长度</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>SUBSCRIBE控制报固定报头的第3,2,1,0位是保留位, <strong>必须</strong>分别设置为0,0,1,0. 服务端<strong>必须</strong>将其它的任何值都当做是不合法的并关闭网络连接 [MQTT-3.8.1-1].</p>
<p><strong>剩余长度字段</strong></p>
<p>等于可变报头的长度(2字节)加上有效载荷的长度.</p>
<h4 id="3-8-2可变报头"><a href="#3-8-2可变报头" class="headerlink" title="3.8.2可变报头"></a>3.8.2可变报头</h4><p>可变报头包含报文标识符. 2.3.1提供了有关报文标识符的更多信息.</p>
<h5 id="可变报头非规范示例-2"><a href="#可变报头非规范示例-2" class="headerlink" title="可变报头非规范示例"></a>可变报头非规范示例</h5><p><a href="https://www.zybuluo.com/khan-lau/note/1326839#_图例_3.21_–" target="_blank" rel="noopener">图例 3.21 – 报文标识符等于10的可变报头, 非规范示例</a> 展示了报文标识符设置为10时的可变报头.</p>
<h6 id="图例-3-21-–-报文标识符等于10的可变报头-非规范示例"><a href="#图例-3-21-–-报文标识符等于10的可变报头-非规范示例" class="headerlink" title="图例 3.21 – 报文标识符等于10的可变报头, 非规范示例"></a>图例 3.21 – 报文标识符等于10的可变报头, 非规范示例</h6><table>
<thead>
<tr>
<th align="left"><strong>描述</strong></th>
<th align="left"><strong>7</strong></th>
<th align="left"><strong>6</strong></th>
<th align="left"><strong>5</strong></th>
<th align="left"><strong>4</strong></th>
<th align="left"><strong>3</strong></th>
<th align="left"><strong>2</strong></th>
<th align="left"><strong>1</strong></th>
<th align="left"><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">报文标识符</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">byte 1</td>
<td align="left">报文标识符 MSB (0)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 2</td>
<td align="left">报文标识符 LSB (10)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
</tbody></table>
<h4 id="3-8-3-有效载荷"><a href="#3-8-3-有效载荷" class="headerlink" title="3.8.3 有效载荷"></a>3.8.3 有效载荷</h4><p>SUBSCRIBE报文的有效载荷包含了一个主题过滤器列表, 它们表示客户端想要订阅的主题. SUBSCRIBE报文有效载荷中的主题过滤器列表<strong>必须</strong>是<a href="https://www.zybuluo.com/khan-lau/note/1326839#153-utf-8编码字符串-utf-8-encoded-strings" target="_blank" rel="noopener">1.5.3节</a>定义的UTF-8字符串 [MQTT-3.8.3-1]. 服务端<strong>应该</strong>支持包含通配符( 4.7.1节 定义的)的主题过滤器. 如果服务端选择不支持包含通配符的主题过滤器, <strong>必须</strong>拒绝任何包含通配符过滤器的订阅请求 [MQTT-3.8.3-2]. 每一个过滤器后面跟着一个字节, 这个字节被叫做 服务质量要求(Requested QoS). 它给出了服务端向客户端发送应用消息所允许的最大QoS等级.</p>
<p>SUBSCRIBE报文的有效载荷<strong>必须</strong>包含至少一对主题过滤器 和 QoS等级字段组合. 没有有效载荷的SUBSCRIBE报文是违反协议的 [MQTT-3.8.3-3]. 有关错误处理的信息请查看<a href="https://www.zybuluo.com/khan-lau/note/1326839#48-错误处理-handling-errors" target="_blank" rel="noopener">4.8节</a>.</p>
<p>请求的最大服务质量等级字段编码为一个字节, 它后面跟着UTF-8编码的主题名, 那些主题过滤器 /和QoS等级组合是连续地打包.</p>
<h6 id="图例-3-22-–-SUBSCRIBE报文有效载荷格式"><a href="#图例-3-22-–-SUBSCRIBE报文有效载荷格式" class="headerlink" title="图例 3.22 – SUBSCRIBE报文有效载荷格式"></a>图例 3.22 – SUBSCRIBE报文有效载荷格式</h6><table>
<thead>
<tr>
<th align="left"><strong>描述</strong></th>
<th align="left"><strong>7</strong></th>
<th align="left"><strong>6</strong></th>
<th align="left"><strong>5</strong></th>
<th align="left"><strong>4</strong></th>
<th align="left"><strong>3</strong></th>
<th align="left"><strong>2</strong></th>
<th align="left"><strong>1</strong></th>
<th align="left"><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">主题过滤器</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">byte 1</td>
<td align="left">长度 MSB</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">byte 2</td>
<td align="left">长度 LSB</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">bytes 3..N</td>
<td align="left">主题过滤器(Topic Filter)</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">服务质量要求(Requested QoS)</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left">保留位</td>
<td align="left">服务质量等级</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">byte N+1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">X</td>
<td align="left">X</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th><strong>描述</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>主题过滤器</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte 1</td>
<td>长度 MSB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte 2</td>
<td>长度 LSB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte 3..N</td>
<td>主题过滤器(Topic Filter)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>服务质量要求(Requested QoS)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>保留位</td>
<td>服务质量等级</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte N+1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>X</td>
<td>X</td>
</tr>
</tbody></table>
<p>当前版本的协议没有用到服务质量要求(Requested QoS)字节的高六位. 如果有效载荷中的任何位是非零值, 或者QoS不等于0,1或2, 服务端<strong>必须</strong>认为SUBSCRIBE报文是不合法的并关闭网络连接 [MQTT-3-8.3-4].</p>
<h5 id="有效载荷非规范示例"><a href="#有效载荷非规范示例" class="headerlink" title="有效载荷非规范示例"></a>有效载荷非规范示例</h5><blockquote>
<p><a href="https://www.zybuluo.com/khan-lau/note/1326839#_Figure_3.23_-" target="_blank" rel="noopener">图例 3.23 – 有效载荷字节格式非规范示例</a> 展示了 <a href="https://www.zybuluo.com/khan-lau/note/1326839#_Table_3.4_-" target="_blank" rel="noopener">表格 3.5 – 有效载荷非规范示例</a> 中简略描述的SUBSCRIBE报文的有效载荷.</p>
</blockquote>
<h6 id="表格-3-5-–-有效载荷非规范示例"><a href="#表格-3-5-–-有效载荷非规范示例" class="headerlink" title="表格 3.5 – 有效载荷非规范示例"></a>表格 3.5 – 有效载荷非规范示例</h6><table>
<thead>
<tr>
<th align="left">主题名</th>
<th align="left">“a/b”</th>
</tr>
</thead>
<tbody><tr>
<td align="left">服务质量要求</td>
<td align="left">0x01</td>
</tr>
<tr>
<td align="left">主题名</td>
<td align="left">“c/d”</td>
</tr>
<tr>
<td align="left">服务质量要求</td>
<td align="left">0x02</td>
</tr>
</tbody></table>
<h6 id="图例-3-23-–-有效载荷字节格式非规范示例"><a href="#图例-3-23-–-有效载荷字节格式非规范示例" class="headerlink" title="图例 3.23 – 有效载荷字节格式非规范示例"></a>图例 3.23 – 有效载荷字节格式非规范示例</h6><table>
<thead>
<tr>
<th align="left"><strong>描述</strong></th>
<th align="left"><strong>7</strong></th>
<th align="left"><strong>6</strong></th>
<th align="left"><strong>5</strong></th>
<th align="left"><strong>4</strong></th>
<th align="left"><strong>3</strong></th>
<th align="left"><strong>2</strong></th>
<th align="left"><strong>1</strong></th>
<th align="left"><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">主题过滤器(Topic Filter)</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">byte 1</td>
<td align="left">Length MSB (0)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 2</td>
<td align="left">Length LSB (3)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">byte 3</td>
<td align="left">‘a’ (0x61)</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 4</td>
<td align="left">‘/’ (0x2F)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">byte 5</td>
<td align="left">‘b’ (0x62)</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">服务质量要求(Requested QoS)</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">byte 6</td>
<td align="left">Requested QoS(1)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">主题过滤器(Topic Filter)</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">byte 7</td>
<td align="left">Length MSB (0)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 8</td>
<td align="left">Length LSB (3)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">byte 9</td>
<td align="left">‘c’ (0x63)</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">byte 10</td>
<td align="left">‘/’ (0x2F)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">byte 11</td>
<td align="left">‘d’ (0x64)</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">服务质量要求(Requested QoS)</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">byte 12</td>
<td align="left">Requested QoS(2)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
</tbody></table>
<h4 id="3-8-4-响应"><a href="#3-8-4-响应" class="headerlink" title="3.8.4 响应"></a>3.8.4 响应</h4><p>服务端收到客户端发送的一个SUBSCRIBE报文时, <strong>必须</strong>使用SUBACK报文响应 [MQTT-3.8.4-1]. SUBACK报文<strong>必须</strong>和等待确认的SUBSCRIBE报文有相同的报文标识符 [MQTT-3.8.4-2].</p>
<p>允许服务端在发送SUBACK报文之前就开始发送与订阅匹配的PUBLISH报文.</p>
<p>如果服务端收到一个SUBSCRIBE报文, 报文的主题过滤器与一个现存订阅的主题过滤器相同, 那么<strong>必须</strong>使用新的订阅彻底替换现存的订阅. 新订阅的主题过滤器和之前订阅的相同, 但是它的最大QoS值可以不同. 与这个主题过滤器匹配的任何现存的保留消息<strong>必须</strong>被重发, 但是发布流程<strong>不能</strong>中断 <a href="https://tools.oasis-open.org/issues/browse/MQTT-3" target="_blank" rel="noopener">MQTT-3</a>.8.4-3].</p>
<p>如果主题过滤器不同于任何现存订阅的过滤器, 服务端会创建一个新的订阅并发送所有匹配的保留消息.</p>
<p>如果服务端收到包含多个主题过滤器的SUBSCRIBE报文, 它<strong>必须</strong>如同收到了一系列的多个SUBSCRIBE报文一样处理那个, 除了需要将它们的响应合并到一个单独的SUBACK报文发送 [MQTT-3.8.4-4].</p>
<p>服务端发送给客户端的SUBACK报文对每一对主题过滤器 和QoS等级都<strong>必须</strong>包含一个返回码. 这个返回码<strong>必须</strong>表示那个订阅被授予的最大QoS等级, 或者表示这个订阅失败 <a href="https://tools.oasis-open.org/issues/browse/MQTT-3" target="_blank" rel="noopener">MQTT-3</a>.8.4-5]. 服务端可以授予比订阅者要求的低一些的QoS等级. 为响应订阅而发出的消息的有效载荷的QoS<strong>必须</strong>是原始发布消息的QoS和服务端授予的QoS两者中的最小值. 如果原始消息的QoS是1而被授予的最大QoS是0, 允许服务端重复发送一个消息的副本给订阅者 <a href="https://tools.oasis-open.org/issues/browse/MQTT-3" target="_blank" rel="noopener">MQTT-3</a>.8.4-6].</p>
<blockquote>
<p><strong>非规范示例</strong><br>对某个特定的主题过滤器, 如果正在订阅的客户端被授予的最大QoS等级是1, 那么匹配这个过滤器的QoS等级0的应用消息会按QoS等级0分发给这个客户端. 这意味着客户端最多收到这个消息的一个副本. 从另一方面说, 发布给同一主题的QoS等级2的消息会被服务端降级到QoS等级1再分发给客户端, 因此客户端可能会收到重复的消息副本.</p>
<p>如果正在订阅的客户端被授予的最大QoS等级是0, 那么原来按QoS等级2发布给客户端的应用消息在繁忙时可能会丢失, 但是服务端不应该发送重复的消息副本. 发布给同一主题的 QoS等级1的消息在传输给客户端时可能会丢失或重复.</p>
<p><strong>非规范评注</strong></p>
<p>使用QoS等级2订阅一个主题过滤器等于是说：<em>我想要按照它们发布时的QoS等级接受匹配这个过滤器的消息</em> . 这意味着, 确定消息分发时可能的最大QoS等级是发布者的责任, 而订阅者可以要求服务端降低QoS到更适合它的等级.</p>
</blockquote>
<h3 id="3-9-SUBACK-–-订阅确认"><a href="#3-9-SUBACK-–-订阅确认" class="headerlink" title="3.9 SUBACK – 订阅确认"></a>3.9 SUBACK – 订阅确认</h3><p>服务端发送SUBACK报文给客户端, 用于确认它已收到并且正在处理SUBSCRIBE报文.</p>
<p>SUBACK报文包含一个返回码清单, 它们指定了SUBSCRIBE请求的每个订阅被授予的最大QoS等级.</p>
<h4 id="3-9-1-固定报头"><a href="#3-9-1-固定报头" class="headerlink" title="3.9.1 固定报头"></a>3.9.1 固定报头</h4><h6 id="图例-3-24-–-SUBACK报文固定报头"><a href="#图例-3-24-–-SUBACK报文固定报头" class="headerlink" title="图例 3.24 – SUBACK报文固定报头"></a>图例 3.24 – SUBACK报文固定报头</h6><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>MQTT控制报文类型 (9)</td>
<td>保留位</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>byte 2</td>
<td>剩余长度</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>剩余长度字段</strong></p>
<p>等于可变报头的长度加上有效载荷的长度.</p>
<h4 id="3-9-2-可变报头"><a href="#3-9-2-可变报头" class="headerlink" title="3.9.2 可变报头"></a>3.9.2 可变报头</h4><p>可变报头包含等待确认的SUBSCRIBE报文的报文标识符. <a href="https://www.zybuluo.com/khan-lau/note/1326839#_图例_3.25_–" target="_blank" rel="noopener">图例 3.25 – SUBACK报文可变报头</a> 描述了可变报头的格式.</p>
<h6 id="图例-3-25-–-SUBACK报文可变报头"><a href="#图例-3-25-–-SUBACK报文可变报头" class="headerlink" title="图例 3.25 – SUBACK报文可变报头"></a>图例 3.25 – SUBACK报文可变报头</h6><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>报文标识符 MSB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte 2</td>
<td>报文标识符 LSB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="3-9-3-有效载荷"><a href="#3-9-3-有效载荷" class="headerlink" title="3.9.3 有效载荷"></a>3.9.3 有效载荷</h4><p>有效载荷包含一个返回码清单. 每个返回码对应等待确认的SUBSCRIBE报文中的一个主题过滤器. 返回码的顺序<strong>必须</strong>和SUBSCRIBE报文中主题过滤器的顺序相同 [MQTT-3.9.3-1].</p>
<p><a href="https://www.zybuluo.com/khan-lau/note/1326839#_Figure_3.26_-" target="_blank" rel="noopener">图例 3.26 – SUBACK报文有效载荷格式</a> 描述了有效载荷中单字节编码的返回码字段.</p>
<h6 id="图例-3-26-–-SUBACK报文有效载荷格式"><a href="#图例-3-26-–-SUBACK报文有效载荷格式" class="headerlink" title="图例 3.26 – SUBACK报文有效载荷格式"></a>图例 3.26 – SUBACK报文有效载荷格式</h6><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>返回码</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte 1</td>
<td>X</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>X</td>
<td>X</td>
</tr>
</tbody></table>
<p>允许的返回码值：</p>
<ul>
<li>0x00 - 最大QoS 0</li>
<li>0x01 - 成功 – 最大QoS 1</li>
<li>0x02 - 成功 – 最大 QoS 2</li>
<li>0x80 - Failure 失败</li>
</ul>
<p>0x00, 0x01, 0x02, 0x80之外的SUBACK返回码是保留的, <strong>不能</strong>使用[MQTT-3.9.3-2].</p>
<h5 id="有效载荷非规范示例-1"><a href="#有效载荷非规范示例-1" class="headerlink" title="有效载荷非规范示例"></a>有效载荷非规范示例</h5><blockquote>
<p><a href="https://www.zybuluo.com/khan-lau/note/1326839#_Figure_3.27_-" target="_blank" rel="noopener">图例 3.27 -有效载荷字节格式非规范示例</a> 展示了在 <a href="https://www.zybuluo.com/khan-lau/note/1326839#_Table_3.5_-" target="_blank" rel="noopener">表格 3.6 -有效载荷非规范示例</a> 简要描述的SUBACK报文的有效载荷.</p>
</blockquote>
<h6 id="表格-3-6-有效载荷非规范示例"><a href="#表格-3-6-有效载荷非规范示例" class="headerlink" title="表格 3.6 -有效载荷非规范示例"></a>表格 3.6 -有效载荷非规范示例</h6><table>
<thead>
<tr>
<th align="left">Success - Maximum QoS 0</th>
<th align="left">0</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Success - Maximum QoS 2</td>
<td align="left">2</td>
</tr>
<tr>
<td align="left">Failure</td>
<td align="left">128</td>
</tr>
</tbody></table>
<h6 id="图例-3-27-有效载荷字节格式非规范示例"><a href="#图例-3-27-有效载荷字节格式非规范示例" class="headerlink" title="图例 3.27 -有效载荷字节格式非规范示例"></a>图例 3.27 -有效载荷字节格式非规范示例</h6><table>
<thead>
<tr>
<th align="left"><strong>描述</strong></th>
<th align="left"><strong>7</strong></th>
<th align="left"><strong>6</strong></th>
<th align="left"><strong>5</strong></th>
<th align="left"><strong>4</strong></th>
<th align="left"><strong>3</strong></th>
<th align="left"><strong>2</strong></th>
<th align="left"><strong>1</strong></th>
<th align="left"><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">byte 1</td>
<td align="left">Success - Maximum QoS 0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 2</td>
<td align="left">Success - Maximum QoS 2</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">byte 3</td>
<td align="left">Failure</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
</tbody></table>
<h3 id="3-10-UNSUBSCRIBE-–取消订阅"><a href="#3-10-UNSUBSCRIBE-–取消订阅" class="headerlink" title="3.10 UNSUBSCRIBE –取消订阅"></a>3.10 UNSUBSCRIBE –取消订阅</h3><p>客户端发送UNSUBSCRIBE报文给服务端, 用于取消订阅主题.</p>
<h4 id="3-10-1-固定报头"><a href="#3-10-1-固定报头" class="headerlink" title="3.10.1 固定报头"></a>3.10.1 固定报头</h4><h6 id="图例-3-28-–-UNSUBSCRIBE报文固定报头"><a href="#图例-3-28-–-UNSUBSCRIBE报文固定报头" class="headerlink" title="图例 3.28 – UNSUBSCRIBE报文固定报头"></a>图例 3.28 – UNSUBSCRIBE报文固定报头</h6><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>MQTT控制报文类型 (10)</td>
<td>保留位</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>byte 2</td>
<td>剩余长度</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>UNSUBSCRIBE报文固定报头的第3,2,1,0位是保留位且<strong>必须</strong>分别设置为0,0,1,0. 服务端<strong>必须</strong>认为任何其它的值都是不合法的并关闭网络连接 [MQTT-3.10.1-1].</p>
<p><strong>剩余长度字段</strong></p>
<p>等于可变报头的长度加上有效载荷的长度.</p>
<h4 id="3-10-2-可变报头"><a href="#3-10-2-可变报头" class="headerlink" title="3.10.2 可变报头"></a>3.10.2 可变报头</h4><p>可变报头包含一个报文标识符. 2.3.1节提供了有关报文标识符的更多信息.</p>
<h6 id="图例-3-29-–-UNSUBSCRIBE报文可变报头"><a href="#图例-3-29-–-UNSUBSCRIBE报文可变报头" class="headerlink" title="图例 3.29 – UNSUBSCRIBE报文可变报头"></a>图例 3.29 – UNSUBSCRIBE报文可变报头</h6><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>报文标识符 MSB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte 2</td>
<td>报文标识符 LSB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="3-10-3-有效载荷"><a href="#3-10-3-有效载荷" class="headerlink" title="3.10.3 有效载荷"></a>3.10.3 有效载荷</h4><p>UNSUBSCRIBE报文的有效载荷包含客户端想要取消订阅的主题过滤器列表. UNSUBSCRIBE报文中的主题过滤器<strong>必须</strong>是连续打包的、按照<a href="https://www.zybuluo.com/khan-lau/note/1326839#153-utf-8编码字符串-utf-8-encoded-strings" target="_blank" rel="noopener">1.5.3节</a>定义的UTF-8编码字符串 [MQTT-3.10.3-1].</p>
<p>UNSUBSCRIBE报文的有效载荷<strong>必须</strong>至少包含一个消息过滤器. 没有有效载荷的UNSUBSCRIBE报文是违反协议的 [MQTT-3.10.3-2]. 有关错误处理的更多信息请查看<a href="https://www.zybuluo.com/khan-lau/note/1326839#48-错误处理-handling-errors" target="_blank" rel="noopener">4.8节</a>.</p>
<h5 id="有效载荷非规范示例-2"><a href="#有效载荷非规范示例-2" class="headerlink" title="有效载荷非规范示例"></a>有效载荷非规范示例</h5><blockquote>
<p><a href="https://www.zybuluo.com/khan-lau/note/1326839#_Figure_3.30_-" target="_blank" rel="noopener">图例 3.30 -有效载荷字节格式非规范示例</a> 展示了 <a href="https://www.zybuluo.com/khan-lau/note/1326839#_Table3.6_-_Payload" target="_blank" rel="noopener">表格 3.7 -有效载荷非规范示例</a> 简要描述的UNSUBSCRIBE报文的有效载荷.</p>
</blockquote>
<h6 id="表格-3-7-有效载荷非规范示例"><a href="#表格-3-7-有效载荷非规范示例" class="headerlink" title="表格 3.7 -有效载荷非规范示例"></a>表格 3.7 -有效载荷非规范示例</h6><table>
<thead>
<tr>
<th align="left">主题过滤器</th>
<th align="left">“a/b”</th>
</tr>
</thead>
<tbody><tr>
<td align="left">主题过滤器</td>
<td align="left">“c/d”</td>
</tr>
</tbody></table>
<h6 id="图例-3-30-有效载荷字节格式非规范示例"><a href="#图例-3-30-有效载荷字节格式非规范示例" class="headerlink" title="图例 3.30 -有效载荷字节格式非规范示例"></a>图例 3.30 -有效载荷字节格式非规范示例</h6><table>
<thead>
<tr>
<th align="left"><strong>描述</strong></th>
<th align="left"><strong>7</strong></th>
<th align="left"><strong>6</strong></th>
<th align="left"><strong>5</strong></th>
<th align="left"><strong>4</strong></th>
<th align="left"><strong>3</strong></th>
<th align="left"><strong>2</strong></th>
<th align="left"><strong>1</strong></th>
<th align="left"><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">主题过滤器</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">byte 1</td>
<td align="left">Length MSB (0)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 2</td>
<td align="left">Length LSB (3)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">byte 3</td>
<td align="left">‘a’ (0x61)</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 4</td>
<td align="left">‘/’ (0x2F)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">byte 5</td>
<td align="left">‘b’ (0x62)</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">主题过滤器</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">byte 6</td>
<td align="left">Length MSB (0)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 7</td>
<td align="left">Length LSB (3)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">byte 8</td>
<td align="left">‘c’ (0x63)</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">byte 9</td>
<td align="left">‘/’ (0x2F)</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">byte 10</td>
<td align="left">‘d’ (0x64)</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
</tbody></table>
<h4 id="3-10-4-响应"><a href="#3-10-4-响应" class="headerlink" title="3.10.4 响应"></a>3.10.4 响应</h4><p>UNSUBSCRIBE报文提供的主题过滤器(无论是否包含通配符)<strong>必须</strong>与服务端持有的这个客户端的当前主题过滤器集合逐个字符比较. 如果有任何过滤器完全匹配, 那么它(服务端)自己的订阅将被删除, 否则不会有进一步的处理 [MQTT-3.10.4-1].</p>
<p>如果服务端删除了一个订阅：</p>
<ul>
<li>它<strong>必须</strong>停止分发任何新消息给这个客户端 [MQTT-3.10.4-2].</li>
<li>它<strong>必须</strong>完成分发任何已经开始往客户端发送的QoS 1和QoS 2的消息 [MQTT-3.10.4-3].</li>
<li>它<strong>可以</strong>继续发送任何现存的准备分发给客户端的缓存消息.</li>
</ul>
<p>服务端<strong>必须</strong>发送UNSUBACK报文响应客户端的UNSUBSCRIBE请求. UNSUBACK报文<strong>必须</strong>包含和UNSUBSCRIBE报文相同的报文标识符 [MQTT-3.10.4-4]. 即使没有删除任何主题订阅, 服务端也<strong>必须</strong>发送一个UNSUBACK响应 [MQTT-3.10.4-5].</p>
<p>如果服务端收到包含多个主题过滤器的UNSUBSCRIBE报文, 它<strong>必须</strong>如同收到了一系列的多个UNSUBSCRIBE报文一样处理那个报文, 除了将它们的响应合并到一个单独的UNSUBACK报文外. [MQTT-3.10.4-6].</p>
<h3 id="3-11-UNSUBACK-–-取消订阅确认"><a href="#3-11-UNSUBACK-–-取消订阅确认" class="headerlink" title="3.11 UNSUBACK – 取消订阅确认"></a>3.11 UNSUBACK – 取消订阅确认</h3><p>服务端发送UNSUBACK报文给客户端用于确认收到UNSUBSCRIBE报文.</p>
<h4 id="3-11-1-固定报头"><a href="#3-11-1-固定报头" class="headerlink" title="3.11.1 固定报头"></a>3.11.1 固定报头</h4><h6 id="图例-3-31-–-UNSUBACK报文固定报头"><a href="#图例-3-31-–-UNSUBACK报文固定报头" class="headerlink" title="图例 3.31 – UNSUBACK报文固定报头"></a>图例 3.31 – UNSUBACK报文固定报头</h6><table>
<thead>
<tr>
<th align="left"><strong>Bit</strong></th>
<th align="left"><strong>7</strong></th>
<th align="left"><strong>6</strong></th>
<th align="left"><strong>5</strong></th>
<th align="left"><strong>4</strong></th>
<th align="left"><strong>3</strong></th>
<th align="left"><strong>2</strong></th>
<th align="left"><strong>1</strong></th>
<th align="left"><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">byte 1</td>
<td align="left">MQTT控制报文类型 (11)</td>
<td align="left">保留位</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 2</td>
<td align="left">剩余长度 (2)</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>MQTT控制报文类型 (11)</td>
<td>保留位</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>byte 2</td>
<td>剩余长度 (2)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
</tbody></table>
<p><strong>剩余长度字段</strong></p>
<p>表示可变报头的长度, 对UNSUBACK报文这个值等于2.</p>
<h4 id="3-11-2-可变报头"><a href="#3-11-2-可变报头" class="headerlink" title="3.11.2 可变报头"></a>3.11.2 可变报头</h4><p>可变报头包含等待确认的UNSUBSCRIBE报文的报文标识符.</p>
<h6 id="图例-3-32-–-UNSUBACK报文可变报头"><a href="#图例-3-32-–-UNSUBACK报文可变报头" class="headerlink" title="图例 3.32 – UNSUBACK报文可变报头"></a>图例 3.32 – UNSUBACK报文可变报头</h6><table>
<thead>
<tr>
<th align="left"><strong>Bit</strong></th>
<th align="left"><strong>7</strong></th>
<th align="left"><strong>6</strong></th>
<th align="left"><strong>5</strong></th>
<th align="left"><strong>4</strong></th>
<th align="left"><strong>3</strong></th>
<th align="left"><strong>2</strong></th>
<th align="left"><strong>1</strong></th>
<th align="left"><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">byte 1</td>
<td align="left">报文标识符 MSB</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">byte 2</td>
<td align="left">报文标识符 LSB</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>报文标识符 MSB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>byte 2</td>
<td>报文标识符 LSB</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="3-11-3-有效载荷"><a href="#3-11-3-有效载荷" class="headerlink" title="3.11.3 有效载荷"></a>3.11.3 有效载荷</h4><p>UNSUBACK报文没有有效载荷.</p>
<h3 id="3-12-PINGREQ-–-心跳请求"><a href="#3-12-PINGREQ-–-心跳请求" class="headerlink" title="3.12 PINGREQ – 心跳请求"></a>3.12 PINGREQ – 心跳请求</h3><p>客户端发送PINGREQ报文给服务端的. 用于：</p>
<ol>
<li>在没有任何其它控制报文从客户端发给服务的时, 告知服务端客户端还活着.</li>
<li>请求服务端发送 响应确认它还活着.</li>
<li>使用网络以确认网络连接没有断开.</li>
</ol>
<p>保持连接(Keep Alive)处理中用到这个报文, 详细信息请查看 3.1.2.10节.</p>
<h4 id="3-12-1-固定报头"><a href="#3-12-1-固定报头" class="headerlink" title="3.12.1 固定报头"></a>3.12.1 固定报头</h4><h6 id="图例-3-33-–-PINGREQ报文固定报头"><a href="#图例-3-33-–-PINGREQ报文固定报头" class="headerlink" title="图例 3.33 – PINGREQ报文固定报头"></a>图例 3.33 – PINGREQ报文固定报头</h6><table>
<thead>
<tr>
<th align="left"><strong>Bit</strong></th>
<th align="left"><strong>7</strong></th>
<th align="left"><strong>6</strong></th>
<th align="left"><strong>5</strong></th>
<th align="left"><strong>4</strong></th>
<th align="left"><strong>3</strong></th>
<th align="left"><strong>2</strong></th>
<th align="left"><strong>1</strong></th>
<th align="left"><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">byte 1</td>
<td align="left">MQTT控制报文类型 (12)</td>
<td align="left">保留位</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left">1</td>
<td align="left">1</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">byte 2</td>
<td align="left">剩余长度 (0)</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">0</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>MQTT控制报文类型 (12)</td>
<td>保留位</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>byte 2</td>
<td>剩余长度 (0)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody></table>
<h4 id="3-12-2-可变报头"><a href="#3-12-2-可变报头" class="headerlink" title="3.12.2 可变报头"></a>3.12.2 可变报头</h4><p>PINGREQ报文没有可变报头.</p>
<h4 id="3-12-3-有效载荷"><a href="#3-12-3-有效载荷" class="headerlink" title="3.12.3 有效载荷"></a>3.12.3 有效载荷</h4><p>PINGREQ报文没有有效载荷.</p>
<h4 id="3-12-4-响应"><a href="#3-12-4-响应" class="headerlink" title="3.12.4 响应"></a>3.12.4 响应</h4><p>服务端<strong>必须</strong>发送 PINGRESP报文响应客户端的PINGREQ报文 [MQTT-3.12.4-1].</p>
<h3 id="3-13-PINGRESP-–-心跳响应"><a href="#3-13-PINGRESP-–-心跳响应" class="headerlink" title="3.13 PINGRESP – 心跳响应"></a>3.13 PINGRESP – 心跳响应</h3><p>服务端发送PINGRESP报文响应客户端的PINGREQ报文. 表示服务端还活着.</p>
<p>保持连接(Keep Alive)处理中用到这个报文, 详情请查看 3.1.2.10节.</p>
<h4 id="3-13-1-固定报头"><a href="#3-13-1-固定报头" class="headerlink" title="3.13.1 固定报头"></a>3.13.1 固定报头</h4><h6 id="图例-3-34-–-PINGRESP报文固定报头"><a href="#图例-3-34-–-PINGRESP报文固定报头" class="headerlink" title="图例 3.34 – PINGRESP报文固定报头"></a>图例 3.34 – PINGRESP报文固定报头</h6><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>MQTT控制报文类型 (13)</td>
<td>保留位</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>byte 2</td>
<td>剩余长度 (0)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody></table>
<h4 id="3-13-2-可变报头"><a href="#3-13-2-可变报头" class="headerlink" title="3.13.2 可变报头"></a>3.13.2 可变报头</h4><p>PINGRESP报文没有可变报头.</p>
<h4 id="3-13-3-有效载荷"><a href="#3-13-3-有效载荷" class="headerlink" title="3.13.3 有效载荷"></a>3.13.3 有效载荷</h4><p>PINGRESP报文没有有效载荷.</p>
<h3 id="3-14-DISCONNECT-–断开连接"><a href="#3-14-DISCONNECT-–断开连接" class="headerlink" title="3.14 DISCONNECT –断开连接"></a>3.14 DISCONNECT –断开连接</h3><p>DISCONNECT报文是客户端发给服务端的最后一个控制报文. 表示客户端正常断开连接.</p>
<h4 id="3-14-1-固定报头"><a href="#3-14-1-固定报头" class="headerlink" title="3.14.1 固定报头"></a>3.14.1 固定报头</h4><h6 id="图例-3-35-–-DISCONNECT报文固定报头"><a href="#图例-3-35-–-DISCONNECT报文固定报头" class="headerlink" title="图例 3.35 – DISCONNECT报文固定报头"></a>图例 3.35 – DISCONNECT报文固定报头</h6><table>
<thead>
<tr>
<th><strong>Bit</strong></th>
<th><strong>7</strong></th>
<th><strong>6</strong></th>
<th><strong>5</strong></th>
<th><strong>4</strong></th>
<th><strong>3</strong></th>
<th><strong>2</strong></th>
<th><strong>1</strong></th>
<th><strong>0</strong></th>
</tr>
</thead>
<tbody><tr>
<td>byte 1</td>
<td>MQTT控制报文类型 (14)</td>
<td>保留位</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>byte 2</td>
<td>剩余长度 (0)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody></table>
<p>服务端<strong>必须</strong>验证所有的保留位都被设置为0, 如果它们不为0<strong>必须</strong>断开连接 [MQTT-3.14.1-1].</p>
<h4 id="3-14-2-可变报头"><a href="#3-14-2-可变报头" class="headerlink" title="3.14.2 可变报头"></a>3.14.2 可变报头</h4><p>DISCONNECT报文没有可变报头.</p>
<h4 id="3-14-3-有效载荷"><a href="#3-14-3-有效载荷" class="headerlink" title="3.14.3 有效载荷"></a>3.14.3 有效载荷</h4><p>DISCONNECT报文没有有效载荷.</p>
<h4 id="3-14-4-响应"><a href="#3-14-4-响应" class="headerlink" title="3.14.4 响应"></a>3.14.4 响应</h4><p>客户端发送DISCONNECT报文之后：</p>
<ul>
<li><strong>必须</strong>关闭网络连接 [MQTT-3.14.4-1].</li>
<li><strong>不能</strong>通过那个网络连接再发送任何控制报文 [MQTT-3.14.4-2].</li>
</ul>
<p>服务端在收到DISCONNECT报文时：</p>
<ul>
<li><strong>必须</strong>丢弃任何与当前连接关联的未发布的遗嘱消息, 具体描述见 3.1.2.5节 [MQTT-3.14.4-3].</li>
<li><strong>应该</strong>关闭网络连接, 如果客户端 还没有这么做.</li>
</ul>
<h2 id="第四章-操作行为-Operational-behavior"><a href="#第四章-操作行为-Operational-behavior" class="headerlink" title="第四章 操作行为 Operational behavior"></a>第四章 操作行为 Operational behavior</h2><h3 id="4-1-状态存储-Storing-state"><a href="#4-1-状态存储-Storing-state" class="headerlink" title="4.1 状态存储 Storing state"></a>4.1 状态存储 Storing state</h3><p>为了提供服务质量保证, 客户端和服务端有必要存储会话状态. 在整个会话期间, 客户端和服务端都<strong>必须</strong>存储会话状态 [MQTT-4.1.0-1]. 会话<strong>必须</strong>至少持续和它的活跃网络连接同样长的时间 [MQTT-4.1.0-2].</p>
<p>服务端的保留消息不是会话状态的组成部分. 服务端<strong>应该</strong>保留那种消息直到客户端删除它.</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>客户端和服务端实现的存储容量必然是有限的, 还可能要受管理策略的限制, 比如跨网络连接的会话状态的最大存储时间. 已保存的会话状态丢失可能是某个管理操作造成的, 例如对某个预定义条件的自动响应. 它造成的后果就是会话终止. 这些操作可能是资源限制或其他操作原因引发的. 需要谨慎的评估客户端和服务端的存储容量, 以确保存储空间够用.</p>
<p><strong>非规范评注</strong></p>
<p>客户端或服务端的软硬件故障都可能导致会话状态的丢失或损坏.</p>
<p><strong>非规范评注</strong></p>
<p>服务器和客户端操作正常可能意味着, 已保存的状态丢失或损坏是管理操作或软硬件故障造成的. 管理操作可能是对某个预定义条件的自动响应. 这些操作可能是资源限制或其他操作原因引发的. 例如, 服务端可能会基于外部条件, 决定不再将某个消息或某些消息分发给任何当前的或以后的客户端.</p>
<p><strong>非规范评注</strong></p>
<p>MQTT用户应该评估MQTT客户端和服务端实现的存储容量, 确保能满足需求.</p>
</blockquote>
<h5 id="非规范示例"><a href="#非规范示例" class="headerlink" title="非规范示例"></a>非规范示例</h5><p>例如, 想要收集电表读数的用户可能会决定使用QoS 1等级的消息, 因为他们不能接受数据在网络传输途中丢失, 但是, 他们可能认为客户端和服务端的数据可以存储在内存(易失性存储器)中, 因为(他们觉得)电力供应是非常可靠的, 不会有太大的数据丢失风险.</p>
<p>与之相反, 停车计费支付应用的提供商可能决定任何情况下都不能让数据支付消息丢失, 因此他们要求在通过网络传输之前, 所有的数据必须写入到非易失性存储器中(如硬盘).</p>
<h3 id="4-2-网络连接-Network-Connections"><a href="#4-2-网络连接-Network-Connections" class="headerlink" title="4.2 网络连接 Network Connections"></a>4.2 网络连接 Network Connections</h3><p>MQTT协议要求基础传输层能够提供有序的、可靠的、双向传输(从客户端到服务端 和从服务端到客户端)的字节流.</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>MQTT 3.1使用的传输层协议是 <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC793" target="_blank" rel="noopener">RFC793</a>] 定义的TCP/IP协议. 下面的协议也支持：</p>
</blockquote>
<ul>
<li>TLS协议 <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC5246" target="_blank" rel="noopener">[RFC5246]</a></li>
<li>WebSocket协议 <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC6455" target="_blank" rel="noopener">[RFC6455]</a></li>
</ul>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>TCP端口8883和1883已在IANA注册, 分别用于MQTT的TLS和非TLS通信.</p>
</blockquote>
<p>无连接的网络传输协议如UDP是不支持的, 因为他们可能会丢失数据包或对数据包重排序.</p>
<h3 id="4-3-服务质量等级和协议流程-QoS"><a href="#4-3-服务质量等级和协议流程-QoS" class="headerlink" title="4.3 服务质量等级和协议流程 QoS"></a>4.3 服务质量等级和协议流程 QoS</h3><p>MQTT按照这里定义的服务质量 (QoS) 等级分发应用消息. 分发协议是对称的, 在下面的描述中, 客户端和服务端既可以是发送者也可以是接收者. 分发协议关注的是从单个发送者到单个接收者的应用消息. 服务端分发应用消息给多个客户端时, 每个客户端独立处理. 分发给客户端的出站应用消息和入站应用消息的QoS等级可能是不同的.</p>
<p>下面的非规范流程图展示了可能的实现方法.</p>
<h4 id="4-3-1-QoS-0-最多分发一次"><a href="#4-3-1-QoS-0-最多分发一次" class="headerlink" title="4.3.1 QoS 0:最多分发一次"></a>4.3.1 QoS 0:最多分发一次</h4><p>消息的分发依赖于底层网络的能力. 接收者不会发送响应, 发送者也不会重试. 消息可能送达一次也可能根本没送达.</p>
<p>对于QoS 0的分发协议, 发送者</p>
<ul>
<li><strong>必须</strong>发送QoS等于0, DUP等于0的PUBLISH报文 [MQTT-4.3.1-1].</li>
</ul>
<p>对于QoS 0的分发协议, 接收者</p>
<ul>
<li>接受PUBLISH报文时同时接受消息的所有权.</li>
</ul>
<h6 id="图例-4-1-–-QoS-0协议流程图-非规范示例"><a href="#图例-4-1-–-QoS-0协议流程图-非规范示例" class="headerlink" title="图例 4.1 – QoS 0协议流程图, 非规范示例"></a>图例 4.1 – QoS 0协议流程图, 非规范示例</h6><table>
<thead>
<tr>
<th align="left"><strong>发送者动作</strong></th>
<th align="left"><strong>控制报文</strong></th>
<th align="left"><strong>接收者动作</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">PUBLISH 报文 QoS 0, DUP=0</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left">———-&gt;</td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left">分发应用消息给适当的后续接收者(们)</td>
</tr>
</tbody></table>
<h4 id="4-3-2-QoS-1-至少分发一次"><a href="#4-3-2-QoS-1-至少分发一次" class="headerlink" title="4.3.2 QoS 1: 至少分发一次"></a>4.3.2 QoS 1: 至少分发一次</h4><p>服务质量确保消息至少送达一次. QoS 1的PUBLISH报文的可变报头中包含一个报文标识符, 需要PUBACK报文确认. 2.3.1节提供了有关报文标识符的更多信息.</p>
<p>对于QoS 1的分发协议, 发送者</p>
<ul>
<li>每次发送新的应用消息都<strong>必须</strong>分配一个未使用的报文标识符.</li>
<li>发送的PUBLISH报文<strong>必须</strong>包含报文标识符且QoS等于1, DUP等于0.</li>
<li><strong>必须</strong>将这个PUBLISH报文看作是 <em>未确认的</em> , 直到从接收者那收到对应的PUBACK报文. 4.4节有一个关于未确认消息的讨论.</li>
</ul>
<blockquote>
<p>[MQTT-4.3.2-1].</p>
<p>一旦发送者收到PUBACK报文, 这个报文标识符就可以重用.</p>
</blockquote>
<p>注意：允许发送者在等待确认时使用不同的报文标识符发送后续的PUBLISH报文.</p>
<p>对于QoS 1的分发协议, 接收者</p>
<ul>
<li>响应的PUBACK报文<strong>必须</strong>包含一个报文标识符, 这个标识符来自接收到的、已经接受所有权的PUBLISH报文.</li>
<li>发送了PUBACK报文之后, 接收者必须将任何包含相同报文标识符的入站PUBLISH报文当作一个新的消息, 并忽略它的DUP标志的值.</li>
</ul>
<blockquote>
<p>[MQTT-4.3.2-2].</p>
</blockquote>
<h6 id="图例-4-2-–-QoS-1协议流程图-非规范示例"><a href="#图例-4-2-–-QoS-1协议流程图-非规范示例" class="headerlink" title="图例 4.2 – QoS 1协议流程图, 非规范示例"></a>图例 4.2 – QoS 1协议流程图, 非规范示例</h6><table>
<thead>
<tr>
<th align="left"><strong>发送者动作</strong></th>
<th align="left"><strong>控制报文</strong></th>
<th align="left"><strong>接收者动作</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">存储消息</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">发送PUBLISH报文 QoS=1, DUP=0, 带报文标识符</td>
<td align="left">———-&gt;</td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left">开始应用消息的后续分发1</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">&lt;———-</td>
<td align="left">发送PUBACK报文, 带报文标识符</td>
</tr>
<tr>
<td align="left">丢弃消息</td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<blockquote>
<p>1不要求接收者在发送PUBACK之前完整分发应用消息. 原来的发送者收到PUBACK报文之后, 应用消息的所有权就会转移给这个接收者.</p>
</blockquote>
<h4 id="4-3-3-QoS-2-仅分发一次"><a href="#4-3-3-QoS-2-仅分发一次" class="headerlink" title="4.3.3 QoS 2: 仅分发一次"></a>4.3.3 QoS 2: 仅分发一次</h4><p>这是最高等级的服务质量, 消息丢失和重复都是不可接受的. 使用这个服务质量等级会有额外的开销.</p>
<p>QoS 2的消息可变报头中有报文标识符. 2.3.1节提供了有关报文标识符的更多信息. QoS 2的PUBLISH报文的接收者使用一个两步确认过程来确认收到.</p>
<p>对于QoS 2的分发协议, 发送者</p>
<ul>
<li>必须给要发送的新应用消息分配一个未使用的报文标识符.</li>
<li>发送的PUBLISH报文<strong>必须</strong>包含报文标识符且报文的QoS等于2,, DUP等于0.</li>
<li><strong>必须</strong>将这个PUBLISH报文看作是 <em>未确认的</em> , 直到从接收者那收到对应的PUBREC报文. 4.4节有一个关于未确认消息的讨论.</li>
<li>收到PUBREC报文后<strong>必须</strong>发送一个PUBREL报文. PUBREL报文必须包含与原始PUBLISH报文相同的报文标识符.</li>
<li><strong>必须</strong>将这个PUBREL报文看作是 <em>未确认的</em> , 直到从接收者那收到对应的PUBCOMP报文.</li>
<li>一旦发送了对应的PUBREL报文就<strong>不能</strong>重发这个PUBLISH报文.</li>
</ul>
<p>[MQTT-4.3.3-1].</p>
<blockquote>
<p>一旦发送者收到PUBCOMP报文, 这个报文标识符就可以重用.</p>
</blockquote>
<p>注意：允许发送者在等待确认时使用不同的报文标识符发送后续的PUBLISH报文.</p>
<p>对于QoS 2的分发协议, 接收者</p>
<ul>
<li>响应的PUBREC报文<strong>必须</strong>包含报文标识符, 这个标识符来自接收到的、已经接受所有权的PUBLISH报文.</li>
<li>在收到对应的PUBREL报文之前, 接收者<strong>必须</strong>发送PUBREC报文确认任何后续的具有相同标识符的PUBLISH报文. 在这种情况下, 它<strong>不能</strong>重复分发消息给任何后续的接收者.</li>
<li>响应PUBREL报文的PUBCOMP报文<strong>必须</strong>包含与PUBREL报文相同的标识符.</li>
<li>发送PUBCOMP报文之后, 接收者必须将包含相同报文标识符的任何后续PUBLISH报文当作一个新的发布.</li>
</ul>
<p>[MQTT-4.3.3-2].</p>
<h6 id="图例-4-3-–-QoS-2协议流程图-非规范示例"><a href="#图例-4-3-–-QoS-2协议流程图-非规范示例" class="headerlink" title="图例 4.3 – QoS 2协议流程图, 非规范示例"></a>图例 4.3 – QoS 2协议流程图, 非规范示例</h6><table>
<thead>
<tr>
<th align="left"><strong>发送者动作</strong></th>
<th align="left"><strong>控制报文</strong></th>
<th align="left"><strong>接收者动作</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">存储消息</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">发送PUBLISH报文, QoS=2, DUP=0, 带报文标识符</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left">———-&gt;</td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left">方法A：存储消息, 或方法B：存储报文标识符, 然后开始向前分发这个应用消息1.</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left">发送PUBREC报文, 带报文标识符.</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">&lt;———-</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">丢弃消息, 存储PUBREC中的报文标识符</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">发送PUBREL报文, 带报文标识符</td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left">———-&gt;</td>
<td align="left"></td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left">方法A：开始向前分发应用消息1然后丢弃消息 或方法B：丢弃报文标识符</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left">发送PUBCOMP报文, 带报文标识符</td>
</tr>
<tr>
<td align="left"></td>
<td align="left">&lt;———-</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">丢弃已保存的状态</td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<blockquote>
<p>1 不要求接收者在发送PUBREC或PUBCOMP之前完整分发应用消息. 原来的发送者收到PUBREC报文之后, 应用消息的所有权就会转移给这个接收者.</p>
<p><a href="https://www.zybuluo.com/khan-lau/note/1326839#_Figure_4.3_–" target="_blank" rel="noopener">图例 4.3 – QoS 2协议流程图, 非规范示例</a> 展示了接收者对QoS 2等级消息的两种处理方法. 他们的区别是消息什么时候可以开始分发. 实现者可以决定使用哪种方法. 只要实现者只选择了一种方法, 就不会影响QoS流程的可靠性.</p>
</blockquote>
<h3 id="4-4-消息分发重试-Message-delivery-retry"><a href="#4-4-消息分发重试-Message-delivery-retry" class="headerlink" title="4.4 消息分发重试 Message delivery retry"></a>4.4 消息分发重试 Message delivery retry</h3><p>客户端设置清理会话(CleanSession)标志为0重连时, 客户端和服务端<strong>必须</strong>使用原始的报文标识符重发任何未确认的PUBLISH报文(如果QoS&gt;0)和PUBREL报文 [MQTT-4.4.0-1]. 这是唯一<strong>要求</strong>客户端或服务端重发消息的情况.</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>控制报文的重发曾经需要克服某些陈旧TCP网络上的数据丢失问题. 部署在那些环境中的MQTT 3.1.1实现可能仍然需要关注这个问题.</p>
</blockquote>
<h3 id="4-5-消息收到-Message-receipt"><a href="#4-5-消息收到-Message-receipt" class="headerlink" title="4.5 消息收到 Message receipt"></a>4.5 消息收到 Message receipt</h3><p>服务端接管入站应用消息的所有权时, 它<strong>必须</strong>将消息添加到订阅匹配的客户端的会话状态中. 匹配规则定义见 4.7节 [MQTT-4.5.0-1].</p>
<p>正常情况下, 客户端收到发送给它的订阅的消息. 客户端也可能收到不是与它的订阅精确匹配的消息. 如果服务端自动给客户端分配了一个订阅, 可能发生这种情况. 正在处理UBSUBSCRIBE请求时也可能收到消息. 客户端<strong>必须</strong>按照可用的服务质量(QoS)规则确认它收到的任何PUBLISH报文, 不管它选择是否处理报文包含的应用消息 [MQTT-4.5.0-2].</p>
<h3 id="4-6-消息排序-Message-ordering"><a href="#4-6-消息排序-Message-ordering" class="headerlink" title="4.6 消息排序 Message ordering"></a>4.6 消息排序 Message ordering</h3><p>实现本章定义的协议流程时, 客户端<strong>必须</strong>遵循下列规则：</p>
<ul>
<li>重发任何之前的PUBLISH报文时, <strong>必须</strong>按原始PUBLISH报文的发送顺序重发(适用于QoS 1和QoS 2消息)[MQTT-4.6.0-1].</li>
<li><strong>必须</strong>按照对应的PUBLISH报文的顺序发送PUBACK报文(QoS 1消息)[MQTT-4.6.0-2].</li>
<li><strong>必须</strong>按照对应的PUBLISH报文的顺序发送PUBREC报文(QoS 2消息)[MQTT-4.6.0-3].</li>
<li><strong>必须</strong>按照对应的PUBREC报文的顺序发送PUBREL报文(QoS 2消息)[MQTT-4.6.0-4].</li>
</ul>
<p>服务端<strong>必须</strong>默认认为每个主题都是有序的. 它<strong>可以</strong>提供一个管理功能或其它机制, 以允许将一个或多个主题当作是无序的 [MQTT-4.6.0-5].</p>
<p>服务端处理发送给有序主题的消息时, <strong>必须</strong>按照上面的规则将消息分发给每个订阅者. 此外, 它<strong>必须</strong>按照从客户端收到的顺序发送PUBLISH报文给消费者(对相同的主题和QoS)[MQTT-4.6.0-6].</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>上面列出的规则确保, 使用QoS 1发布和订阅的消息流, 订阅者按照消息发布时的顺序收到每条消息的最终副本, 但是消息可能会重复, 这可能导致在它的后继消息之后收到某个已经收到消息的重发版本. 例如, 发布者按顺序1,2,3,4发送消息, 订阅者收到的顺序可能是1,2,3,2,3,4.</p>
<p>如果客户端和服务端能保证任何时刻最多有一条消息在 <em>传输中(in-flight)</em>(在某条消息被确认前不发送后面的那条消息), 那么, 不会有QoS 1的消息会在它的任何后续消息之后收到. 例如, 订阅者收到的顺序可能是1,2,3,3,4, 而不是1,2,3,2,3,4. 将传输窗口 (in-flight window)设为1意味着, 在同一个主题上, 即使发布者发送了一系列不同QoS等级的消息, 它们的顺序也被保留.</p>
</blockquote>
<h3 id="4-7-主题名和主题过滤器-Topic-Names-and-Topic-Filters"><a href="#4-7-主题名和主题过滤器-Topic-Names-and-Topic-Filters" class="headerlink" title="4.7 主题名和主题过滤器 Topic Names and Topic Filters"></a>4.7 主题名和主题过滤器 Topic Names and Topic Filters</h3><h4 id="4-7-1-主题通配符-Topic-wildcards"><a href="#4-7-1-主题通配符-Topic-wildcards" class="headerlink" title="4.7.1 主题通配符 Topic wildcards"></a>4.7.1 主题通配符 Topic wildcards</h4><p>主题层级(topic level)分隔符用于将结构化引入主题名. 如果存在分隔符, 它将主题名分割为多个<em>主题层级 topic level</em> .</p>
<p>订阅的主题过滤器可以包含特殊的通配符, 允许你一次订阅多个主题.</p>
<p>主题过滤器中可以使用通配符, 但是主题名<strong>不能</strong>使用通配符 [MQTT-4.7.1-1].</p>
<h5 id="主题层级分隔符-Topic-level-separator"><a href="#主题层级分隔符-Topic-level-separator" class="headerlink" title="主题层级分隔符 Topic level separator"></a>主题层级分隔符 Topic level separator</h5><p>斜杠(‘/’ U+002F)用于分割主题的每个层级, 为主题名提供一个分层结构. 当客户端订阅指定的主题过滤器包含两种通配符时, 主题层级分隔符就很有用了. 主题层级分隔符可以出现在主题过滤器或主题名字的任何位置. 相邻的主题层次分隔符表示一个零长度的主题层级.</p>
<h5 id="多层通配符-Multi-level-wildcard"><a href="#多层通配符-Multi-level-wildcard" class="headerlink" title="多层通配符 Multi-level wildcard"></a>多层通配符 Multi-level wildcard</h5><p>数字标志(‘#’ U+0023)是用于匹配主题中任意层级的通配符. 多层通配符表示它的父级和任意数量的子层级. 多层通配符必须位于它自己的层级或者跟在主题层级分隔符后面. 不管哪种情况, 它都<strong>必须</strong>是主题过滤器的最后一个字符 [MQTT-4.7.1-2].</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>例如, 如果客户端订阅主题 “sport/tennis/player1/#”, 它会收到使用下列主题名发布的消息：</p>
</blockquote>
<ul>
<li>“sport/tennis/player1”</li>
<li>“sport/tennis/player1/ranking”</li>
<li>“sport/tennis/player1/score/wimbledon”</li>
</ul>
<blockquote>
<p><strong>非规范评注</strong></p>
</blockquote>
<ul>
<li>“sport/#”也匹配单独的 “sport” , 因为 # 包括它的父级.</li>
<li>“#”是有效的, 会收到所有的应用消息.</li>
<li>“sport/tennis/#”也是有效的.</li>
<li>“sport/tennis#”是无效的.</li>
<li>“sport/tennis/#/ranking”是无效的.</li>
</ul>
<h5 id="单层通配符"><a href="#单层通配符" class="headerlink" title="单层通配符"></a>单层通配符</h5><p>加号 (‘+’ U+002B) 是只能用于单个主题层级匹配的通配符.</p>
<p>在主题过滤器的任意层级都可以使用单层通配符, 包括第一个和最后一个层级. 然而它<strong>必须</strong>占据过滤器的整个层级 [MQTT-4.7.1-3]. 可以在主题过滤器中的多个层级中使用它, 也可以和多层通配符一起使用.</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>例如, “sport/tennis/+” 匹配 “sport/tennis/player1” 和 “sport/tennis/player2” , 但是不匹配 “sport/tennis/player1/ranking” . 同时, 由于单层通配符只能匹配一个层级, “sport/+” 不匹配 “sport” 但是却匹配 “sport/”.</p>
<p><strong>非规范评注</strong></p>
</blockquote>
<ul>
<li>“+” 是有效的.</li>
<li>“+/tennis/#” 是有效的.</li>
<li>“sport+” 是无效的.</li>
<li>“sport/+/player1” 也是有效的.</li>
<li>“/finance” 匹配 “+/+” 和 “/+” , 但是不匹配 “+”.</li>
</ul>
<h4 id="4-7-2-以-开头的主题-Topics-beginning-with"><a href="#4-7-2-以-开头的主题-Topics-beginning-with" class="headerlink" title="4.7.2 以$开头的主题 Topics beginning with $"></a>4.7.2 以$开头的主题 Topics beginning with $</h4><p>服务端<strong>不能</strong>将 字符开头的主题名匹配通配符或开头的主题过滤器服务端应该阻止客户端使用这种主题名与其它客户端交换消息服务端实现可以将 开头的主题名用作其他目的.</p>
<blockquote>
<p><strong>非规范评注</strong></p>
</blockquote>
<ul>
<li>被广泛用作包含服务器特定信息或控制接口的主题的前缀应用不能使用 字符开头的主题.</li>
</ul>
<blockquote>
<p><strong>非规范评注</strong></p>
</blockquote>
<ul>
<li>订阅 “#” 的客户端不会收到任何发布到以 “开头主题的消息订阅的客户端不会收到任何发布到SYS/monitor/Clients” 的消息.</li>
<li>订阅 “的客户端会收到发布到以SYS/” 开头主题的消息.</li>
<li>订阅 “的客户端会收到发布到SYS/monitor/Clients” 主题的消息.</li>
<li>如果客户端想同时接受以 “开头主题的消息和不以 开头主题的消息, 它需要同时订阅 “#” 和 ““$SYS/#”.</li>
</ul>
<h4 id="4-7-3-主题语义和用法-Topic-semantic-and-usage"><a href="#4-7-3-主题语义和用法-Topic-semantic-and-usage" class="headerlink" title="4.7.3 主题语义和用法 Topic semantic and usage"></a>4.7.3 主题语义和用法 Topic semantic and usage</h4><p>主题名和主题过滤器必须符合下列规则：</p>
<ul>
<li>所有的主题名和主题过滤器<strong>必须</strong>至少包含一个字符 [MQTT-4.7.3-1].</li>
<li>主题名和主题过滤器是区分大小写的.</li>
<li>主题名和主题过滤器可以包含空格.</li>
<li>主题名或主题过滤器以前置或后置斜杠 “/” 区分.</li>
<li>只包含斜杠 “/” 的主题名或主题过滤器是合法的.</li>
<li>主题名和主题过滤器<strong>不能</strong>包含空字符 (Unicode U+0000) <a href="https://www.zybuluo.com/khan-lau/note/1326839#Unicode" target="_blank" rel="noopener">Unicode</a>] [MQTT-4.7.3-2].</li>
<li>主题名和主题过滤器是UTF-8编码字符串, 它们<strong>不能</strong>超过65535字节 [MQTT-4.7.3-3]. 见 <a href="https://www.zybuluo.com/khan-lau/note/1326839#153-utf-8编码字符串-utf-8-encoded-strings" target="_blank" rel="noopener">1.5.3节</a>.</li>
</ul>
<p>除了不能超过UTF-编码字符串的长度限制之外, 主题名或主题过滤器的层级数量没有其它限制.</p>
<p>匹配订阅时, 服务端<strong>不能</strong>对主题名或主题过滤器执行任何规范化(normalization)处理, 不能修改或替换任何未识别的字符 [MQTT-4.7.3-4]. 主题过滤器中的每个非通配符层级需要逐字符匹配主题名中对应的层级才算匹配成功.</p>
<blockquote>
<p><strong>非规范评注</strong></p>
<p>使用UTF-8编码规则意味着, 主题过滤器和主题名的比较可以通过比较编码后的UTF-8字节或解码后的Unicode字符.</p>
<p><strong>非规范评注</strong></p>
</blockquote>
<ul>
<li>“ACCOUNTS” 和 “Accounts” 是不同的主题名.</li>
<li>“Accounts payable” 是合法的主题名</li>
<li>“/finance” 和 “finance” 是不同的.</li>
</ul>
<p>如果订阅的主题过滤器与消息的主题名匹配, 应用消息会被发送给每一个匹配的客户端订阅. 主题可能是管理员在服务端预先定义好的, 也可能是服务端收到第一个订阅或使用那个主题名的应用消息时动态添加的. 服务端也可以使用一个安全组件有选择地授权客户端使用某个主题资源.</p>
<h3 id="4-8-错误处理-Handling-errors"><a href="#4-8-错误处理-Handling-errors" class="headerlink" title="4.8 错误处理 Handling errors"></a>4.8 错误处理 Handling errors</h3><p>除非另有说明, 如果服务端或客户端遇到了协议违规的行为, 它<strong>必须</strong>关闭传输这个协议违规控制报文的网络连接 [MQTT-4.8.0-1].</p>
<p>客户端或服务端实现可能会遇到瞬时错误(Transient Error)(例如内部缓冲区满了的情况)导致无法成功处理MQTT报文.</p>
<p>如果客户端或服务端处理入站控制报文时遇到了瞬时错误, 它<strong>必须</strong>关闭传输那个控制报文的网络连接 [MQTT-4.8.0-2]. 如果服务端发现了瞬时错误, 它<strong>不应该</strong>断开连接或者执行任何对其它客户端有影响的操作.</p>
<h2 id="第五章-安全"><a href="#第五章-安全" class="headerlink" title="第五章 安全"></a>第五章 安全</h2><h3 id="5-1-概述"><a href="#5-1-概述" class="headerlink" title="5.1 概述"></a>5.1 概述</h3><p>本章的内容仅供参考, 是非规范化的. 然而, 强烈推荐提供TLS的服务端实现<strong>应该</strong>使用TCP端口8883(IANA服务名：secure-mqtt).</p>
<p>解决方案提供者需要考虑很多风险. 例如：</p>
<ul>
<li>设备可能会被盗用</li>
<li>客户端和服务端的静态数据可能是可访问的(可能会被修改)</li>
<li>协议行为可能有副作用(如计时器攻击)</li>
<li>拒绝服务攻击</li>
<li>通信可能会被拦截、修改、重定向或者泄露</li>
<li>虚假控制报文注入</li>
</ul>
<p>MQTT方案通常部署在不安全的通信环境中. 在这种情况下, 协议实现通常需要提供这些机制：</p>
<ul>
<li>用户和设备身份认证</li>
<li>服务端资源访问授权</li>
<li>MQTT控制报文和内嵌应用数据的完整性校验</li>
<li>MQTT控制报文和内嵌应用数据的隐私控制</li>
</ul>
<p>作为传输层协议, MQTT仅关注消息传输, 提供合适的安全功能是实现者的责任. 使用TLS <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC5246" target="_blank" rel="noopener">[RFC5246]</a> 是比较普遍的选择. 除了技术上的安全问题外, 还有地理因素(例如美国欧盟安全港原则 <a href="https://www.zybuluo.com/khan-lau/note/1326839#USEUSAFEHARB" target="_blank" rel="noopener">[USEUSAFEHARB]</a>), 行业标准(例如第三方支付行业数据安全标准 <a href="https://www.zybuluo.com/khan-lau/note/1326839#PCIDSS" target="_blank" rel="noopener">[PCIDSS]</a>), 监管方面的考虑(例如萨班斯-奥克斯利法案 <a href="https://www.zybuluo.com/khan-lau/note/1326839#SARBANES" target="_blank" rel="noopener">[SARBANES]</a>)等问题.</p>
<h3 id="5-2-MQTT解决方案：安全和认证"><a href="#5-2-MQTT解决方案：安全和认证" class="headerlink" title="5.2 MQTT解决方案：安全和认证"></a>5.2 MQTT解决方案：安全和认证</h3><p>MQTT solutions: security and certification</p>
<p>协议实现可能想要符合特定的工业安全标准, 如NIST网络安全框架 [NISTCSF]](#NISTCSF) , 第三方支付行业数据安全标准 <a href="https://www.zybuluo.com/khan-lau/note/1326839#PCIDSS" target="_blank" rel="noopener">[PCIDSS]</a> , 美国联邦信息处理标准 <a href="https://www.zybuluo.com/khan-lau/note/1326839#FIPS1402" target="_blank" rel="noopener">[FIPS1402]</a> 和 NSA 加密组合B <a href="https://www.zybuluo.com/khan-lau/note/1326839#NSAB" target="_blank" rel="noopener">NSAB</a>] .</p>
<p>在MQTT的补充出版物 (MQTT and the NIST Framework for Improving Critical Infrastructure Cybersecurity <a href="https://www.zybuluo.com/khan-lau/note/1326839#NISTCSF" target="_blank" rel="noopener">[MQTT NIST]</a>) 中可以找到在NIST网络安全框架 [NISTCSF]](#NISTCSF) 中使用MQTT的指导. 使用行业证明、独立审计和认证技术有助于满足合规要求.</p>
<h3 id="5-3-轻量级的加密与受限设备"><a href="#5-3-轻量级的加密与受限设备" class="headerlink" title="5.3 轻量级的加密与受限设备"></a>5.3 轻量级的加密与受限设备</h3><p>Lightweight cryptography and constrained devices</p>
<p>广泛采用高级加密标准 <a href="https://www.zybuluo.com/khan-lau/note/1326839#AES" target="_blank" rel="noopener">[AES]</a> 数据加密标准 <a href="https://www.zybuluo.com/khan-lau/note/1326839#DES" target="_blank" rel="noopener">[DES]</a> .</p>
<p>推荐使用为受限的低端设备特别优化过的轻量级加密国际标准 ISO 29192 <a href="https://www.zybuluo.com/khan-lau/note/1326839#ISO29192" target="_blank" rel="noopener">[ISO29192]</a> .</p>
<h3 id="5-4-实现注意事项-Implementation-notes"><a href="#5-4-实现注意事项-Implementation-notes" class="headerlink" title="5.4 实现注意事项 Implementation notes"></a>5.4 实现注意事项 Implementation notes</h3><p>实现和使用MQTT时需要考虑许多安全问题. 下面的部分不应该被当作是一个 核对清单 .</p>
<p>协议实现可以实现下面的一部分或全部：</p>
<h4 id="5-4-1-客户端身份验证-Authentication-of-Clients-by-the-Server"><a href="#5-4-1-客户端身份验证-Authentication-of-Clients-by-the-Server" class="headerlink" title="5.4.1 客户端身份验证 Authentication of Clients by the Server"></a>5.4.1 客户端身份验证 Authentication of Clients by the Server</h4><p>CONNECT报文包含用户名和密码字段. 实现可以决定如何使用这些字段的内容. 实现者可以提供自己的身份验证机制, 或者使用外部的认证系统如LDAP <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC4511" target="_blank" rel="noopener">[RFC4511]</a> 或OAuth <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC6749" target="_blank" rel="noopener">[RFC6749]</a> , 还可以利用操作系统的认证机制.</p>
<p>实现可以明文传递认证数据, 混淆那些数据, 或者不要求任何认证数据, 但应该意识到这会增加中间人攻击和重放攻击的风险. 5.4.5节介绍了确保数据私密的方法.</p>
<p>在客户端和服务端之间使用虚拟专用网(VPN)可以确保数据只被授权的客户端收到.</p>
<p>使用TLS <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC5246" target="_blank" rel="noopener">[RFC5246]</a> 时, 服务端可以使用客户端发送的SSL证书验证客户端的身份.</p>
<p>实现可以允许客户端通过应用消息给服务端发送凭证用于身份验证.</p>
<h3 id="5-4-2-客户端授权-Authorization-of-Clients-by-the-Server"><a href="#5-4-2-客户端授权-Authorization-of-Clients-by-the-Server" class="headerlink" title="5.4.2 客户端授权 Authorization of Clients by the Server"></a>5.4.2 客户端授权 Authorization of Clients by the Server</h3><p>基于客户端提供的信息如用户名、客户端标识符(ClientId)、客户端的主机名或IP地址, 或者身份认证的结果, 服务端可以限制对某些服务端资源的访问.</p>
<h4 id="5-4-3-服务端身份验证-Authentication-of-the-Server-by-the-Client"><a href="#5-4-3-服务端身份验证-Authentication-of-the-Server-by-the-Client" class="headerlink" title="5.4.3 服务端身份验证 Authentication of the Server by the Client"></a>5.4.3 服务端身份验证 Authentication of the Server by the Client</h4><p>MQTT协议不是双向信任的, 它没有提供客户端验证服务端身份的机制.</p>
<p>但是使用TLS <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC5246" target="_blank" rel="noopener">[RFC5246]</a> 时, 客户端可以使用服务端发送的SSL证书验证服务端的身份. 从单IP多域名提供MQTT服务的实现应该考虑RFC6066 <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC6066" target="_blank" rel="noopener">[RFC6066]</a> 第3节定义的TLS的SNI扩展. SNI允许客户端告诉服务端它要连接的服务端主机名.</p>
<p>实现可以允许服务端通过应用消息给客户端发送凭证用于身份验证.</p>
<p>在客户端和服务端之间使用虚拟专用网(VPN)可以确保客户端连接的是预期的服务器.</p>
<h4 id="5-4-4-控制报文和应用消息的完整性-Integrity-of-Application-Messages-and-Control-Packets"><a href="#5-4-4-控制报文和应用消息的完整性-Integrity-of-Application-Messages-and-Control-Packets" class="headerlink" title="5.4.4 控制报文和应用消息的完整性 Integrity of Application Messages and Control Packets"></a>5.4.4 控制报文和应用消息的完整性 Integrity of Application Messages and Control Packets</h4><p>应用可以在应用消息中单独包含哈希值. 这样做可以为PUBLISH控制报文的网络传输和静态数据提供内容的完整性检查.</p>
<p>TLS <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC5246" target="_blank" rel="noopener">[RFC5246]</a> 提供了对网络传输的数据做完整性校验的哈希算法.</p>
<p>在客户端和服务端之间使用虚拟专用网(VPN)连接可以在VPN覆盖的网络段提供数据完整性检查.</p>
<h4 id="5-4-5-控制报文和应用消息的保密性-Privacy-of-Application-Messages-and-Control-Packets"><a href="#5-4-5-控制报文和应用消息的保密性-Privacy-of-Application-Messages-and-Control-Packets" class="headerlink" title="5.4.5 控制报文和应用消息的保密性 Privacy of Application Messages and Control Packets"></a>5.4.5 控制报文和应用消息的保密性 Privacy of Application Messages and Control Packets</h4><p>TLS <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC5246" target="_blank" rel="noopener">[RFC5246]</a> 可以对网络传输的数据加密. 如果有效的TLS密码组合包含的加密算法为NULL, 那么它不会加密数据. 要确保客户端和服务端的保密, 应避免使用这些密码组合.</p>
<p>应用可以单独加密应用消息的内容. 这可以提供应用消息传输途中和静态数据的私密性. 但不能给应用消息的其它属性如主题名加密.</p>
<p>客户端和服务端实现可以加密存储静态数据, 例如可以将应用消息作为会话的一部分存储.</p>
<p>在客户端和服务端之间使用虚拟专用网(VPN)连接可以在VPN覆盖的网络段保证数据的私密性.</p>
<h4 id="5-4-6-消息传输的不可抵赖性-Non-repudiation-of-message-transmission"><a href="#5-4-6-消息传输的不可抵赖性-Non-repudiation-of-message-transmission" class="headerlink" title=".5.4.6 消息传输的不可抵赖性 Non-repudiation of message transmission"></a>.5.4.6 消息传输的不可抵赖性 Non-repudiation of message transmission</h4><p>应用设计者可能需要考虑适当的策略, 以实现端到端的不可抵赖性(non-repudiation).</p>
<h4 id="5-4-7-检测客户端和服务端的盗用-Detecting-compromise-of-Clients-and-Servers"><a href="#5-4-7-检测客户端和服务端的盗用-Detecting-compromise-of-Clients-and-Servers" class="headerlink" title="5.4.7 检测客户端和服务端的盗用 Detecting compromise of Clients and Servers"></a>5.4.7 检测客户端和服务端的盗用 Detecting compromise of Clients and Servers</h4><p>使用TLS <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC5246" target="_blank" rel="noopener">[RFC5246]</a> 的客户端和服务端实现应该能够确保, 初始化TLS <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC5246" target="_blank" rel="noopener">[RFC5246]</a> 连接时提供的SSL证书是与主机名(客户端要连接的或服务端将被连接的)关联的.</p>
<p>使用TLS <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC5246" target="_blank" rel="noopener">[RFC5246]</a> 的客户端和服务端实现, 可以选择提供检查证书吊销列表 (CRLs <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC5280" target="_blank" rel="noopener">[RFC5280]</a>) 和在线证书状态协议 (OSCP) <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC6960" target="_blank" rel="noopener">[RFC6960]</a> 的功能, 拒绝使用被吊销的证书.</p>
<p>物理部署可以将防篡改硬件与应用消息的特殊数据传输结合. 例如, 一个仪表可能会内置一个GPS以确保没有在未授权的地区使用. IEEE安全设备认证 <a href="https://www.zybuluo.com/khan-lau/note/1326839#IEEE8021AR" target="_blank" rel="noopener">[IEEE 802.1AR]</a> 就是用于实现这个机制的一个标准, 它使用加密绑定标识符验证设备身份.</p>
<h4 id="5-4-8-检测异常行为-Detecting-abnormal-behaviors"><a href="#5-4-8-检测异常行为-Detecting-abnormal-behaviors" class="headerlink" title="5.4.8 检测异常行为 Detecting abnormal behaviors"></a>5.4.8 检测异常行为 Detecting abnormal behaviors</h4><p>服务端实现可以监视客户端的行为, 检测潜在的安全风险. 例如：</p>
<ul>
<li>重复的连接请求</li>
<li>重复的身份验证请求</li>
<li>连接的异常终止</li>
<li>主题扫描(请求发送或订阅大量主题)</li>
<li>发送无法送达的消息(没有订阅者的主题)</li>
<li>客户端连接但是不发送数据</li>
</ul>
<p>发现违反安全规则的行为, 服务端实现可以断开客户端连接.</p>
<p>服务端实现检测不受欢迎的行为, 可以基于IP地址或客户端标识符实现一个动态黑名单列表.</p>
<p>服务部署可以使用网络层次控制(如果可用)实现基于IP地址或其它信息的速率限制或黑名单.</p>
<h4 id="5-4-9-其它的安全注意事项-Other-security-considerations"><a href="#5-4-9-其它的安全注意事项-Other-security-considerations" class="headerlink" title="5.4.9 其它的安全注意事项 Other security considerations"></a>5.4.9 其它的安全注意事项 Other security considerations</h4><p>如果客户端或服务端的SSL证书丢失, 或者我们考虑证书被盗用或者被吊销(利用 CRLs <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC5280" target="_blank" rel="noopener">[RFC5280]</a> 和 OSCP <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC6960" target="_blank" rel="noopener">[RFC6960]</a>)的情况.</p>
<p>客户端或服务端验证凭证时, 如果发现用户名和密码丢失或被盗用, 应该吊销或者重新发放.</p>
<p>在使用长连接时：</p>
<ul>
<li>客户端和服务端使用TLS <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC5246" target="_blank" rel="noopener">[RFC5246]</a> 时应该允许重新协商会话以确认新的加密参数(替换会话密钥, 更换密码组合, 更换认证凭证).</li>
<li>服务端可以断开客户端连接, 并要求他们使用新的凭证重新验证身份.</li>
</ul>
<p>受限网络上的受限设备和客户端可以使用TLS会话恢复 <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC5077" target="_blank" rel="noopener">[RFC5077]</a> 降低TLS会话重连 <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC5246" target="_blank" rel="noopener">[RFC5246]</a> 的成本.</p>
<p>连接到服务端的客户端与其它连接到服务端的客户端 之间有一个信任传递关系, 它们都有权在同一个主题上发布消息.</p>
<h4 id="5-4-10-使用SOCKS代理-Use-of-SOCKS"><a href="#5-4-10-使用SOCKS代理-Use-of-SOCKS" class="headerlink" title="5.4.10 使用SOCKS代理 Use of SOCKS"></a>5.4.10 使用SOCKS代理 Use of SOCKS</h4><p>客户端实现应该意识到某些环境要求使用SOCKSv5 <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC1928" target="_blank" rel="noopener">[RFC1928]</a> 代理创建出站的网络连接. 某些MQTT实现可以利用安全隧道(如SSH)通过SOCKS代理. 一个实现决定支持SOCKS时, 它们应该同时支持匿名的和用户名密码验证的SOCKS代理. 对于后一种情况, 实现应该意识到SOCKS可能使用明文认证, 因此应该避免使用相同的凭证连接MQTT服务器.</p>
<h4 id="5-4-11-安全配置文件-Security-profiles"><a href="#5-4-11-安全配置文件-Security-profiles" class="headerlink" title="5.4.11 安全配置文件 Security profiles"></a>5.4.11 安全配置文件 Security profiles</h4><p>实现者和方案设计者可能希望将安全当作配置文件集合应用到MQTT协议中. 下面描述的是一个分层的安全等级结构.</p>
<h5 id="开放通信配置"><a href="#开放通信配置" class="headerlink" title="开放通信配置"></a>开放通信配置</h5><p>使用开放通信配置时, MQTT协议运行在一个没有内置额外安全通信机制的开放网络上.</p>
<h5 id="安全网络通信配置"><a href="#安全网络通信配置" class="headerlink" title="安全网络通信配置"></a>安全网络通信配置</h5><p>使用安全网络通信配置时, MQTT协议运行在有安全控制的物理或虚拟网络上, 如VPN或物理安全网络.</p>
<h5 id="安全传输配置"><a href="#安全传输配置" class="headerlink" title="安全传输配置"></a>安全传输配置</h5><p>使用安全传输配置时, MQTT协议运行在使用TLS <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC5246" target="_blank" rel="noopener">[RFC5246]</a> 的物理或虚拟网络上, 它提供了身份认证, 完整性和保密性.</p>
<p>使用内置的用户名和密码字段, TLS <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC5246" target="_blank" rel="noopener">[RFC5246]</a> 客户端身份认证可被用于(或者代替)MQTT客户端认证.</p>
<h5 id="工业标准的安全配置"><a href="#工业标准的安全配置" class="headerlink" title="工业标准的安全配置"></a>工业标准的安全配置</h5><p>可以预料的是, MQTT被设计为支持很多工业标准的应用配置, 每一种定义一个威胁模型和用于定位威胁的特殊安全机制. 特殊的安全机制推荐从下面的方案中选择：</p>
<p><a href="https://www.zybuluo.com/khan-lau/note/1326839#NISTCSF" target="_blank" rel="noopener">[NISTCSF]</a> NIST网络安全框架**<br><strong>[NIST7628] NISTIR 7628智能电网网络安全指南</strong><br><strong>[FIPS1402] (FIPS PUB 140-2) 加密模块的安全要求</strong><br><strong>[PCIDSS] PCI-DSS第三方支付行业数据安全标准</strong><br>**<a href="https://www.zybuluo.com/khan-lau/note/1326839#NSAB" target="_blank" rel="noopener">[NSAB]</a> NSA加密组合B</p>
<h2 id="第六章-使用WebSocket作为网络层"><a href="#第六章-使用WebSocket作为网络层" class="headerlink" title="第六章 使用WebSocket作为网络层"></a>第六章 使用WebSocket作为网络层</h2><p>如果MQTT在WebSocket <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC6455" target="_blank" rel="noopener">[RFC6455]</a> 连接上传输, <strong>必须</strong>满足下面的条件：</p>
<ul>
<li>MQTT控制报文<strong>必须</strong>使用WebSocket二进制数据帧发送. 如果收到任何其它类型的数据帧, 接收者<strong>必须</strong>关闭网络连接 [MQTT-6.0.0-1].</li>
<li>单个WebSocket数据帧可以包含多个或者部分MQTT报文. 接收者<strong>不能</strong>假设MQTT控制报文按WebSocket帧边界对齐 [MQTT-6.0.0-2].</li>
<li>客户端<strong>必须</strong>将字符串 <strong>mqtt</strong> 包含在它提供的WebSocket子协议列表里 [MQTT-6.0.0-3].</li>
<li>服务端选择和返回的WebSocket子协议名<strong>必须</strong>是 <strong>mqtt</strong> [MQTT-6.0.0-4] .</li>
<li>用于连接客户端和服务器的WebSocket URI对MQTT协议没有任何影响.</li>
</ul>
<h3 id="6-1-IANA注意事项-IANA-Considerations"><a href="#6-1-IANA注意事项-IANA-Considerations" class="headerlink" title="6.1 IANA注意事项 IANA Considerations"></a>6.1 IANA注意事项 IANA Considerations</h3><blockquote>
<p>本规范请求IANA在WebSocket子协议名条目下注册WebSocket MQTT子协议, 使用下列数据：</p>
</blockquote>
<h6 id="图例-6-1-IANA-WebSocket标识符"><a href="#图例-6-1-IANA-WebSocket标识符" class="headerlink" title="图例 6.1 - IANA WebSocket标识符"></a>图例 6.1 - IANA WebSocket标识符</h6><table>
<thead>
<tr>
<th align="left">子协议标识符</th>
<th align="left">mqtt</th>
</tr>
</thead>
<tbody><tr>
<td align="left">子协议通用名</td>
<td align="left">mqtt</td>
</tr>
<tr>
<td align="left">子协议定义</td>
<td align="left"><a href="http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.html" target="_blank" rel="noopener">http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/mqtt-v3.1.1.html</a></td>
</tr>
</tbody></table>
<h2 id="第七章-一致性-Conformance"><a href="#第七章-一致性-Conformance" class="headerlink" title="第七章 一致性 Conformance"></a>第七章 一致性 Conformance</h2><p>MQTT规范定义了MQTT客户端实现和MQTT服务端实现的一致性要求</p>
<p>MQTT实现可以同时是MQTT客户端和MQTT服务端. 接受入站连接和建立到其它服务端的出站连接的服务端必须同时符合MQTT客户端和MQTT服务端的要求 [MQTT-7.0.0-1].</p>
<p>为了与任何其它的一致性实现交互操作, 一致性实现不能要求使用在本规范之外定义的任何扩展 [MQTT-7.0.0-2].</p>
<h3 id="7-1-一致性目标-Conformance-Targets"><a href="#7-1-一致性目标-Conformance-Targets" class="headerlink" title="7.1 一致性目标 Conformance Targets"></a>7.1 一致性目标 Conformance Targets</h3><h4 id="7-1-1-MQTT服务端-MQTT-Server"><a href="#7-1-1-MQTT服务端-MQTT-Server" class="headerlink" title="7.1.1 MQTT服务端 MQTT Server"></a>7.1.1 MQTT服务端 MQTT Server</h4><p>一个MQTT服务端只有满足下面所有的要求才算是符合本规范：</p>
<ol>
<li><p>服务端发送的所有控制报文的格式必须符合第二章和第三章描述的格式</p>
</li>
<li><p>遵守第4.7节描述的主题匹配规则.</p>
</li>
<li><p>满足下列章节中所有</p>
<p>必须</p>
<p>级别的要求, 明确仅适用于对客户端的除外：</p>
<ul>
<li>第一章 – 介绍</li>
<li>第二章 – MQTT控制报文格式</li>
<li>第三章 – MQTT控制报文</li>
<li>第四章 – 操作行为</li>
<li>第六章 –(如果MQTT的网络层是WebSocket)</li>
<li>第七章 – 一致性目标</li>
</ul>
</li>
</ol>
<p>满足一致性要求的服务端<strong>必须</strong>支持使用一个或多个底层传输协议, 只要它提供有序的、可靠的、双向字节流(从客户端到服务端和从服务端到客户端)[MQTT-7.1.1-1]. 但是一致性并不依赖于它支持任何特定的传输协议. 服务端<strong>可以</strong>支持第<a href="https://www.zybuluo.com/khan-lau/note/1326839#42-网络连接-network-connections" target="_blank" rel="noopener">4.2节</a>列出的任何传输协议, 或者任何其它满足 [MQTT-7.1.1-1] 要求的传输协议.</p>
<h4 id="7-1-2-MQTT客户端-MQTT-Client"><a href="#7-1-2-MQTT客户端-MQTT-Client" class="headerlink" title="7.1.2 MQTT客户端 MQTT Client"></a>7.1.2 MQTT客户端 MQTT Client</h4><p>一个MQTT客户端只有满足下面所有的要求才算是符合本规范：</p>
<ol>
<li><p>客户端发送的所有控制报文的格式必须符合第二章和第三章描述的格式</p>
</li>
<li><p>满足下列章节中所有</p>
<p>必须</p>
<p>级别的要求, 明确仅适用于对服务端的除外：</p>
<ul>
<li>第一章 – 介绍</li>
<li>第二章 – MQTT控制报文格式</li>
<li>第三章 – MQTT控制报文</li>
<li>第四章 – 操作行为</li>
<li>第六章 – (如果MQTT的网络层是WebSocket)</li>
<li>第七章 – 一致性目标</li>
</ul>
</li>
</ol>
<p>满足一致性要求的客户端<strong>必须</strong>支持使用一个或多个底层传输协议, 只要它提供有序的、可靠的、双向字节流(从客户端到服务端和从服务端到客户端)[MQTT-7.1.2-1]. 但是一致性并不依赖于它支持任何特定的传输协议. 客户端<strong>可以</strong>支持第<a href="https://www.zybuluo.com/khan-lau/note/1326839#42-网络连接-network-connections" target="_blank" rel="noopener">4.2节</a>列出的任何传输协议, 或者任何其它满足 [MQTT-7.1.2-1] 要求的传输协议.</p>
<h2 id="附录B-强制性规范声明-非规范"><a href="#附录B-强制性规范声明-非规范" class="headerlink" title="附录B 强制性规范声明(非规范)"></a>附录B 强制性规范声明(非规范)</h2><p>这个附录是非规范的, 只作为本文档正文中可以找到的大量一致性声明的摘要提供. 一致性要求的限制列表见第七章.</p>
<h4 id="表格：强制性规范声明"><a href="#表格：强制性规范声明" class="headerlink" title="表格：强制性规范声明"></a>表格：强制性规范声明</h4><table>
<thead>
<tr>
<th align="left"><strong>声明序号</strong></th>
<th align="left"><strong>规范声明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">[MQTT-1.5.3-1]</td>
<td align="left">UTF-8编码字符串中的字符数据<strong>必须</strong>是按照Unicode规范 <a href="https://www.zybuluo.com/khan-lau/note/1326839#Unicode" target="_blank" rel="noopener">Unicode</a>] 定义的和在RFC3629 <a href="https://www.zybuluo.com/khan-lau/note/1326839#RFC3629" target="_blank" rel="noopener">RFC3629</a>] 中重申的有效的UTF-8格式. 特别需要指出的是, 这些数据<strong>不能</strong>包含字符码在U+D800和U+DFFF之间的数据. 如果服务端或客户端收到了一个包含无效UTF-8字符的控制报文, 它<strong>必须</strong>关闭网络连接.</td>
</tr>
<tr>
<td align="left">[MQTT-1.5.3-2]</td>
<td align="left">UTF-8编码的字符串<strong>不能</strong>包含空字符U+0000. 如果客户端或服务端收到了一个包含U+0000的控制报文, 它<strong>必须</strong>关闭网络连接.</td>
</tr>
<tr>
<td align="left">[MQTT-1.5.3-3]</td>
<td align="left">UTF-8编码序列0XEF 0xBB 0xBF总是被解释为U+FEFF(零宽度非换行空白字符), 无论它出现在字符串的什么位置, 报文接收者都不能跳过或者剥离它.</td>
</tr>
<tr>
<td align="left">[MQTT-2.2.2-1]</td>
<td align="left">表格 2.2中任何标记为“保留”的标志位, 都是保留给以后使用的, <strong>必须</strong>设置为表格中列出的值.</td>
</tr>
<tr>
<td align="left">[MQTT-2.2.2-2]</td>
<td align="left">如果收到非法的标志, 接收者<strong>必须</strong>关闭网络连接.</td>
</tr>
<tr>
<td align="left">[MQTT-2.3.1-1]</td>
<td align="left">SUBSCRIBE, UNSUBSCRIBE和PUBLISH(QoS大于0)控制报文<strong>必须</strong>包含一个非零的16位报文标识符(Packet Identifier.</td>
</tr>
<tr>
<td align="left">[MQTT-2.3.1-2]</td>
<td align="left">客户端每次发送一个新的这些类型的报文时都<strong>必须</strong>分配一个当前未使用的报文标识符.</td>
</tr>
<tr>
<td align="left">[MQTT-2.3.1-3]</td>
<td align="left">如果一个客户端要重发这个特殊的控制报文, 在随后重发那个报文时, 它<strong>必须</strong>使用相同的标识符. 当客户端处理完这个报文对应的确认后, 这个报文标识符就释放可重用. QoS 1的PUBLISH对应的是PUBACK, QoS 2的PUBLISH对应的是PUBCOMP, 与SUBSCRIBE或UNSUBSCRIBE对应的分别是SUBACK或UNSUBACK</td>
</tr>
<tr>
<td align="left">[MQTT-2.3.1-4]</td>
<td align="left">发送一个QoS 0的PUBLISH报文时, 相同的条件也适用于服务端.</td>
</tr>
<tr>
<td align="left">[MQTT-2.3.1-5]</td>
<td align="left">QoS设置为0的PUBLISH报文<strong>不能</strong>包含报文标识符.</td>
</tr>
<tr>
<td align="left">[MQTT-2.3.1-6]</td>
<td align="left">PUBACK, PUBREC, PUBREL报文<strong>必须</strong>包含与最初发送的PUBLISH报文相同的报文标识符.</td>
</tr>
<tr>
<td align="left">[MQTT-2.3.1-7]</td>
<td align="left">与 [MQTT-2.3.1-6] 类似, SUBACK和UNSUBACK<strong>必须</strong>包含在对应的SUBSCRIBE和UNSUBSCRIBE报文中使用的报文标识符.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.0-1]</td>
<td align="left">客户端到服务端的网络连接建立后, 客户端发送给服务端的第一个报文<strong>必须</strong>是CONNECT报文.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.0-2]</td>
<td align="left">在一个网络连接上, 客户端只能发送一次CONNECT报文. 服务端<strong>必须</strong>将客户端发送的第二个CONNECT报文当作协议违规处理并断开客户端的连接.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-1]</td>
<td align="left">如果协议名不正确服务端<strong>可以</strong>断开客户端的连接, 也<strong>可以</strong>按照某些其它规范继续处理CONNECT报文. 对于后一种情况, 按照本规范, 服务端<strong>不能</strong>继续处理CONNECT报文.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-2]</td>
<td align="left">如果发现不支持的协议级别, 服务端<strong>必须</strong>给发送一个返回码为0x01(不支持的协议级别)的CONNACK报文响应CONNECT报文, 然后断开客户端的连接.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-3]</td>
<td align="left">服务端<strong>必须</strong>验证CONNECT控制报文的保留标志位(第0位)是否为0, 如果不为0必须断开客户端连接.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-4]</td>
<td align="left">如果清理会话(CleanSession)标志被设置为0, 服务端<strong>必须</strong>基于当前会话(使用客户端标识符识别)的状态恢复与客户端的通信. 如果没有与这个客户端标识符关联的会话, 服务端<strong>必须</strong>创建一个新的会话. 在连接断开之后, 当连接断开后, 客户端和服务端<strong>必须</strong>保存会话信息.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-5]</td>
<td align="left">当清理会话标志为0的会话连接断开之后, 服务端<strong>必须</strong>将之后的QoS 1和QoS 2级别的消息保存为会话状态的一部分, 如果这些消息匹配断开连接时客户端的任何订阅.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-6]</td>
<td align="left">如果清理会话(CleanSession)标志被设置为1, 客户端和服务端<strong>必须</strong>丢弃之前的任何会话并开始一个新的会话. 会话仅持续和网络连接同样长的时间. 与这个会话关联的状态数据<strong>不能</strong>被任何之后的会话重用.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2.7]</td>
<td align="left">保留消息不是服务端会话状态的一部分, 会话终止时<strong>不能</strong>删除保留消息.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-8]</td>
<td align="left">遗嘱标志(Will Flag)被设置为1, 表示如果连接请求被接受了, 遗嘱(Will Message)消息<strong>必须</strong>被存储在服务端并且与这个网络连接关联. 之后网络连接关闭时, 服务端<strong>必须</strong>发布这个遗嘱消息, 除非服务端收到DISCONNECT报文时删除了这个遗嘱消息.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-9]</td>
<td align="left">如果遗嘱标志被设置为1, 连接标志中的Will QoS和Will Retain字段会被服务端用到, 同时有效载荷中<strong>必须</strong>包含Will Topic和Will Message字段.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-10]</td>
<td align="left">一旦被发布或者服务端收到了客户端发送的DISCONNECT报文, 遗嘱消息就<strong>必须</strong>从存储的会话状态中移除.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-11]</td>
<td align="left">如果遗嘱标志被设置为0, 连接标志中的Will QoS和Will Retain字段<strong>必须</strong>设置为0, 并且有效载荷中<strong>不能</strong>包含Will Topic和Will Message字段.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-12]</td>
<td align="left">如果遗嘱标志被设置为0, 网络连接断开时, <strong>不能</strong>发送遗嘱消息. .</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-13]</td>
<td align="left">如果遗嘱标志被设置为0, 遗嘱QoS也<strong>必须</strong>设置为0(0x00).</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-14]</td>
<td align="left">如果遗嘱标志被设置为1, 遗嘱QoS的值可以等于0(0x00), 1(0x01), 2(0x02). 它的值<strong>不能</strong>等于3.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-15]</td>
<td align="left">如果遗嘱标志被设置为0, 遗嘱保留(Will Retain)标志也<strong>必须</strong>设置为0.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-16]</td>
<td align="left">如果遗嘱保留被设置为0, 服务端<strong>必须</strong>将遗嘱消息当作非保留消息发布.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-17]</td>
<td align="left">如果遗嘱保留被设置为1, 服务端<strong>必须</strong>将遗嘱消息当作保留消息发布.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-18]</td>
<td align="left">如果用户名(User Name)标志被设置为0, 有效载荷中<strong>不能</strong>包含用户名字段.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-19]</td>
<td align="left">如果用户名(User Name)标志被设置为1, 有效载荷中<strong>必须</strong>包含用户名字段.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-20]</td>
<td align="left">如果密码(Password)标志被设置为0, 有效载荷中<strong>不能</strong>包含密码字段.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-21]</td>
<td align="left">如果密码(Password)标志被设置为1, 有效载荷中<strong>必须</strong>包含密码字段</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-22]</td>
<td align="left">如果用户名标志被设置为0, 密码标志也<strong>必须</strong>设置为0.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-23]</td>
<td align="left">客户端负责保证控制报文发送的时间间隔不超过保持连接的值. 如果没有任何其它的控制报文可以发送, 客户端<strong>必须</strong>发送一个PINGREQ报文.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.2-24]</td>
<td align="left">如果保持连接的值非零, 并且服务端在一点五倍的保持连接时间内没有收到客户端的控制报文, 它<strong>必须</strong>断开客户端的网络连接, 认为网络连接已断开.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.3-1]</td>
<td align="left">如果包含的话, <strong>必须</strong>按这个顺序出现：客户端标识符, 遗嘱主题, 遗嘱消息, 用户名, 密码.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.3-2]</td>
<td align="left">服务端使用客户端标识符 (ClientId) 识别客户端. 连接服务端的每个客户端都有唯一的客户端标识符(ClientId). 客户端和服务端都必须使用ClientId识别两者之间的MQTT会话相关的状态.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.3-3]</td>
<td align="left">客户端标识符 (ClientId) <strong>必须</strong>存在而且<strong>必须</strong>是CONNECT报文有效载荷的第一个字段.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.3-4]</td>
<td align="left">客户端标识符<strong>必须</strong>是<a href="https://www.zybuluo.com/khan-lau/note/1326839#153-utf-8编码字符串-utf-8-encoded-strings" target="_blank" rel="noopener">1.5.3节</a>定义的UTF-8编码字符串.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.3-5]</td>
<td align="left">服务端<strong>必须</strong>允许1到23个字节长的UTF-8编码的客户端标识符, 客户端标识符只能包含这些字符：“0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ”(大写字母, 小写字母和数字).</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.3-6]</td>
<td align="left">服务端<strong>可以</strong>允许客户端提供一个零字节的客户端标识符 (ClientId) , 如果这样做了, 服务端<strong>必须</strong>将这看作特殊情况并分配唯一的客户端标识符给那个客户端. 然后它<strong>必须</strong>假设客户端提供了那个唯一的客户端标识符, 正常处理这个CONNECT报文.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.3-7]</td>
<td align="left">如果客户端提供了一个零字节的客户端标识符, 它<strong>必须</strong>同时将清理会话标志设置为1.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.3-8]</td>
<td align="left">如果客户端提供的ClientId为零字节且清理会话标志为0, 服务端<strong>必须</strong>发送返回码为0x02(表示标识符不合格)的CONNACK报文响应客户端的CONNECT报文, 然后关闭网络连接.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.3-9]</td>
<td align="left">如果服务端拒绝了这个ClientId, 它<strong>必须</strong>发送返回码为0x02(表示标识符不合格)的CONNACK报文响应客户端的CONNECT报文, 然后关闭网络连接.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.3-10]</td>
<td align="left">遗嘱主题<strong>必须</strong>是 <a href="https://www.zybuluo.com/khan-lau/note/1326839#153-utf-8编码字符串-utf-8-encoded-strings" target="_blank" rel="noopener">1.5.3节</a>定义的UTF-8编码字符串.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.3-11]</td>
<td align="left">用户名<strong>必须</strong>是 <a href="https://www.zybuluo.com/khan-lau/note/1326839#153-utf-8编码字符串-utf-8-encoded-strings" target="_blank" rel="noopener">1.5.3节</a>定义的UTF-8编码字符串.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.4-1]</td>
<td align="left">服务端<strong>必须</strong>按照3.1节的要求验证CONNECT报文, 如果报文不符合规范, 服务端不发送CONNACK报文直接关闭网络连接.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.4-2]</td>
<td align="left">如果ClientId表明客户端已经连接到这个服务端, 那么服务端<strong>必须</strong>断开原有的客户端连接.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.4-3]</td>
<td align="left">服务端<strong>必须</strong>按照 3.1.2.4节的描述执行清理会话的过程.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.4-4]</td>
<td align="left">服务端<strong>必须</strong>发送返回码为零的CONNACK报文作为CONNECT报文的确认响应.</td>
</tr>
<tr>
<td align="left">[MQTT-3.1.4-5]</td>
<td align="left">如果服务端拒绝了CONNECT, 它<strong>不能</strong>处理客户端在CONNECT报文之后发送的任何数据.</td>
</tr>
<tr>
<td align="left">[MQTT-3.2.0-1]</td>
<td align="left">服务端发送CONNACK报文响应从客户端收到的CONNECT报文. 服务端发送给客户端的第一个报文<strong>必须</strong>是CONNACK.</td>
</tr>
<tr>
<td align="left">[MQTT-3.2.2-1]</td>
<td align="left">如果服务端收到清理会话(CleanSession)标志为1的连接, 除了将CONNACK报文中的返回码设置为0之外, 还<strong>必须</strong>将CONNACK报文中的当前会话设置(Session Present)标志为0.</td>
</tr>
<tr>
<td align="left">[MQTT-3.2.2-2]</td>
<td align="left">如果服务端收到一个CleanSession为0的连接, 当前会话标志的值取决于服务端是否已经保存了ClientId对应客户端的会话状态. 如果服务端已经保存了会话状态, 它<strong>必须</strong>将CONNACK报文中的当前会话标志设置为1.</td>
</tr>
<tr>
<td align="left">[MQTT-3.2.2-3]</td>
<td align="left">如果服务端没有已保存的会话状态, 它<strong>必须</strong>将CONNACK报文中的当前会话设置为0. 还需要将CONNACK报文中的返回码设置为0.</td>
</tr>
<tr>
<td align="left">[MQTT-3.2.2-4]</td>
<td align="left">如果服务端发送了一个包含非零返回码的CONNACK报文, 它<strong>必须</strong>将当前会话标志设置为0.</td>
</tr>
<tr>
<td align="left">[MQTT-3.2.2-5]</td>
<td align="left">如果服务端发送了一个包含非零返回码的CONNACK报文, 那么它<strong>必须</strong>关闭网络连接. .</td>
</tr>
<tr>
<td align="left">[MQTT-3.2.2-6]</td>
<td align="left">如果认为上表格3.1中的所有连接返回码都不太合适, 那么服务端<strong>必须</strong>关闭网络连接, 不需要发送CONNACK报文.</td>
</tr>
<tr>
<td align="left">[MQTT-3.3.1-1]</td>
<td align="left">客户端或服务端请求重发一个PUBLISH报文时, <strong>必须</strong>将DUP标志设置为1.</td>
</tr>
<tr>
<td align="left">[MQTT-3.3.1-2]</td>
<td align="left">对于QoS 0的消息, DUP标志<strong>必须</strong>设置为0</td>
</tr>
<tr>
<td align="left">[MQTT-3.3.1-3]</td>
<td align="left">服务端发送PUBLISH报文给订阅者时, 收到(入站)的PUBLISH报文的DUP标志的值不会被传播. 发送(出站)的PUBLISH报文与收到(入站)的PUBLISH报文中的DUP标志是独立设置的, 它的值<strong>必须</strong>单独的根据发送(出站)的PUBLISH报文是否是一个重发来确定.</td>
</tr>
<tr>
<td align="left">[MQTT-3.3.1-4]</td>
<td align="left">PUBLISH报文<strong>不能</strong>将QoS所有的位设置为1. 如果服务端或客户端收到QoS所有位都为1的PUBLISH报文, 它<strong>必须</strong>关闭网络连接.</td>
</tr>
<tr>
<td align="left">[MQTT-3.3.1-5]</td>
<td align="left">如果客户端发给服务端的PUBLISH报文的保留(RETAIN)标志被设置为1, 服务端<strong>必须</strong>存储这个应用消息和它的服务质量等级(QoS), 以便它可以被分发给未来的主题名匹配的订阅者.</td>
</tr>
<tr>
<td align="left">[MQTT-3.3.1-6]</td>
<td align="left">一个新的订阅建立时, 对每个匹配的主题名, 如果存在最近保留的消息, 它<strong>必须</strong>被发送给这个订阅者.</td>
</tr>
<tr>
<td align="left">[MQTT-3.3.1-7]</td>
<td align="left">如果服务端收到一条保留(RETAIN)标志为1的QoS 0消息, 它<strong>必须</strong>丢弃之前为那个主题保留的任何消息. 它<strong>应该</strong>将这个新的QoS 0消息当作那个主题的新保留消息, 但是任何时候都<strong>可以</strong>选择丢弃它 — 如果这种情况发生了, 那个主题将没有保留消息.</td>
</tr>
<tr>
<td align="left">[MQTT-3.3.1-8]</td>
<td align="left">服务端发送PUBLISH报文给客户端时, 如果消息是作为客户端一个新订阅的结果发送, 它<strong>必须</strong>将报文的保留标志设为1.</td>
</tr>
<tr>
<td align="left">[MQTT-3.3.1-9]</td>
<td align="left">当一个PUBLISH报文发送给客户端是因为匹配一个已建立的订阅时, 服务端<strong>必须</strong>将保留标志设为0, 不管它收到的这个消息中保留标志的值是多少.</td>
</tr>
<tr>
<td align="left">[MQTT-3.3.1-10]</td>
<td align="left">保留标志为1且有效载荷为零字节的PUBLISH报文会被服务端当作正常消息处理, 它会被发送给订阅主题匹配的客户端. 此外, 同一个主题下任何现存的保留消息必须被移除, 因此这个主题之后的任何订阅者都不会收到一个保留消息.</td>
</tr>
<tr>
<td align="left">[MQTT-3.3.1-11]</td>
<td align="left">服务端<strong>不能</strong>存储零字节的保留消息.</td>
</tr>
<tr>
<td align="left">[MQTT-3.3.1-12]</td>
<td align="left">如果客户端发给服务端的PUBLISH报文的保留标志位0, 服务端<strong>不能</strong>存储这个消息也<strong>不能</strong>移除或替换任何现存的保留消息.</td>
</tr>
<tr>
<td align="left">[MQTT-3.3.2-1]</td>
<td align="left">主题名<strong>必须</strong>是PUBLISH报文可变报头的第一个字段. 它<strong>必须</strong>是 <a href="https://www.zybuluo.com/khan-lau/note/1326839#153-utf-8编码字符串-utf-8-encoded-strings" target="_blank" rel="noopener">1.5.3节</a>定义的UTF-8编码的字符串.</td>
</tr>
<tr>
<td align="left">[MQTT-3.3.2-2]</td>
<td align="left">PUBLISH报文中的主题名<strong>不能</strong>包含通配符.</td>
</tr>
<tr>
<td align="left">[MQTT-3.3.2-3]</td>
<td align="left">服务端发送给订阅客户端的PUBLISH报文的主题名<strong>必须</strong>匹配该订阅的主题过滤器(根据 4.7节定义的匹配过程).</td>
</tr>
<tr>
<td align="left">[MQTT-3.3.4-1]</td>
<td align="left">PUBLISH报文的接收者<strong>必须</strong>按照根据PUBLISH报文中的QoS等级发送响应, 见表格3.4的描述.</td>
</tr>
<tr>
<td align="left">[MQTT-3.3.5-1]</td>
<td align="left">服务端<strong>必须</strong>将消息分发给所有订阅匹配的QoS等级最高的客户端.</td>
</tr>
<tr>
<td align="left">[MQTT-3.3.5-2]</td>
<td align="left">如果服务端实现不授权某个客户端发布PUBLISH报文, 它没有办法通知那个客户端. 它<strong>必须</strong>按照正常的QoS规则发送一个正面的确认, 或者关闭网络连接.</td>
</tr>
<tr>
<td align="left">[MQTT-3.6.1-1]</td>
<td align="left">PUBREL控制报文固定报头的第3,2,1,0位是保留位, <strong>必须</strong>被设置为0,0,1,0. 服务端<strong>必须</strong>将其它的任何值都当做是不合法的并关闭网络连接.</td>
</tr>
<tr>
<td align="left">[MQTT-3.8.1-1]</td>
<td align="left">SUBSCRIBE控制报固定报头的第3,2,1,0位是保留位, <strong>必须</strong>分别设置为0,0,1,0. 服务端<strong>必须</strong>将其它的任何值都当做是不合法的并关闭网络连接.</td>
</tr>
<tr>
<td align="left">[MQTT-3.8.3-1]</td>
<td align="left">SUBSCRIBE报文有效载荷中的主题过滤器列表<strong>必须</strong>是<a href="https://www.zybuluo.com/khan-lau/note/1326839#153-utf-8编码字符串-utf-8-encoded-strings" target="_blank" rel="noopener">1.5.3节</a>定义的UTF-8字符串.</td>
</tr>
<tr>
<td align="left">[MQTT-3.8.3-2]</td>
<td align="left">如果服务端选择不支持包含通配符的主题过滤器, <strong>必须</strong>拒绝任何包含通配符过滤器的订阅请求.</td>
</tr>
<tr>
<td align="left">[MQTT-3.8.3-3]</td>
<td align="left">SUBSCRIBE报文的有效载荷<strong>必须</strong>包含至少一对主题过滤器 和 QoS等级字段组合. 没有有效载荷的SUBSCRIBE报文是违反协议的.</td>
</tr>
<tr>
<td align="left">[MQTT-3-8.3-4]</td>
<td align="left">如果有效载荷中的任何位是非零值, 或者QoS不等于0,1或2, 服务端<strong>必须</strong>认为SUBSCRIBE报文是不合法的并关闭网络连接.</td>
</tr>
<tr>
<td align="left">[MQTT-3.8.4-1]</td>
<td align="left">服务端收到客户端发送的一个SUBSCRIBE报文时, <strong>必须</strong>使用SUBACK报文响应.</td>
</tr>
<tr>
<td align="left">[MQTT-3.8.4-2]</td>
<td align="left">SUBACK报文<strong>必须</strong>和等待确认的SUBSCRIBE报文有相同的报文标识符.</td>
</tr>
<tr>
<td align="left">[MQTT-3.8.4-3]</td>
<td align="left">如果服务端收到一个SUBSCRIBE报文, 报文的主题过滤器与一个现存订阅的主题过滤器相同, 那么<strong>必须</strong>使用新的订阅彻底替换现存的订阅. 新订阅的主题过滤器和之前订阅的相同, 但是它的最大QoS值可以不同. 与这个主题过滤器匹配的任何现存的保留消息<strong>必须</strong>被重发, 但是发布流程<strong>不能</strong>中断.</td>
</tr>
<tr>
<td align="left">[MQTT-3.8.4-4]</td>
<td align="left">如果服务端收到包含多个主题过滤器的SUBSCRIBE报文, 它<strong>必须</strong>如同收到了一系列的多个SUBSCRIBE报文一样处理那个, 除了需要将它们的响应合并到一个单独的SUBACK报文发送.</td>
</tr>
<tr>
<td align="left">[MQTT-3.8.4-5]</td>
<td align="left">服务端发送给客户端的SUBACK报文对每一对主题过滤器 和QoS等级都<strong>必须</strong>包含一个返回码. 这个返回码<strong>必须</strong>表示那个订阅被授予的最大QoS等级, 或者表示这个订阅失败.</td>
</tr>
<tr>
<td align="left">[MQTT-3.8.4-6]</td>
<td align="left">服务端可以授予比订阅者要求的低一些的QoS等级. 为响应订阅而发出的消息的有效载荷的QoS<strong>必须</strong>是原始发布消息的QoS和服务端授予的QoS两者中的最小值. 如果原始消息的QoS是1而被授予的最大QoS是0, 允许服务端重复发送一个消息的副本给订阅者.</td>
</tr>
<tr>
<td align="left">[MQTT-3.9.3-1]</td>
<td align="left">返回码的顺序<strong>必须</strong>和SUBSCRIBE报文中主题过滤器的顺序相同.</td>
</tr>
<tr>
<td align="left">[MQTT-3.9.3-2]</td>
<td align="left">0x00, 0x01, 0x02, 0x80之外的SUBACK返回码是保留的, <strong>不能</strong>使用.</td>
</tr>
<tr>
<td align="left">[MQTT-3.10.1-1]</td>
<td align="left">UNSUBSCRIBE报文固定报头的第3,2,1,0位是保留位且<strong>必须</strong>分别设置为0,0,1,0. 服务端<strong>必须</strong>认为任何其它的值都是不合法的并关闭网络连接.</td>
</tr>
<tr>
<td align="left">[MQTT-3.10.3-1]</td>
<td align="left">UNSUBSCRIBE报文中的主题过滤器<strong>必须</strong>是连续打包的、按照<a href="https://www.zybuluo.com/khan-lau/note/1326839#153-utf-8编码字符串-utf-8-encoded-strings" target="_blank" rel="noopener">1.5.3节</a>定义的UTF-8编码字符串.</td>
</tr>
<tr>
<td align="left">[MQTT-3.10.3-2]</td>
<td align="left">UNSUBSCRIBE报文的有效载荷<strong>必须</strong>至少包含一个消息过滤器. 没有有效载荷的UNSUBSCRIBE报文是违反协议的.</td>
</tr>
<tr>
<td align="left">[MQTT-3.10.4-1]</td>
<td align="left">UNSUBSCRIBE报文提供的主题过滤器(无论是否包含通配符)<strong>必须</strong>与服务端持有的这个客户端的当前主题过滤器集合逐个字符比较. 如果有任何过滤器完全匹配, 那么它(服务端)自己的订阅将被删除, 否则不会有进一步的处理.</td>
</tr>
<tr>
<td align="left">[MQTT-3.10.4-2]</td>
<td align="left">如果服务端删除了一个订阅, 它<strong>必须</strong>停止分发任何新消息给这个客户端.</td>
</tr>
<tr>
<td align="left">[MQTT-3.10.4-3]</td>
<td align="left">如果服务端删除了一个订阅, 它<strong>必须</strong>完成分发任何已经开始往客户端发送的QoS 1和QoS 2的消息.</td>
</tr>
<tr>
<td align="left">[MQTT-3.10.4-4]</td>
<td align="left">服务端<strong>必须</strong>发送UNSUBACK报文响应客户端的UNSUBSCRIBE请求. UNSUBACK报文<strong>必须</strong>包含和UNSUBSCRIBE报文相同的报文标识符.</td>
</tr>
<tr>
<td align="left">[MQTT-3.10.4-5]</td>
<td align="left">即使没有删除任何主题订阅, 服务端也<strong>必须</strong>发送一个SUBACK响应.</td>
</tr>
<tr>
<td align="left">[MQTT-3.10.4-6]</td>
<td align="left">如果服务端收到包含多个主题过滤器的UNSUBSCRIBE报文, 它<strong>必须</strong>如同收到了一系列的多个UNSUBSCRIBE报文一样处理那个报文, 除了将它们的响应合并到一个单独的UNSUBACK报文外.</td>
</tr>
<tr>
<td align="left">[MQTT-3.12.4-1]</td>
<td align="left">服务端<strong>必须</strong>发送 PINGRESP报文响应客户端的PINGREQ报文.</td>
</tr>
<tr>
<td align="left">[MQTT-3.14.1-1]</td>
<td align="left">服务端<strong>必须</strong>验证所有的保留位都被设置为0, 如果它们不为0<strong>必须</strong>断开连接.</td>
</tr>
<tr>
<td align="left">[MQTT-3.14.4-1]</td>
<td align="left">客户端发送DISCONNECT报文之后, <strong>必须</strong>关闭网络连接.</td>
</tr>
<tr>
<td align="left">[MQTT-3.14.4-2]</td>
<td align="left">客户端发送DISCONNECT报文之后, <strong>不能</strong>通过那个网络连接再发送任何控制报文.</td>
</tr>
<tr>
<td align="left">[MQTT-3.14.4-3]</td>
<td align="left">服务端收到DISCONNECT报文时, <strong>必须</strong>丢弃任何与当前连接关联的未发布的遗嘱消息, 具体描述见 3.1.2.5节.</td>
</tr>
<tr>
<td align="left">[MQTT-4.1.0-1]</td>
<td align="left">在整个会话期间, 客户端和服务端都<strong>必须</strong>存储会话状态.</td>
</tr>
<tr>
<td align="left">[MQTT-4.1.0-2]</td>
<td align="left">会话<strong>必须</strong>至少持续和它的活跃网络连接同样长的时间.</td>
</tr>
<tr>
<td align="left">[MQTT-4.3.1-1]</td>
<td align="left">对于QoS 0的分发协议, 发送者<strong>必须</strong>发送QoS等于0, DUP等于0的PUBLISH报文.</td>
</tr>
<tr>
<td align="left">[MQTT-4.4.0-1]</td>
<td align="left">客户端设置清理会话(CleanSession)标志为0重连时, 客户端和服务端<strong>必须</strong>使用原始的报文标识符重发任何未确认的PUBLISH报文(如果QoS&gt;0)和PUBREL报文.</td>
</tr>
<tr>
<td align="left">[MQTT-4.5.0-1]</td>
<td align="left">服务端接管入站应用消息的所有权时, 它<strong>必须</strong>将消息添加到订阅匹配的客户端的会话状态中. 匹配规则定义见 4.7节.</td>
</tr>
<tr>
<td align="left">[MQTT-4.5.0-2]</td>
<td align="left">客户端<strong>必须</strong>按照可用的服务质量(QoS)规则确认它收到的任何PUBLISH报文, 不管它选择是否处理报文包含的应用消息.</td>
</tr>
<tr>
<td align="left">[MQTT-4.6.0-1]</td>
<td align="left">重发任何之前的PUBLISH报文时, <strong>必须</strong>按原始PUBLISH报文的发送顺序重发(适用于QoS 1和QoS 2消息).</td>
</tr>
<tr>
<td align="left">[MQTT-4.6.0-2]</td>
<td align="left"><strong>必须</strong>按照对应的PUBLISH报文的顺序发送PUBACK报文(QoS 1消息).</td>
</tr>
<tr>
<td align="left">[MQTT-4.6.0-3]</td>
<td align="left"><strong>必须</strong>按照对应的PUBLISH报文的顺序发送PUBREC报文(QoS 2消息).</td>
</tr>
<tr>
<td align="left">[MQTT-4.6.0-4]</td>
<td align="left"><strong>必须</strong>按照对应的PUBREC报文的顺序发送PUBREL报文(QoS 2消息).</td>
</tr>
<tr>
<td align="left">[MQTT-4.6.0-5]</td>
<td align="left">服务端<strong>必须</strong>默认认为每个主题都是有序的. 它<strong>可以</strong>提供一个管理功能或其它机制, 以允许将一个或多个主题当作是<strong>无序的</strong>.</td>
</tr>
<tr>
<td align="left">[MQTT-4.6.0-6]</td>
<td align="left">服务端处理发送给有序主题的消息时, <strong>必须</strong>按照上面的规则将消息分发给每个订阅者. 此外, 它<strong>必须</strong>按照从客户端收到的顺序发送PUBLISH报文给消费者(对相同的主题和QoS).</td>
</tr>
<tr>
<td align="left">[MQTT-4.7.1-1]</td>
<td align="left">主题过滤器中可以使用通配符, 但是主题名<strong>不能</strong>使用通配符.</td>
</tr>
<tr>
<td align="left">[MQTT-4.7.1-2]</td>
<td align="left">多层通配符必须位于它自己的层级或者跟在主题层级分隔符后面. 不管哪种情况, 它都<strong>必须</strong>是主题过滤器的最后一个字符.</td>
</tr>
<tr>
<td align="left">[MQTT-4.7.1-3]</td>
<td align="left">在主题过滤器的任意层级都可以使用单层通配符, 包括第一个和最后一个层级. 然而它<strong>必须</strong>占据过滤器的整个层级.</td>
</tr>
<tr>
<td align="left">[MQTT-4.7.2-1]</td>
<td align="left">服务端<strong>不能</strong>将 $ 字符开头的主题名匹配通配符 (#或+) 开头的主题过滤器.</td>
</tr>
<tr>
<td align="left">[MQTT-4.7.3-1]</td>
<td align="left">所有的主题名和主题过滤器<strong>必须</strong>至少包含一个字符.</td>
</tr>
<tr>
<td align="left">[MQTT-4.7.3-2]</td>
<td align="left">主题名和主题过滤器<strong>不能</strong>包含空字符 (Unicode U+0000) <a href="https://www.zybuluo.com/khan-lau/note/1326839#Unicode" target="_blank" rel="noopener">Unicode</a>] .</td>
</tr>
<tr>
<td align="left">[MQTT-4.7.3-3]</td>
<td align="left">主题名和主题过滤器是UTF-8编码字符串, 它们<strong>不能</strong>超过65535字节.</td>
</tr>
<tr>
<td align="left">[MQTT-4.7.3-4]</td>
<td align="left">匹配订阅时, 服务端<strong>不能</strong>对主题名或主题过滤器执行任何规范化(normalization)处理, 不能修改或替换任何未识别的字符.</td>
</tr>
<tr>
<td align="left">[MQTT-4.8.0-1]</td>
<td align="left">除非另有说明, 如果服务端或客户端遇到了协议违规的行为, 它<strong>必须</strong>关闭传输这个协议违规控制报文的网络连接.</td>
</tr>
<tr>
<td align="left">[MQTT-4.8.0-2]</td>
<td align="left">如果客户端或服务端处理入站控制报文时遇到了瞬时错误, 它<strong>必须</strong>关闭传输那个控制报文的网络连接.</td>
</tr>
<tr>
<td align="left">[MQTT-6.0.0-1]</td>
<td align="left">MQTT控制报文<strong>必须</strong>使用WebSocket二进制数据帧发送. 如果收到任何其它类型的数据帧, 接收者<strong>必须</strong>关闭网络连接.</td>
</tr>
<tr>
<td align="left">[MQTT-6.0.0-2]</td>
<td align="left">单个WebSocket数据帧可以包含多个或者部分MQTT报文. 接收者<strong>不能</strong>假设MQTT控制报文按WebSocket帧边界对齐.</td>
</tr>
<tr>
<td align="left">[MQTT-6.0.0-3]</td>
<td align="left">客户端<strong>必须</strong>将字符串 <strong>mqtt</strong> 包含在它提供的WebSocket子协议列表里.</td>
</tr>
<tr>
<td align="left">[MQTT-6.0.0-4]</td>
<td align="left">服务端选择和返回的WebSocket子协议名<strong>必须</strong>是 <strong>mqtt</strong></td>
</tr>
<tr>
<td align="left">[MQTT-7.0.0-1]</td>
<td align="left">MQTT实现可以同时是MQTT客户端和MQTT服务端. 接受入站连接和建立到其它服务端的出站连接的服务端必须同时符合MQTT客户端和MQTT服务端的要求.</td>
</tr>
<tr>
<td align="left">[MQTT-7.0.0-2]</td>
<td align="left">为了与任何其它的一致性实现交互操作, 一致性实现不能要求使用在本规范之外定义的任何扩展.</td>
</tr>
<tr>
<td align="left">[MQTT-7.1.1-1]</td>
<td align="left">满足一致性要求的服务端<strong>必须</strong>支持使用一个或多个底层传输协议, 只要它提供有序的、可靠的、双向字节流(从客户端到服务端和从服务端到客户端)</td>
</tr>
<tr>
<td align="left">[MQTT-7.1.2-1]</td>
<td align="left">满足一致性要求的客户端<strong>必须</strong>支持使用一个或多个底层传输协议, 只要它提供有序的、可靠的、双向字节流(从客户端到服务端和从服务端到客户端)</td>
</tr>
</tbody></table>
<h4 id="关于QoS的补充说明"><a href="#关于QoS的补充说明" class="headerlink" title="关于QoS的补充说明"></a>关于QoS的补充说明</h4><h5 id="MQTT-4-3-2-1-对于QoS-1的分发协议-发送者"><a href="#MQTT-4-3-2-1-对于QoS-1的分发协议-发送者" class="headerlink" title="[MQTT-4.3.2-1] 对于QoS 1的分发协议, 发送者"></a>[MQTT-4.3.2-1] 对于QoS 1的分发协议, 发送者</h5><ul>
<li>每次发送新的应用消息都<strong>必须</strong>分配一个未使用的报文标识符.</li>
<li>MUST send a PUBLISH Packet containing this Packet Identifier with QoS=1, DUP=0.</li>
<li>发送的PUBLISH报文<strong>必须</strong>包含报文标识符且QoS等于1, DUP等于0.</li>
<li><strong>必须</strong>将这个PUBLISH报文看作是 <em>未确认的</em> , 直到从接收者那收到对应的PUBACK报文. 4.4节有一个关于未确认消息的讨论.</li>
</ul>
<h5 id="MQTT-4-3-2-2-对于QoS-1的分发协议-接收者"><a href="#MQTT-4-3-2-2-对于QoS-1的分发协议-接收者" class="headerlink" title="[MQTT-4.3.2-2] 对于QoS 1的分发协议, 接收者"></a>[MQTT-4.3.2-2] 对于QoS 1的分发协议, 接收者</h5><ul>
<li>响应的PUBACK报文<strong>必须</strong>包含一个报文标识符, 这个标识符来自接收到的、已经接受所有权的PUBLISH报文.</li>
<li>发送了PUBACK报文之后, 接收者必须将任何包含相同报文标识符的入站PUBLISH报文当作一个新的消息, 并忽略它的DUP标志的值.</li>
</ul>
<h5 id="MQTT-4-3-3-1-对于QoS-2的分发协议-发送者"><a href="#MQTT-4-3-3-1-对于QoS-2的分发协议-发送者" class="headerlink" title="[MQTT-4.3.3-1] 对于QoS 2的分发协议, 发送者"></a>[MQTT-4.3.3-1] 对于QoS 2的分发协议, 发送者</h5><ul>
<li><p>必须给要发送的新应用消息分配一个未使用的报文标识符.</p>
<ul>
<li>MUST send a PUBLISH packet containing this Packet Identifier with QoS=2, DUP=0.</li>
</ul>
</li>
<li><p>发送的PUBLISH报文</p>
<p>必须</p>
<p>包含报文标识符且报文的QoS等于2,, DUP等于0.</p>
<ul>
<li><strong>必须</strong>将这个 <code>PUBLISH</code> 报文看作是 <em>未确认的</em> , 直到从接收者那收到对应的 PUBREC 报文. 4.4节有一个关于未确认消息的讨论.</li>
<li>收到PUBREC报文后<strong>必须</strong>发送一个PUBREL报文. PUBREL报文必须包含与原始 PUBLISH 报文相同的报文标识符.</li>
<li><strong>必须</strong>将这个PUBREL报文看作是 <em>未确认的</em> , 直到从接收者那收到对应的PUBCOMP报文.</li>
<li>一旦发送了对应的PUBREL报文就<strong>不能</strong>重发这个PUBLISH报文.</li>
</ul>
</li>
</ul>
<h5 id="MQTT-4-3-3-2-对于QoS-2的分发协议-接收者"><a href="#MQTT-4-3-3-2-对于QoS-2的分发协议-接收者" class="headerlink" title="[MQTT-4.3.3-2] 对于QoS 2的分发协议, 接收者"></a>[MQTT-4.3.3-2] 对于QoS 2的分发协议, 接收者</h5><ul>
<li><p>响应的PUBREC报文<strong>必须</strong>包含报文标识符, 这个标识符来自接收到的、已经接受所有权的PUBLISH报文.</p>
</li>
<li><p>在收到对应的PUBREL报文之前, 接收者<strong>必须</strong>发送PUBREC报文确认任何后续的具有相同标识符的PUBLISH报文. 在这种情况下, 它<strong>不能</strong>重复分发消息给任何后续的接收者.</p>
</li>
<li><p>响应PUBREL报文的PUBCOMP报文</p>
<p>必须</p>
<p>包含与PUBREL报文相同的标识符.</p>
<ul>
<li>发送PUBCOMP报文之后, 接收者必须将包含相同报文标识符的任何后续PUBLISH报文当作一个新的发布.</li>
</ul>
</li>
</ul>
<h4 id="项目主页"><a href="#项目主页" class="headerlink" title="项目主页"></a>项目主页</h4><ul>
<li><a href="https://github.com/mcxiaoke/mqtt" target="_blank" rel="noopener">MQTT协议中文版</a></li>
</ul>

            <hr>
          </div>
          <br>
          <div>
            
              <p>
                <i class="iconfont icon-inbox"></i>
                
                  <a class="hover-with-bg" href="/categories/Network">Network</a>
                  &nbsp;
                
              </p>
            
            <p>
              <i class="iconfont icon-tag"></i>
              
                <a class="hover-with-bg" href="/tags/MQTT">MQTT</a>
              
            </p>
            
              <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" rel="nofollow noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
            
          </div>
        </div>
      </div>
    </div>
    <div class="d-none d-lg-block col-lg-2 toc-container">
      
  <div id="toc">
    <p class="h4"><i class="far fa-list-alt"></i>&nbsp;目录</p>
    <div id="tocbot"></div>
  </div>

    </div>
  </div>
</div>

<!-- custom -->


<!-- Comments -->
<div class="col-lg-7 mx-auto nopadding-md">
  <div class="container comments mx-auto" id="comments">
    
  </div>
</div>

    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  <footer class="mt-5">
  <div class="text-center py-3">
  <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><b>© God mercy me</b></a>
    <br>
    
  </div>
</footer>

<!-- SCRIPTS -->
<script src="/lib/jquery/jquery.min.js" ></script>
<script src="/lib/popper/popper.min.js" ></script>
<script src="/lib/bootstrap/js/bootstrap.min.js" ></script>
<script src="/lib/mdbootstrap/js/mdb.min.js" ></script>
<script src="/js/main.js" ></script>

  <script src="/js/lazyload.js" ></script>


  
    <script src="/lib/tocbot/tocbot.min.js" ></script>
  
  <script src="/js/post.js" ></script>


  <script src="/lib/prettify/prettify.min.js" ></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint linenums');
      prettyPrint();
    })
  </script>


  <script src="/lib/typed/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "MQTT 协议 3.1.1&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>


  <script src="/lib/anchor/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "false",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>


</body>
</html>
